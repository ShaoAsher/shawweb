<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç½‘ç»œæµ‹é€Ÿå·¥å…·</title>
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <style>
    /* ç»§æ‰¿theme.cssçš„åŸºç¡€æ ·å¼ */
    /* ä»¥ä¸‹æ˜¯å·¥å…·é¡µé¢ç‰¹å®šçš„æ ·å¼è¦†ç›– */

    .container {
      max-width: 1200px;
    }

    .home-btn {
      position: absolute;
      top: var(--spacing-lg);
      left: var(--spacing-lg);
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-on-primary);
      text-decoration: none;
      font-size: var(--font-size-large);
      transition: all .3s;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .home-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }

    .header h1 {
      font-size: var(--font-size-xlarge);
      margin-bottom: var(--spacing-sm);
    }

    .header p {
      opacity: .9;
      font-size: var(--font-size-small);
    }

    .content {
      padding: var(--spacing-xl);
    }

    .speed-test-container {
      background: var(--color-background-alt);
      border-radius: var(--radius-md);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-lg);
      border: 1px solid var(--color-border);
    }

    .test-button {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: var(--color-text-on-primary);
      padding: var(--spacing-md) var(--spacing-xl);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
    }

    .test-button:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .test-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .test-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--spacing-lg);
      margin-top: var(--spacing-xl);
    }

    .result-card {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      border: 2px solid var(--color-border);
      box-shadow: var(--shadow-sm);
      text-align: center;
      transition: all 0.3s;
    }

    .result-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary);
    }

    .result-card.testing {
      border-color: var(--color-primary);
      box-shadow: 0 0 20px rgba(var(--color-primary-rgb), 0.3);
    }

    .result-icon {
      font-size: 48px;
      margin-bottom: var(--spacing-md);
    }

    .result-label {
      font-size: var(--font-size-small);
      color: var(--color-text-secondary);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-sm);
    }

    .result-value {
      font-size: 36px;
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      margin-bottom: var(--spacing-xs);
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .result-unit {
      font-size: var(--font-size-base);
      color: var(--color-text-secondary);
      font-weight: var(--font-weight-normal);
    }

    .result-status {
      font-size: var(--font-size-small);
      color: var(--color-text-light);
      margin-top: var(--spacing-sm);
      min-height: 20px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--color-border);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-top: var(--spacing-md);
      display: none;
    }

    .progress-bar.active {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      border-radius: var(--radius-full);
      transition: width 0.3s ease;
      width: 0%;
    }

    .summary-section {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      margin-top: var(--spacing-lg);
      border: 1px solid var(--color-border);
      display: none;
    }

    .summary-section.show {
      display: block;
    }

    .summary-title {
      font-size: var(--font-size-large);
      color: var(--color-text);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
    }

    .summary-item {
      background: var(--color-background-alt);
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
    }

    .summary-label {
      font-size: var(--font-size-small);
      color: var(--color-text-secondary);
      margin-bottom: var(--spacing-xs);
    }

    .summary-value {
      font-size: var(--font-size-base);
      color: var(--color-text);
      font-weight: var(--font-weight-semibold);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--color-text-on-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .server-info {
      background: var(--color-background-alt);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      border: 1px solid var(--color-border);
      font-size: var(--font-size-small);
      color: var(--color-text-secondary);
      text-align: center;
    }

    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      flex-wrap: wrap;
    }

    .unit-selector {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .unit-selector label {
      font-size: var(--font-size-base);
      color: var(--color-text);
      font-weight: var(--font-weight-semibold);
      white-space: nowrap;
    }

    .unit-select {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      background: var(--color-surface);
      color: var(--color-text);
      cursor: pointer;
      transition: all 0.3s;
      min-width: 180px;
    }

    .unit-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px rgba(var(--color-primary-rgb), 0.2);
    }

    .unit-select:hover {
      border-color: var(--color-primary);
    }

    @media (max-width: 768px) {
      .test-results {
        grid-template-columns: 1fr;
      }

      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }

      .unit-selector {
        width: 100%;
      }

      .unit-select {
        width: 100%;
      }

      .test-button {
        width: 100%;
      }
    }
  </style>
  <link rel="icon" href="data:,">
  <script src="../../assets/js/tools.js"></script>
  <script src="../../assets/js/themes.js"></script>
  <script src="../../assets/js/theme-ui.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <a href="../../index.html" class="home-btn">ğŸ </a>
      <h1></h1>
      <p></p>
    </div>
    <div class="content">
      <div class="speed-test-container">
        <div class="server-info" id="serverInfo">
          æ­£åœ¨é€‰æ‹©æœ€ä½³æµ‹è¯•æœåŠ¡å™¨...
        </div>

        <div class="controls-row">
          <div class="unit-selector">
            <label for="unitSelect">é€Ÿåº¦å•ä½ï¼š</label>
            <select id="unitSelect" class="unit-select">
              <option value="Mbps">Mbps (å…†æ¯”ç‰¹/ç§’)</option>
              <option value="MB/s">MB/s (å…†å­—èŠ‚/ç§’)</option>
              <option value="Kbps">Kbps (åƒæ¯”ç‰¹/ç§’)</option>
              <option value="KB/s">KB/s (åƒå­—èŠ‚/ç§’)</option>
              <option value="Gbps">Gbps (åƒå…†æ¯”ç‰¹/ç§’)</option>
            </select>
          </div>

          <button class="test-button" id="startTestBtn">
            <span>ğŸš€</span>
            <span>å¼€å§‹æµ‹é€Ÿ</span>
          </button>
        </div>

        <div class="test-results" id="testResults">
          <div class="result-card" id="pingCard">
            <div class="result-icon">ğŸ“¡</div>
            <div class="result-label">å»¶è¿Ÿ (Ping)</div>
            <div class="result-value" id="pingValue">--</div>
            <div class="result-unit">ms</div>
            <div class="result-status" id="pingStatus">ç­‰å¾…æµ‹è¯•</div>
            <div class="progress-bar" id="pingProgress">
              <div class="progress-fill" id="pingProgressFill"></div>
            </div>
          </div>

          <div class="result-card" id="downloadCard">
            <div class="result-icon">â¬‡ï¸</div>
            <div class="result-label">ä¸‹è½½é€Ÿåº¦</div>
            <div class="result-value" id="downloadValue">--</div>
            <div class="result-unit" id="downloadUnit">Mbps</div>
            <div class="result-status" id="downloadStatus">ç­‰å¾…æµ‹è¯•</div>
            <div class="progress-bar" id="downloadProgress">
              <div class="progress-fill" id="downloadProgressFill"></div>
            </div>
          </div>

          <div class="result-card" id="uploadCard">
            <div class="result-icon">â¬†ï¸</div>
            <div class="result-label">ä¸Šä¼ é€Ÿåº¦</div>
            <div class="result-value" id="uploadValue">--</div>
            <div class="result-unit" id="uploadUnit">Mbps</div>
            <div class="result-status" id="uploadStatus">ç­‰å¾…æµ‹è¯•</div>
            <div class="progress-bar" id="uploadProgress">
              <div class="progress-fill" id="uploadProgressFill"></div>
            </div>
          </div>
        </div>

        <div class="summary-section" id="summarySection">
          <div class="summary-title">
            <span>ğŸ“Š</span>
            <span>æµ‹è¯•ç»“æœæ‘˜è¦</span>
          </div>
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">å»¶è¿Ÿ</div>
              <div class="summary-value" id="summaryPing">-- ms</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">ä¸‹è½½é€Ÿåº¦</div>
              <div class="summary-value" id="summaryDownload">-- <span id="summaryDownloadUnit">Mbps</span></div>
            </div>
            <div class="summary-item">
              <div class="summary-label">ä¸Šä¼ é€Ÿåº¦</div>
              <div class="summary-value" id="summaryUpload">-- <span id="summaryUploadUnit">Mbps</span></div>
            </div>
            <div class="summary-item">
              <div class="summary-label">æµ‹è¯•æ—¶é—´</div>
              <div class="summary-value" id="summaryTime">--</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // æµ‹é€ŸæœåŠ¡å™¨åˆ—è¡¨
    // æ³¨æ„ï¼šä¸‹è½½å’Œä¸Šä¼ æµ‹è¯•ç»Ÿä¸€ä½¿ç”¨ Cloudflare çš„æµ‹é€ŸæœåŠ¡ï¼ˆå…¨çƒèŠ‚ç‚¹ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€è¿‘èŠ‚ç‚¹ï¼‰
    // pingUrl ç”¨äºæµ‹è¯•å»¶è¿Ÿå¹¶é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨
    const testServers = [
      // ä¸­å›½å¤§é™†æœåŠ¡å™¨ï¼ˆä¼˜å…ˆï¼Œç”¨äºå»¶è¿Ÿæµ‹è¯•ï¼‰
      {
        name: 'Cloudflare (ä¸­å›½å¤§é™†èŠ‚ç‚¹)',
        region: 'CN',
        pingUrl: 'https://www.cloudflare.com',
        downloadUrl: 'https://speed.cloudflare.com/__down?bytes=',
        uploadUrl: 'https://speed.cloudflare.com/__up',
        priority: 10
      },
      {
        name: 'é˜¿é‡Œäº‘ (åŒ—äº¬)',
        region: 'CN',
        pingUrl: 'https://oss-cn-beijing.aliyuncs.com',
        downloadUrl: 'https://speed.cloudflare.com/__down?bytes=',
        uploadUrl: 'https://speed.cloudflare.com/__up',
        priority: 10
      },
      {
        name: 'é˜¿é‡Œäº‘ (ä¸Šæµ·)',
        region: 'CN',
        pingUrl: 'https://oss-cn-shanghai.aliyuncs.com',
        downloadUrl: 'https://speed.cloudflare.com/__down?bytes=',
        uploadUrl: 'https://speed.cloudflare.com/__up',
        priority: 10
      },
      {
        name: 'è…¾è®¯äº‘ (åŒ—äº¬)',
        region: 'CN',
        pingUrl: 'https://cos.ap-beijing.myqcloud.com',
        downloadUrl: 'https://speed.cloudflare.com/__down?bytes=',
        uploadUrl: 'https://speed.cloudflare.com/__up',
        priority: 10
      },
      {
        name: 'ç™¾åº¦äº‘ (åŒ—äº¬)',
        region: 'CN',
        pingUrl: 'https://bj.bcebos.com',
        downloadUrl: 'https://speed.cloudflare.com/__down?bytes=',
        uploadUrl: 'https://speed.cloudflare.com/__up',
        priority: 10
      },
      // å›½é™…æœåŠ¡å™¨
      {
        name: 'Cloudflare (å…¨çƒ)',
        region: 'US',
        pingUrl: 'https://1.1.1.1',
        downloadUrl: 'https://speed.cloudflare.com/__down?bytes=',
        uploadUrl: 'https://speed.cloudflare.com/__up',
        priority: 5
      },
      {
        name: 'Google',
        region: 'US',
        pingUrl: 'https://www.google.com',
        downloadUrl: 'https://speed.cloudflare.com/__down?bytes=',
        uploadUrl: 'https://speed.cloudflare.com/__up',
        priority: 5
      }
    ];

    let currentServer = null;
    let testStartTime = null;
    let userCountryCode = null;
    let speedUnit = 'Mbps';
    let rawDownloadMbps = null; // åŸå§‹ä¸‹è½½é€Ÿåº¦ï¼ˆMbpsï¼‰
    let rawUploadMbps = null; // åŸå§‹ä¸Šä¼ é€Ÿåº¦ï¼ˆMbpsï¼‰

    // å•ä½è½¬æ¢å‡½æ•°ï¼šå°† Mbps è½¬æ¢ä¸ºæŒ‡å®šå•ä½
    function convertSpeed(mbps, unit) {
      if (mbps === null || mbps === undefined || isNaN(mbps) || mbps === '--' || mbps === 'é”™è¯¯') {
        return '--';
      }

      const value = parseFloat(mbps);
      if (isNaN(value)) return '--';

      switch (unit) {
        case 'Mbps':
          return value.toFixed(2);
        case 'MB/s':
          return (value / 8).toFixed(2);
        case 'Kbps':
          return (value * 1000).toFixed(2);
        case 'KB/s':
          return (value * 1000 / 8).toFixed(2);
        case 'Gbps':
          return (value / 1000).toFixed(3);
        default:
          return value.toFixed(2);
      }
    }

    // æ›´æ–°é€Ÿåº¦æ˜¾ç¤º
    function updateSpeedDisplay() {
      const downloadUnitEl = document.getElementById('downloadUnit');
      const uploadUnitEl = document.getElementById('uploadUnit');
      const summaryDownloadUnitEl = document.getElementById('summaryDownloadUnit');
      const summaryUploadUnitEl = document.getElementById('summaryUploadUnit');

      if (downloadUnitEl) downloadUnitEl.textContent = speedUnit;
      if (uploadUnitEl) uploadUnitEl.textContent = speedUnit;
      if (summaryDownloadUnitEl) summaryDownloadUnitEl.textContent = speedUnit;
      if (summaryUploadUnitEl) summaryUploadUnitEl.textContent = speedUnit;

      // æ›´æ–°æ˜¾ç¤ºçš„å€¼
      if (rawDownloadMbps !== null) {
        const downloadValueEl = document.getElementById('downloadValue');
        if (downloadValueEl) {
          downloadValueEl.textContent = convertSpeed(rawDownloadMbps, speedUnit);
        }
      }

      if (rawUploadMbps !== null) {
        const uploadValueEl = document.getElementById('uploadValue');
        if (uploadValueEl) {
          uploadValueEl.textContent = convertSpeed(rawUploadMbps, speedUnit);
        }
      }

      // æ›´æ–°æ‘˜è¦ï¼ˆå¦‚æœæœ‰åŸå§‹å€¼ï¼‰
      const summaryDownloadEl = document.getElementById('summaryDownload');
      const summaryUploadEl = document.getElementById('summaryUpload');
      if (summaryDownloadEl && rawDownloadMbps !== null) {
        const downloadUnitEl = document.getElementById('summaryDownloadUnit');
        summaryDownloadEl.textContent = convertSpeed(rawDownloadMbps, speedUnit);
        if (downloadUnitEl) downloadUnitEl.textContent = speedUnit;
      }
      if (summaryUploadEl && rawUploadMbps !== null) {
        const uploadUnitEl = document.getElementById('summaryUploadUnit');
        summaryUploadEl.textContent = convertSpeed(rawUploadMbps, speedUnit);
        if (uploadUnitEl) uploadUnitEl.textContent = speedUnit;
      }
    }

    // è·å–ç”¨æˆ·IPå’Œåœ°ç†ä½ç½®
    async function getUserLocation() {
      try {
        const response = await fetch('https://ipinfo.io/json', {
          cache: 'no-store'
        });
        if (!response.ok) {
          throw new Error('æ— æ³•è·å–IPä¿¡æ¯');
        }
        const data = await response.json();
        userCountryCode = data.country || null;
        return userCountryCode;
      } catch (error) {
        console.log('è·å–ç”¨æˆ·ä½ç½®å¤±è´¥:', error);
        // å°è¯•å¤‡ç”¨API
        try {
          const response = await fetch('https://ipwhois.app/json/', {
            cache: 'no-store'
          });
          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              userCountryCode = data.country_code || null;
              return userCountryCode;
            }
          }
        } catch (fallbackError) {
          console.log('å¤‡ç”¨APIä¹Ÿå¤±è´¥:', fallbackError);
        }
        return null;
      }
    }

    // é€‰æ‹©æœ€ä½³æœåŠ¡å™¨ï¼ˆé€šè¿‡pingæµ‹è¯•ï¼‰
    async function selectBestServer() {
      const serverInfo = document.getElementById('serverInfo');
      serverInfo.textContent = 'æ­£åœ¨æ£€æµ‹ç”¨æˆ·ä½ç½®...';

      // è·å–ç”¨æˆ·åœ°ç†ä½ç½®
      await getUserLocation();

      serverInfo.textContent = 'æ­£åœ¨é€‰æ‹©æœ€ä½³æµ‹è¯•æœåŠ¡å™¨...';

      // æ ¹æ®ç”¨æˆ·ä½ç½®ç­›é€‰æœåŠ¡å™¨
      let candidateServers = testServers;

      // å¦‚æœç”¨æˆ·åœ¨ä¸­å›½å¤§é™†ï¼Œä¼˜å…ˆé€‰æ‹©ä¸­å›½å¤§é™†æœåŠ¡å™¨
      if (userCountryCode === 'CN') {
        const cnServers = testServers.filter(s => s.region === 'CN');
        if (cnServers.length > 0) {
          candidateServers = cnServers;
          serverInfo.textContent = 'æ£€æµ‹åˆ°ä¸­å›½å¤§é™†IPï¼Œä¼˜å…ˆé€‰æ‹©å›½å†…æœåŠ¡å™¨...';
        }
      }

      let bestServer = candidateServers[0];
      let bestPing = Infinity;
      let testedCount = 0;

      // æµ‹è¯•æ‰€æœ‰å€™é€‰æœåŠ¡å™¨çš„å»¶è¿Ÿ
      for (const server of candidateServers) {
        try {
          const startTime = performance.now();
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000); // ç¼©çŸ­è¶…æ—¶æ—¶é—´ä»¥åŠ å¿«é€‰æ‹©

          try {
            await fetch(server.pingUrl, {
              method: 'HEAD',
              mode: 'no-cors',
              cache: 'no-store',
              signal: controller.signal
            });
            clearTimeout(timeoutId);
            const ping = performance.now() - startTime;

            if (ping < bestPing) {
              bestPing = ping;
              bestServer = server;
            }
            testedCount++;
          } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name !== 'AbortError') {
              throw fetchError;
            }
          }
        } catch (error) {
          console.log(`æœåŠ¡å™¨ ${server.name} æµ‹è¯•å¤±è´¥:`, error);
        }
      }

      // å¦‚æœæ‰€æœ‰æœåŠ¡å™¨éƒ½æµ‹è¯•å¤±è´¥ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªä½œä¸ºé»˜è®¤
      if (testedCount === 0) {
        bestServer = candidateServers[0];
        serverInfo.textContent = `å·²é€‰æ‹©æµ‹è¯•æœåŠ¡å™¨: ${bestServer.name} (é»˜è®¤)`;
      } else {
        const regionInfo = userCountryCode === 'CN' ? ' (ä¸­å›½å¤§é™†)' : '';
        serverInfo.textContent = `å·²é€‰æ‹©æµ‹è¯•æœåŠ¡å™¨: ${bestServer.name}${regionInfo} (å»¶è¿Ÿ: ${Math.round(bestPing)}ms)`;
      }

      currentServer = bestServer;
      return bestServer;
    }

    // æµ‹è¯•å»¶è¿Ÿ (Ping)
    async function testPing() {
      const pingCard = document.getElementById('pingCard');
      const pingValue = document.getElementById('pingValue');
      const pingStatus = document.getElementById('pingStatus');
      const pingProgress = document.getElementById('pingProgress');
      const pingProgressFill = document.getElementById('pingProgressFill');

      pingCard.classList.add('testing');
      pingStatus.textContent = 'æµ‹è¯•ä¸­...';
      pingProgress.classList.add('active');
      pingProgressFill.style.width = '0%';

      try {
        const times = [];
        const testCount = 3;

        for (let i = 0; i < testCount; i++) {
          const startTime = performance.now();
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);

          try {
            await fetch(currentServer.pingUrl, {
              method: 'HEAD',
              mode: 'no-cors',
              cache: 'no-store',
              signal: controller.signal
            });
            clearTimeout(timeoutId);
            const ping = performance.now() - startTime;
            times.push(ping);
          } catch (fetchError) {
            clearTimeout(timeoutId);
            if (fetchError.name === 'AbortError') {
              times.push(5000); // è¶…æ—¶è§†ä¸º5000ms
            } else {
              throw fetchError;
            }
          }

          pingProgressFill.style.width = `${((i + 1) / testCount) * 100}%`;
          await new Promise(resolve => setTimeout(resolve, 200));
        }

        const avgPing = times.reduce((a, b) => a + b, 0) / times.length;
        pingValue.textContent = Math.round(avgPing);
        pingStatus.textContent = 'æµ‹è¯•å®Œæˆ';
        pingCard.classList.remove('testing');
        pingProgress.classList.remove('active');

        return avgPing;
      } catch (error) {
        pingValue.textContent = 'é”™è¯¯';
        pingStatus.textContent = 'æµ‹è¯•å¤±è´¥: ' + error.message;
        pingCard.classList.remove('testing');
        pingProgress.classList.remove('active');
        throw error;
      }
    }

    // æµ‹è¯•ä¸‹è½½é€Ÿåº¦
    async function testDownload() {
      const downloadCard = document.getElementById('downloadCard');
      const downloadValue = document.getElementById('downloadValue');
      const downloadStatus = document.getElementById('downloadStatus');
      const downloadProgress = document.getElementById('downloadProgress');
      const downloadProgressFill = document.getElementById('downloadProgressFill');

      downloadCard.classList.add('testing');
      downloadStatus.textContent = 'æµ‹è¯•ä¸­...';
      downloadProgress.classList.add('active');
      downloadProgressFill.style.width = '0%';

      try {
        // ä½¿ç”¨ä¸åŒå¤§å°çš„æ–‡ä»¶è¿›è¡Œå¤šæ¬¡æµ‹è¯•
        const testSizes = [1 * 1024 * 1024, 5 * 1024 * 1024, 10 * 1024 * 1024]; // 1MB, 5MB, 10MB
        let totalBytes = 0;
        let totalTime = 0;

        for (let i = 0; i < testSizes.length; i++) {
          const size = testSizes[i];
          const url = `${currentServer.downloadUrl}${size}`;

          const startTime = performance.now();
          const response = await fetch(url, {
            cache: 'no-store'
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const reader = response.body.getReader();
          let receivedBytes = 0;

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            receivedBytes += value.length;

            // æ›´æ–°è¿›åº¦
            const progress = ((receivedBytes / size) * 100) / testSizes.length + (i * 100 / testSizes.length);
            downloadProgressFill.style.width = `${Math.min(progress, 100)}%`;
          }

          const endTime = performance.now();
          const duration = (endTime - startTime) / 1000; // è½¬æ¢ä¸ºç§’
          totalBytes += receivedBytes;
          totalTime += duration;
        }

        // è®¡ç®—é€Ÿåº¦ (Mbps)
        const speedMbps = (totalBytes * 8) / (totalTime * 1000000); // è½¬æ¢ä¸º Mbps
        rawDownloadMbps = speedMbps;
        downloadValue.textContent = convertSpeed(speedMbps, speedUnit);
        downloadStatus.textContent = 'æµ‹è¯•å®Œæˆ';
        downloadCard.classList.remove('testing');
        downloadProgress.classList.remove('active');
        downloadProgressFill.style.width = '100%';

        return speedMbps;
      } catch (error) {
        downloadValue.textContent = 'é”™è¯¯';
        downloadStatus.textContent = 'æµ‹è¯•å¤±è´¥: ' + error.message;
        downloadCard.classList.remove('testing');
        downloadProgress.classList.remove('active');
        throw error;
      }
    }

    // æµ‹è¯•ä¸Šä¼ é€Ÿåº¦
    async function testUpload() {
      const uploadCard = document.getElementById('uploadCard');
      const uploadValue = document.getElementById('uploadValue');
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadProgressFill = document.getElementById('uploadProgressFill');

      uploadCard.classList.add('testing');
      uploadStatus.textContent = 'æµ‹è¯•ä¸­...';
      uploadProgress.classList.add('active');
      uploadProgressFill.style.width = '0%';

      try {
        // ä½¿ç”¨ Cloudflare çš„ä¸Šä¼ æµ‹è¯•ç«¯ç‚¹
        const testSizes = [1 * 1024 * 1024, 2 * 1024 * 1024]; // 1MB, 2MB
        let totalBytes = 0;
        let totalTime = 0;

        for (let i = 0; i < testSizes.length; i++) {
          const size = testSizes[i];
          const testData = new Uint8Array(size);
          // å¡«å……éšæœºæ•°æ®
          for (let j = 0; j < size; j++) {
            testData[j] = Math.floor(Math.random() * 256);
          }

          const blob = new Blob([testData]);
          const formData = new FormData();
          formData.append('file', blob, 'test.dat');

          const startTime = performance.now();

          try {
            const response = await fetch(currentServer.uploadUrl, {
              method: 'POST',
              body: formData,
              cache: 'no-store',
              mode: 'cors'
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            await response.text();
            const endTime = performance.now();
            const duration = (endTime - startTime) / 1000; // è½¬æ¢ä¸ºç§’
            totalBytes += size;
            totalTime += duration;
          } catch (uploadError) {
            // å¦‚æœä¸Šä¼ æµ‹è¯•å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆåŸºäºä¸‹è½½é€Ÿåº¦çš„ä¼°ç®—ï¼‰
            if (i === 0) {
              // å‡è®¾ä¸Šä¼ é€Ÿåº¦çº¦ä¸ºä¸‹è½½é€Ÿåº¦çš„ 1/10ï¼ˆå¸¸è§æƒ…å†µï¼‰
              const downloadSpeed = rawDownloadMbps || 10;
              const estimatedUpload = downloadSpeed * 0.1;
              rawUploadMbps = estimatedUpload;
              uploadValue.textContent = convertSpeed(estimatedUpload, speedUnit);
              uploadStatus.textContent = 'ä¼°ç®—å€¼ï¼ˆä¸Šä¼ æµ‹è¯•å—é™ï¼‰';
              uploadCard.classList.remove('testing');
              uploadProgress.classList.remove('active');
              uploadProgressFill.style.width = '100%';
              return estimatedUpload;
            }
            throw uploadError;
          }

          // æ›´æ–°è¿›åº¦
          const progress = ((i + 1) / testSizes.length) * 100;
          uploadProgressFill.style.width = `${progress}%`;
        }

        // è®¡ç®—é€Ÿåº¦ (Mbps)
        const speedMbps = (totalBytes * 8) / (totalTime * 1000000); // è½¬æ¢ä¸º Mbps
        rawUploadMbps = speedMbps;
        uploadValue.textContent = convertSpeed(speedMbps, speedUnit);
        uploadStatus.textContent = 'æµ‹è¯•å®Œæˆ';
        uploadCard.classList.remove('testing');
        uploadProgress.classList.remove('active');
        uploadProgressFill.style.width = '100%';

        return speedMbps;
      } catch (error) {
        // å¦‚æœä¸Šä¼ æµ‹è¯•å®Œå…¨å¤±è´¥ï¼Œæä¾›ä¼°ç®—å€¼
        try {
          const downloadSpeed = rawDownloadMbps || 10;
          const estimatedUpload = downloadSpeed * 0.1;
          rawUploadMbps = estimatedUpload;
          uploadValue.textContent = convertSpeed(estimatedUpload, speedUnit);
          uploadStatus.textContent = 'ä¼°ç®—å€¼ï¼ˆä¸Šä¼ æµ‹è¯•å—é™ï¼‰';
          uploadCard.classList.remove('testing');
          uploadProgress.classList.remove('active');
          uploadProgressFill.style.width = '100%';
          return estimatedUpload;
        } catch (fallbackError) {
          uploadValue.textContent = 'é”™è¯¯';
          uploadStatus.textContent = 'æµ‹è¯•å¤±è´¥: ' + error.message;
          uploadCard.classList.remove('testing');
          uploadProgress.classList.remove('active');
          throw error;
        }
      }
    }

    // è¿è¡Œå®Œæ•´æµ‹è¯•
    async function runSpeedTest() {
      const startBtn = document.getElementById('startTestBtn');
      const summarySection = document.getElementById('summarySection');

      // ç¦ç”¨æŒ‰é’®
      startBtn.disabled = true;
      startBtn.innerHTML = '<span class="spinner"></span><span>æµ‹è¯•ä¸­...</span>';

      // é‡ç½®ç»“æœ
      document.getElementById('pingValue').textContent = '--';
      document.getElementById('downloadValue').textContent = '--';
      document.getElementById('uploadValue').textContent = '--';
      rawDownloadMbps = null;
      rawUploadMbps = null;
      document.getElementById('pingStatus').textContent = 'ç­‰å¾…æµ‹è¯•';
      document.getElementById('downloadStatus').textContent = 'ç­‰å¾…æµ‹è¯•';
      document.getElementById('uploadStatus').textContent = 'ç­‰å¾…æµ‹è¯•';
      summarySection.classList.remove('show');

      testStartTime = new Date();

      try {
        // é€‰æ‹©æœåŠ¡å™¨
        await selectBestServer();

        // æµ‹è¯•å»¶è¿Ÿ
        const ping = await testPing();

        // æµ‹è¯•ä¸‹è½½é€Ÿåº¦
        const download = await testDownload();

        // æµ‹è¯•ä¸Šä¼ é€Ÿåº¦
        const upload = await testUpload();

        // æ˜¾ç¤ºæ‘˜è¦
        const testEndTime = new Date();
        const testDuration = Math.round((testEndTime - testStartTime) / 1000);

        document.getElementById('summaryPing').textContent = `${Math.round(ping)} ms`;
        const summaryDownloadEl = document.getElementById('summaryDownload');
        const summaryUploadEl = document.getElementById('summaryUpload');
        const summaryDownloadUnitEl = document.getElementById('summaryDownloadUnit');
        const summaryUploadUnitEl = document.getElementById('summaryUploadUnit');
        
        if (summaryDownloadEl && summaryDownloadUnitEl) {
          summaryDownloadEl.textContent = convertSpeed(download, speedUnit);
          summaryDownloadUnitEl.textContent = speedUnit;
        }
        if (summaryUploadEl && summaryUploadUnitEl) {
          summaryUploadEl.textContent = convertSpeed(upload, speedUnit);
          summaryUploadUnitEl.textContent = speedUnit;
        }
        document.getElementById('summaryTime').textContent = `${testDuration} ç§’`;
        summarySection.classList.add('show');
      } catch (error) {
        console.error('æµ‹è¯•å¤±è´¥:', error);
        alert('æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message);
      } finally {
        // æ¢å¤æŒ‰é’®
        startBtn.disabled = false;
        startBtn.innerHTML = '<span>ğŸš€</span><span>å¼€å§‹æµ‹é€Ÿ</span>';
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // é€‰æ‹©æœåŠ¡å™¨
      selectBestServer();

      // ç»‘å®šå¼€å§‹æµ‹è¯•æŒ‰é’®
      document.getElementById('startTestBtn').addEventListener('click', runSpeedTest);

      // ç»‘å®šå•ä½åˆ‡æ¢
      const unitSelect = document.getElementById('unitSelect');
      if (unitSelect) {
        unitSelect.addEventListener('change', (e) => {
          speedUnit = e.target.value;
          updateSpeedDisplay();
        });
      }
    });
  </script>
</body>

</html>