<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ¨çº¿ Markdown é˜…è¯»å™¨</title>
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <!-- Highlight.js for code syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
    id="hljs-style">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/html.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
  <style>
    /* ç»§æ‰¿theme.cssçš„åŸºç¡€æ ·å¼ */
    .container {
      max-width: 1400px;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
      min-height: 600px;
    }

    .home-btn {
      position: absolute;
      top: var(--spacing-lg);
      left: var(--spacing-lg);
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-on-primary);
      text-decoration: none;
      font-size: var(--font-size-large);
      transition: all .3s;
      z-index: 10;
    }

    .home-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }

    .header h1 {
      font-size: var(--font-size-xlarge);
      margin-bottom: var(--spacing-sm);
    }

    .header p {
      opacity: 0.9;
      font-size: var(--font-size-small);
    }

    .content {
      padding: var(--spacing-xl);
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* å·¥å…·æ  */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      background: var(--color-surface-alt);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      margin-bottom: var(--spacing-lg);
      flex-shrink: 0;
    }

    .toolbar.hidden {
      display: none;
    }

    .toolbar-btn {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-on-surface-alt);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--font-size-small);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      white-space: nowrap;
    }

    .toolbar-btn:hover {
      background: var(--color-hover);
      border-color: var(--color-primary);
      transform: translateY(-1px);
    }

    .toolbar-btn:active {
      transform: translateY(0);
    }

    .toolbar-btn.active {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: var(--color-text-on-primary);
      border-color: var(--color-primary);
    }

    /* ä¸Šä¼ åŒºåŸŸ */
    .upload-section {
      margin-bottom: var(--spacing-lg);
      flex-shrink: 0;
    }

    .upload-section.hidden {
      display: none;
    }

    .upload-area {
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--spacing-xxl);
      text-align: center;
      background: var(--color-surface-alt);
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }

    .upload-area:hover {
      border-color: var(--color-primary);
      background: var(--color-hover);
    }

    .upload-area.dragover {
      border-color: var(--color-primary);
      background: var(--color-primary);
      color: var(--color-text-on-primary);
      transform: scale(1.02);
    }

    .upload-area.dragover * {
      color: var(--color-text-on-primary);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: var(--spacing-md);
    }

    .upload-text {
      font-size: var(--font-size-large);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--spacing-sm);
      color: var(--color-text);
    }

    .upload-hint {
      font-size: var(--font-size-small);
      color: var(--color-text-secondary);
    }

    .file-input {
      display: none;
    }

    /* æ–‡æœ¬è¾“å…¥åŒºåŸŸ */
    .input-section {
      margin-bottom: var(--spacing-lg);
      display: none;
      flex-shrink: 0;
    }

    .input-section.active {
      display: block;
    }

    .input-section.hidden {
      display: none !important;
    }

    .input-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .section-title {
      font-size: var(--font-size-large);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
    }

    .text-input {
      width: 100%;
      min-height: 200px;
      padding: var(--spacing-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      font-family: 'Courier New', Consolas, monospace;
      font-size: var(--font-size-base);
      line-height: 1.6;
      background: var(--color-surface);
      color: var(--color-text);
      resize: vertical;
      transition: all 0.3s;
    }

    .text-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px var(--color-shadow-primary);
    }

    /* é¢„è§ˆåŒºåŸŸ - å·¦å³åˆ†æ å¸ƒå±€ */
    .preview-section {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      overflow: hidden;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: row;
    }

    /* å·¦ä¾§ç›®å½•æ  */
    .toc-sidebar {
      width: 280px;
      min-width: 280px;
      background: var(--color-surface-alt);
      border-right: 1px solid var(--color-border);
      overflow-y: auto;
      padding: var(--spacing-md);
      display: flex;
      flex-direction: column;
    }

    .toc-header {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--color-border);
    }

    .toc-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .toc-item {
      margin-bottom: var(--spacing-xs);
    }

    .toc-link {
      display: block;
      padding: var(--spacing-xs) var(--spacing-sm);
      color: var(--color-text-secondary);
      text-decoration: none;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
      font-size: var(--font-size-small);
      line-height: 1.5;
      word-break: break-word;
    }

    .toc-link:hover {
      background: var(--color-hover);
      color: var(--color-primary);
    }

    .toc-link.active {
      background: var(--color-primary);
      color: var(--color-text-on-primary);
      font-weight: var(--font-weight-semibold);
    }

    .toc-item-h1 .toc-link {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      padding-left: var(--spacing-sm);
    }

    .toc-item-h2 .toc-link {
      padding-left: var(--spacing-md);
      font-size: var(--font-size-small);
    }

    .toc-item-h3 .toc-link {
      padding-left: var(--spacing-lg);
      font-size: var(--font-size-small);
    }

    .toc-item-h4 .toc-link {
      padding-left: var(--spacing-xl);
      font-size: var(--font-size-small);
    }

    .toc-item-h5 .toc-link,
    .toc-item-h6 .toc-link {
      padding-left: var(--spacing-xxl);
      font-size: var(--font-size-small);
    }

    .toc-empty {
      text-align: center;
      color: var(--color-text-secondary);
      font-style: italic;
      padding: var(--spacing-lg);
      font-size: var(--font-size-small);
    }

    /* å³ä¾§å†…å®¹åŒº */
    .preview-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-header {
      padding: var(--spacing-md);
      background: var(--color-surface-alt);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .preview-title {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .preview-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .preview-content {
      flex: 1;
      padding: var(--spacing-xl);
      overflow-y: auto;
      background: var(--color-surface);
      color: var(--color-text);
      line-height: 1.8;
    }

    .preview-content.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-secondary);
      font-style: italic;
    }

    /* ç›®å½•é¡¹é”šç‚¹æ ·å¼ */
    .preview-content h1[id],
    .preview-content h2[id],
    .preview-content h3[id],
    .preview-content h4[id],
    .preview-content h5[id],
    .preview-content h6[id] {
      scroll-margin-top: 80px;
      position: relative;
    }

    /* å“åº”å¼ï¼šç§»åŠ¨ç«¯éšè—ç›®å½• */
    @media (max-width: 1024px) {
      .toc-sidebar {
        display: none;
      }
    }

    /* Markdown æ ·å¼ */
    .preview-content h1,
    .preview-content h2,
    .preview-content h3,
    .preview-content h4,
    .preview-content h5,
    .preview-content h6 {
      color: var(--color-text);
      margin-top: var(--spacing-xl);
      margin-bottom: var(--spacing-md);
      font-weight: var(--font-weight-bold);
    }

    .preview-content h1 {
      font-size: 2em;
      border-bottom: 2px solid var(--color-border);
      padding-bottom: var(--spacing-sm);
    }

    .preview-content h2 {
      font-size: 1.5em;
      border-bottom: 1px solid var(--color-border);
      padding-bottom: var(--spacing-xs);
    }

    .preview-content h3 {
      font-size: 1.25em;
    }

    .preview-content p {
      margin-bottom: var(--spacing-md);
      line-height: 1.8;
    }

    .preview-content ul,
    .preview-content ol {
      margin-bottom: var(--spacing-md);
      padding-left: var(--spacing-xl);
    }

    .preview-content li {
      margin-bottom: var(--spacing-xs);
    }

    .preview-content code {
      background: var(--color-surface-alt);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-family: 'Courier New', Consolas, monospace;
      font-size: 0.9em;
      color: var(--color-primary);
    }

    .preview-content pre {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      overflow-x: auto;
      margin-bottom: var(--spacing-md);
    }

    .preview-content pre code {
      background: transparent;
      padding: 0;
      color: var(--color-text);
    }

    .preview-content blockquote {
      border-left: 4px solid var(--color-primary);
      padding-left: var(--spacing-md);
      margin: var(--spacing-md) 0;
      color: var(--color-text-secondary);
      background: var(--color-surface-alt);
      padding: var(--spacing-md);
      border-radius: var(--radius-sm);
    }

    .preview-content table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: var(--spacing-md);
    }

    .preview-content table th,
    .preview-content table td {
      border: 1px solid var(--color-border);
      padding: var(--spacing-sm);
      text-align: left;
    }

    .preview-content table th {
      background: var(--color-surface-alt);
      font-weight: var(--font-weight-semibold);
    }

    .preview-content a {
      color: var(--color-primary);
      text-decoration: none;
    }

    .preview-content a:hover {
      text-decoration: underline;
    }

    .preview-content img {
      max-width: 100%;
      height: auto;
      border-radius: var(--radius-md);
      margin: var(--spacing-md) 0;
    }

    .preview-content hr {
      border: none;
      border-top: 2px solid var(--color-border);
      margin: var(--spacing-xl) 0;
    }

    /* å†å²è®°å½• */
    .history-section {
      margin-top: var(--spacing-lg);
      flex-shrink: 0;
    }

    .history-section.hidden {
      display: none !important;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
      max-height: calc(100vh - 400px);
      overflow-y: auto;
    }

    .history-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .history-group-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--color-surface-alt);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--color-primary);
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md);
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      transition: all 0.2s;
      cursor: pointer;
    }

    .history-item:hover {
      background: var(--color-hover);
      transform: translateX(4px);
      border-color: var(--color-primary);
      box-shadow: var(--shadow-sm);
    }

    .history-info {
      flex: 1;
      min-width: 0;
    }

    .history-title {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--spacing-xs);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .history-filename {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-type-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
    }

    .history-type-file {
      background: var(--color-primary);
      color: var(--color-text-on-primary);
    }

    .history-type-paste {
      background: var(--color-success);
      color: var(--color-text-on-primary);
    }

    .history-meta {
      font-size: var(--font-size-small);
      color: var(--color-text-secondary);
      display: flex;
      gap: var(--spacing-md);
    }

    .history-actions {
      display: flex;
      gap: var(--spacing-xs);
    }

    .history-btn {
      padding: var(--spacing-xs) var(--spacing-sm);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--font-size-small);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .history-btn.view {
      background: var(--color-primary);
      color: var(--color-text-on-primary);
    }

    .history-btn.delete {
      background: var(--color-error);
      color: var(--color-text-on-primary);
    }

    .history-btn:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-sm);
    }

    .empty-history {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--color-text-secondary);
      font-style: italic;
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .toolbar {
        flex-direction: column;
      }

      .toolbar-btn {
        width: 100%;
        justify-content: center;
      }

      .history-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-sm);
      }

      .history-actions {
        width: 100%;
        justify-content: flex-end;
      }
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    .preview-content::-webkit-scrollbar,
    .history-list::-webkit-scrollbar,
    .toc-sidebar::-webkit-scrollbar {
      width: 8px;
    }

    .preview-content::-webkit-scrollbar-track,
    .history-list::-webkit-scrollbar-track,
    .toc-sidebar::-webkit-scrollbar-track {
      background: var(--color-surface-alt);
    }

    .preview-content::-webkit-scrollbar-thumb,
    .history-list::-webkit-scrollbar-thumb,
    .toc-sidebar::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    .preview-content::-webkit-scrollbar-thumb:hover,
    .history-list::-webkit-scrollbar-thumb:hover,
    .toc-sidebar::-webkit-scrollbar-thumb:hover {
      background: var(--color-primary);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <a href="../../index.html" class="home-btn" title="è¿”å›é¦–é¡µ">ğŸ </a>
      <h1>ğŸ“– åœ¨çº¿ Markdown é˜…è¯»å™¨</h1>
      <p>æ”¯æŒæ–‡ä»¶ä¸Šä¼ ã€æ–‡æœ¬ç²˜è´´å’Œå†å²è®°å½•ï¼Œç²¾ç¾é¢„è§ˆä½“éªŒ</p>
    </div>
    <div class="content">
      <!-- å·¥å…·æ  -->
      <div class="toolbar">
        <button class="toolbar-btn active" data-mode="upload">
          <span>ğŸ“</span>
          <span>ä¸Šä¼ æ–‡ä»¶</span>
        </button>
        <button class="toolbar-btn" data-mode="paste">
          <span>ğŸ“‹</span>
          <span>ç²˜è´´æ–‡æœ¬</span>
        </button>
        <button class="toolbar-btn" data-mode="history">
          <span>ğŸ•’</span>
          <span>å†å²è®°å½•</span>
        </button>
      </div>

      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div class="upload-section" id="uploadSection">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">ğŸ“„</div>
          <div class="upload-text">æ‹–æ‹½ Markdown æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
          <div class="upload-hint">æ”¯æŒ .md å’Œ .markdown æ–‡ä»¶</div>
          <input type="file" id="fileInput" class="file-input" accept=".md,.markdown,text/markdown">
        </div>
      </div>

      <!-- æ–‡æœ¬è¾“å…¥åŒºåŸŸ -->
      <div class="input-section" id="inputSection">
        <div class="input-header">
          <div class="section-title">ğŸ“ è¾“å…¥ Markdown æ–‡æœ¬</div>
        </div>
        <textarea id="textInput" class="text-input"
          placeholder="åœ¨æ­¤ç²˜è´´æˆ–è¾“å…¥ Markdown æ–‡æœ¬...&#10;&#10;æç¤ºï¼šæŒ‰ Ctrl+V (Cmd+V) å¯å¿«é€Ÿç²˜è´´"></textarea>
      </div>

      <!-- é¢„è§ˆåŒºåŸŸ -->
      <div class="preview-section">
        <!-- å·¦ä¾§ç›®å½•æ  -->
        <div class="toc-sidebar">
          <div class="toc-header">ğŸ“‘ ç›®å½•</div>
          <ul class="toc-list" id="tocList">
            <li class="toc-empty">æš‚æ— ç›®å½•</li>
          </ul>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="preview-main">
          <div class="preview-header">
            <div class="preview-title">
              <span>ğŸ‘ï¸</span>
              <span>é¢„è§ˆ</span>
            </div>
            <div class="preview-actions">
              <button class="toolbar-btn" id="toggleFullscreenBtn" onclick="toggleFullscreen()" title="åˆ‡æ¢å…¨å±æ¨¡å¼">
                <span id="fullscreenIcon">â›¶</span>
                <span id="fullscreenText">å…¨å±</span>
              </button>
              <button class="toolbar-btn" onclick="copyMarkdown()" title="å¤åˆ¶ Markdown">
                <span>ğŸ“‹</span>
                <span>å¤åˆ¶</span>
              </button>
              <button class="toolbar-btn" onclick="downloadMarkdown()" title="ä¸‹è½½ Markdown">
                <span>ğŸ’¾</span>
                <span>ä¸‹è½½</span>
              </button>
              <button class="toolbar-btn" onclick="downloadHTML()" title="ä¸‹è½½ HTML">
                <span>ğŸŒ</span>
                <span>å¯¼å‡º HTML</span>
              </button>
            </div>
          </div>
          <div id="previewContent" class="preview-content empty">
            <div>é¢„è§ˆå†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
          </div>
        </div>
      </div>

      <!-- å†å²è®°å½•åŒºåŸŸ -->
      <div class="history-section" id="historySection" style="display: none;">
        <div class="history-header">
          <div class="section-title">ğŸ•’ å†å²è®°å½•</div>
          <button class="toolbar-btn" onclick="clearHistory()"
            style="background: var(--color-error); color: var(--color-text-on-primary);">
            <span>ğŸ—‘ï¸</span>
            <span>æ¸…ç©ºå†å²</span>
          </button>
        </div>
        <div class="history-list" id="historyList">
          <div class="empty-history">æš‚æ— å†å²è®°å½•</div>
        </div>
      </div>
    </div>
  </div>

  <script src="../../assets/js/themes.js"></script>
  <script src="../../assets/js/theme-ui.js"></script>
  <script>
    // é…ç½® Marked.js - è‡ªå®šä¹‰æ ‡é¢˜æ¸²æŸ“ä»¥ç”ŸæˆID
    const renderer = new marked.Renderer();

    // ç”Ÿæˆæ ‡é¢˜IDçš„å‡½æ•°ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
    function generateId(text) {
      // ç§»é™¤HTMLæ ‡ç­¾ï¼ˆå¦‚æœMarked.jså·²ç»å¤„ç†äº†çš„è¯ï¼‰
      let cleanText = text.replace(/<[^>]*>/g, '').trim();

      if (!cleanText) {
        return 'heading-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      }

      // ç”ŸæˆIDï¼šä¿ç•™ä¸­æ–‡å­—ç¬¦ã€å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦å’Œä¸‹åˆ’çº¿
      // æ³¨æ„ï¼š\w åŒ…æ‹¬å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œ\u4e00-\u9fa5 æ˜¯ä¸­æ–‡UnicodeèŒƒå›´
      let id = cleanText
        .toLowerCase()
        .replace(/[^\w\u4e00-\u9fa5\s-]/g, '') // ä¿ç•™ä¸­æ–‡å­—ç¬¦ã€å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦
        .replace(/\s+/g, '-') // ç©ºæ ¼æ›¿æ¢ä¸ºè¿å­—ç¬¦
        .replace(/-+/g, '-') // å¤šä¸ªè¿å­—ç¬¦åˆå¹¶ä¸ºä¸€ä¸ª
        .replace(/^-|-$/g, '') // ç§»é™¤é¦–å°¾çš„è¿å­—ç¬¦
        .trim();

      // å¦‚æœIDä»ç„¶ä¸ºç©ºï¼ˆæ¯”å¦‚åªæœ‰ç‰¹æ®Šå­—ç¬¦ï¼‰ï¼Œä½¿ç”¨æ–‡æœ¬çš„å‰å‡ ä¸ªå­—ç¬¦åŠ ä¸Šéšæœºæ•°
      if (!id || id.length === 0) {
        // å–å‰10ä¸ªå­—ç¬¦ï¼Œç§»é™¤æ‰€æœ‰éå­—æ¯æ•°å­—ä¸­æ–‡çš„å­—ç¬¦
        const fallback = cleanText.substring(0, 10)
          .replace(/[^\w\u4e00-\u9fa5]/g, '')
          .toLowerCase() || 'heading';
        id = fallback + '-' + Date.now().toString(36);
      }

      return id;
    }

    // è‡ªå®šä¹‰æ ‡é¢˜æ¸²æŸ“
    ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].forEach(level => {
      renderer[level] = function (text) {
        // æå–çº¯æ–‡æœ¬ï¼ˆç§»é™¤å¯èƒ½çš„HTMLæ ‡ç­¾ï¼‰
        const textContent = text.replace(/<[^>]*>/g, '').trim();
        let id = generateId(textContent);

        // ç¡®ä¿IDä¸ä¸ºç©º
        if (!id || id.trim() === '') {
          id = 'heading-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        return `<${level} id="${id}">${text}</${level}>`;
      };
    });

    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: true,
      mangle: false,
      renderer: renderer
    });

    // å…¨å±€å˜é‡
    let currentMarkdown = '';
    let history = [];
    let tocList = null;

    // DOM å…ƒç´ ï¼ˆå°†åœ¨DOMContentLoadedä¸­åˆå§‹åŒ–ï¼‰
    let uploadArea, fileInput, textInput, previewContent, uploadSection, inputSection, historySection, historyList, toolbarBtns;

    // åˆå§‹åŒ– DOM å…ƒç´ 
    function initDOMElements() {
      uploadArea = document.getElementById('uploadArea');
      fileInput = document.getElementById('fileInput');
      textInput = document.getElementById('textInput');
      previewContent = document.getElementById('previewContent');
      uploadSection = document.getElementById('uploadSection');
      inputSection = document.getElementById('inputSection');
      historySection = document.getElementById('historySection');
      historyList = document.getElementById('historyList');
      tocList = document.getElementById('tocList');
      toolbarBtns = document.querySelectorAll('.toolbar-btn[data-mode]');
    }

    // åŠ è½½å†å²è®°å½•
    function loadHistory() {
      const saved = localStorage.getItem('markdownViewerHistory');
      if (saved) {
        try {
          history = JSON.parse(saved);
          renderHistory();
        } catch (e) {
          console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
          history = [];
        }
      }
    }

    // ä¿å­˜å†å²è®°å½•
    function saveHistory() {
      try {
        // é™åˆ¶å†å²è®°å½•æ•°é‡
        if (history.length > 50) {
          history = history.slice(-50);
        }
        localStorage.setItem('markdownViewerHistory', JSON.stringify(history));
      } catch (e) {
        console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
      }
    }

    // æ·»åŠ åˆ°å†å²è®°å½•
    function addToHistory(content, fileName = null, type = 'paste') {
      const title = fileName || getMarkdownTitle(content) || 'æœªå‘½åæ–‡æ¡£';
      const item = {
        id: Date.now(),
        title: title,
        content: content,
        fileName: fileName,
        type: type, // 'file' æˆ– 'paste'
        timestamp: new Date().toISOString(),
        preview: content.substring(0, 100) + (content.length > 100 ? '...' : '')
      };

      // ç§»é™¤é‡å¤é¡¹
      history = history.filter(h => h.content !== content);
      // æ·»åŠ åˆ°å¼€å¤´
      history.unshift(item);
      saveHistory();
      renderHistory();
    }

    // ä» Markdown ä¸­æå–æ ‡é¢˜
    function getMarkdownTitle(content) {
      const lines = content.split('\n');
      for (let line of lines) {
        line = line.trim();
        if (line.startsWith('# ')) {
          return line.substring(2).trim();
        }
        if (line.startsWith('## ')) {
          return line.substring(3).trim();
        }
      }
      return null;
    }

    // æ¸²æŸ“å†å²è®°å½•ï¼ˆæŒ‰ç±»å‹åˆ†ç»„ï¼‰
    function renderHistory() {
      if (!historyList) {
        console.error('å†å²è®°å½•å®¹å™¨æœªæ‰¾åˆ°');
        return;
      }

      if (history.length === 0) {
        historyList.innerHTML = '<div class="empty-history">æš‚æ— å†å²è®°å½•</div>';
        return;
      }

      // æŒ‰ç±»å‹åˆ†ç»„
      const fileHistory = history.filter(h => (h.type || 'paste') === 'file');
      const pasteHistory = history.filter(h => (h.type || 'paste') === 'paste');

      let html = '';

      // æ–‡ä»¶å†å²
      if (fileHistory.length > 0) {
        html += `
          <div class="history-group">
            <div class="history-group-title">ğŸ“ æ–‡ä»¶å†å² (${fileHistory.length})</div>
            ${fileHistory.map(item => renderHistoryItem(item)).join('')}
          </div>
        `;
      }

      // ç²˜è´´å†å²
      if (pasteHistory.length > 0) {
        html += `
          <div class="history-group">
            <div class="history-group-title">ğŸ“‹ ç²˜è´´å†å² (${pasteHistory.length})</div>
            ${pasteHistory.map(item => renderHistoryItem(item)).join('')}
          </div>
        `;
      }

      historyList.innerHTML = html;
    }

    // æ¸²æŸ“å•ä¸ªå†å²è®°å½•é¡¹
    function renderHistoryItem(item) {
      const date = new Date(item.timestamp);
      const dateStr = date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      const size = formatFileSize(item.content.length);
      const type = item.type || 'paste';
      const typeText = type === 'file' ? 'æ–‡ä»¶' : 'ç²˜è´´';
      const typeClass = type === 'file' ? 'history-type-file' : 'history-type-paste';

      return `
        <div class="history-item" onclick="loadFromHistory(${item.id})" title="ç‚¹å‡»æŸ¥çœ‹">
          <div class="history-info">
            <div class="history-title">
              <span class="history-type-badge ${typeClass}">${typeText}</span>
              <span class="history-filename">${escapeHtml(item.title)}</span>
            </div>
            <div class="history-meta">
              <span>ğŸ“… ${dateStr}</span>
              <span>ğŸ“ ${size}</span>
            </div>
          </div>
          <div class="history-actions" onclick="event.stopPropagation()">
            <button class="history-btn delete" onclick="deleteHistory(${item.id})" title="åˆ é™¤">
              <span>ğŸ—‘ï¸</span>
            </button>
          </div>
        </div>
      `;
    }

    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // HTML è½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ä»å†å²è®°å½•åŠ è½½ï¼ˆè·³è½¬åˆ°é¢„è§ˆé¡µï¼‰
    function loadFromHistory(id) {
      const item = history.find(h => h.id === id);
      if (item) {
        // å°†å†…å®¹ä¿å­˜åˆ° sessionStorageï¼Œä»¥ä¾¿é¢„è§ˆé¡µè¯»å–
        sessionStorage.setItem('markdownContent', item.content);
        sessionStorage.setItem('markdownTitle', item.title);
        // è·³è½¬åˆ°é¢„è§ˆé¡µ
        window.location.href = 'markdown_viewer.html';
      }
    }

    // åˆ é™¤å†å²è®°å½•
    function deleteHistory(id) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ')) {
        history = history.filter(h => h.id !== id);
        saveHistory();
        renderHistory();
      }
    }

    // æ¸…ç©ºå†å²è®°å½•
    function clearHistory() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        history = [];
        saveHistory();
        renderHistory();
      }
    }

    // åˆ‡æ¢æ¨¡å¼
    function switchMode(mode) {
      if (toolbarBtns && toolbarBtns.length > 0) {
        toolbarBtns.forEach(btn => {
          if (btn.dataset.mode === mode) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      if (mode === 'upload') {
        if (uploadSection) uploadSection.style.display = 'block';
        if (inputSection) inputSection.classList.remove('active');
        if (historySection) historySection.style.display = 'none';
      } else if (mode === 'paste') {
        if (uploadSection) uploadSection.style.display = 'none';
        if (inputSection) {
          inputSection.classList.add('active');
        }
        if (historySection) historySection.style.display = 'none';
        if (textInput) {
          setTimeout(() => textInput.focus(), 100);
        }
      } else if (mode === 'history') {
        if (uploadSection) uploadSection.style.display = 'none';
        if (inputSection) inputSection.classList.remove('active');
        if (historySection) historySection.style.display = 'block';
        renderHistory();
      }
    }

    // ç”Ÿæˆç›®å½•
    function generateTOC() {
      if (!tocList || !previewContent) return;

      const headings = previewContent.querySelectorAll('h1, h2, h3, h4, h5, h6');

      if (headings.length === 0) {
        tocList.innerHTML = '<li class="toc-empty">æš‚æ— ç›®å½•</li>';
        return;
      }

      // ç”¨äºè·Ÿè¸ªå·²ä½¿ç”¨çš„IDï¼Œç¡®ä¿å”¯ä¸€æ€§
      const usedIds = new Set();
      let idCounter = 0;

      let tocHTML = '';
      headings.forEach((heading, index) => {
        let id = heading.id;
        const level = parseInt(heading.tagName.charAt(1));
        const text = heading.textContent.trim();

        // å¦‚æœIDä¸ºç©ºæˆ–æ— æ•ˆï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ID
        if (!id || id.trim() === '') {
          id = generateId(text);
          // ç¡®ä¿IDå”¯ä¸€
          while (usedIds.has(id)) {
            id = generateId(text) + '-' + (++idCounter);
          }
          // æ›´æ–°æ ‡é¢˜å…ƒç´ çš„ID
          heading.id = id;
        }

        // ç¡®ä¿IDå”¯ä¸€
        if (usedIds.has(id)) {
          id = id + '-' + (++idCounter);
          heading.id = id;
        }
        usedIds.add(id);

        const levelClass = `toc-item-h${level}`;

        tocHTML += `<li class="toc-item ${levelClass}">
          <a href="#${id}" class="toc-link" data-id="${id}">${escapeHtml(text)}</a>
        </li>`;
      });

      tocList.innerHTML = tocHTML;

      // æ·»åŠ ç›®å½•ç‚¹å‡»äº‹ä»¶
      tocList.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          let targetId = link.getAttribute('href');

          // ç§»é™¤ # å·
          if (targetId.startsWith('#')) {
            targetId = targetId.substring(1);
          }

          // éªŒè¯IDæ˜¯å¦æœ‰æ•ˆ
          if (!targetId || targetId.trim() === '') {
            console.warn('æ— æ•ˆçš„ç›®å½•é“¾æ¥ID');
            return;
          }

          // å°è¯•æŸ¥æ‰¾ç›®æ ‡å…ƒç´ 
          let targetElement = document.getElementById(targetId);

          // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•åœ¨é¢„è§ˆå†…å®¹ä¸­æŸ¥æ‰¾
          if (!targetElement && previewContent) {
            targetElement = previewContent.querySelector(`#${CSS.escape(targetId)}`);
          }

          if (targetElement && previewContent) {
            // ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•è®¡ç®—æ»šåŠ¨ä½ç½®
            const containerTop = previewContent.scrollTop;
            const containerRect = previewContent.getBoundingClientRect();
            const targetRect = targetElement.getBoundingClientRect();

            // è®¡ç®—ç›®æ ‡å…ƒç´ ç›¸å¯¹äºå®¹å™¨çš„ä½ç½®
            const relativeTop = targetRect.top - containerRect.top + containerTop;

            // ç›´æ¥è·³è½¬åˆ°ç›®æ ‡ä½ç½®ï¼ˆä¸ç•™å‡ºé¡¶éƒ¨ç©ºé—´ï¼Œç«‹å³è·³è½¬æ— åŠ¨ç”»ï¼‰
            previewContent.scrollTop = relativeTop - 20;

            // ç«‹å³æ›´æ–°æ´»è·ƒçŠ¶æ€
            updateActiveTOC(targetId);
          } else {
            console.warn('æœªæ‰¾åˆ°ç›®æ ‡å…ƒç´ :', targetId);
            // å°è¯•é‡æ–°ç”Ÿæˆç›®å½•
            setTimeout(() => {
              generateTOC();
            }, 100);
          }
        });
      });

      // ç›‘å¬æ»šåŠ¨æ›´æ–°æ´»è·ƒç›®å½•é¡¹
      setupTOCScrollListener();
    }

    // è®¾ç½®ç›®å½•æ»šåŠ¨ç›‘å¬
    let tocScrollTimeout = null;
    function setupTOCScrollListener() {
      if (!previewContent) return;

      previewContent.addEventListener('scroll', () => {
        clearTimeout(tocScrollTimeout);
        tocScrollTimeout = setTimeout(() => {
          updateActiveTOCOnScroll();
        }, 100);
      }, { passive: true });
    }

    // æ ¹æ®æ»šåŠ¨ä½ç½®æ›´æ–°æ´»è·ƒç›®å½•é¡¹
    function updateActiveTOCOnScroll() {
      if (!previewContent || !tocList) return;

      const headings = previewContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
      const scrollTop = previewContent.scrollTop;
      const offset = 100; // åç§»é‡

      let activeId = null;

      for (let i = headings.length - 1; i >= 0; i--) {
        const heading = headings[i];
        const rect = heading.getBoundingClientRect();
        const contentRect = previewContent.getBoundingClientRect();
        const relativeTop = rect.top - contentRect.top;

        if (relativeTop <= offset) {
          activeId = heading.id;
          break;
        }
      }

      if (activeId) {
        updateActiveTOC(activeId);
      }
    }

    // æ›´æ–°æ´»è·ƒçš„ç›®å½•é¡¹
    function updateActiveTOC(activeId) {
      if (!tocList) return;

      tocList.querySelectorAll('.toc-link').forEach(link => {
        if (link.getAttribute('data-id') === activeId) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }

    // å…¨å±æ¨¡å¼çŠ¶æ€
    let isFullscreen = false;

    // åˆ‡æ¢å…¨å±æ¨¡å¼
    function toggleFullscreen() {
      isFullscreen = !isFullscreen;
      const toolbar = document.querySelector('.toolbar');
      const uploadSection = document.getElementById('uploadSection');
      const inputSection = document.getElementById('inputSection');
      const historySection = document.getElementById('historySection');
      const fullscreenIcon = document.getElementById('fullscreenIcon');
      const fullscreenText = document.getElementById('fullscreenText');

      if (isFullscreen) {
        // è¿›å…¥å…¨å±æ¨¡å¼
        if (toolbar) toolbar.classList.add('hidden');
        if (uploadSection) uploadSection.classList.add('hidden');
        if (inputSection) inputSection.classList.add('hidden');
        if (historySection) historySection.classList.add('hidden');
        if (fullscreenIcon) fullscreenIcon.textContent = 'â›¶';
        if (fullscreenText) fullscreenText.textContent = 'é€€å‡ºå…¨å±';
      } else {
        // é€€å‡ºå…¨å±æ¨¡å¼
        if (toolbar) toolbar.classList.remove('hidden');
        if (uploadSection && uploadSection.style.display !== 'none') {
          uploadSection.classList.remove('hidden');
        }
        if (inputSection && inputSection.classList.contains('active')) {
          inputSection.classList.remove('hidden');
        }
        if (historySection && historySection.style.display !== 'none') {
          historySection.classList.remove('hidden');
        }
        if (fullscreenIcon) fullscreenIcon.textContent = 'â›¶';
        if (fullscreenText) fullscreenText.textContent = 'å…¨å±';
      }
    }

    // æ›´æ–°é¢„è§ˆ
    function updatePreview() {
      if (!previewContent) {
        console.error('é¢„è§ˆåŒºåŸŸæœªæ‰¾åˆ°');
        return;
      }

      if (currentMarkdown && currentMarkdown.trim()) {
        try {
          const html = marked.parse(currentMarkdown);
          previewContent.innerHTML = html;
          previewContent.classList.remove('empty');

          // é«˜äº®ä»£ç å—
          previewContent.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });

          // ç”Ÿæˆç›®å½•
          setTimeout(() => {
            generateTOC();
          }, 50);

          // è‡ªåŠ¨è¿›å…¥å…¨å±æ¨¡å¼ï¼ˆå¦‚æœæœ‰å†…å®¹ï¼‰
          if (!isFullscreen) {
            setTimeout(() => {
              toggleFullscreen();
            }, 100);
          }
        } catch (error) {
          console.error('Markdown è§£æå¤±è´¥:', error);
          previewContent.innerHTML = '<div style="color: red;">Markdown è§£æé”™è¯¯: ' + error.message + '</div>';
          if (tocList) {
            tocList.innerHTML = '<li class="toc-empty">è§£æé”™è¯¯</li>';
          }
        }
      } else {
        previewContent.innerHTML = '<div>é¢„è§ˆå†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>';
        previewContent.classList.add('empty');
        if (tocList) {
          tocList.innerHTML = '<li class="toc-empty">æš‚æ— ç›®å½•</li>';
        }
        // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œé€€å‡ºå…¨å±æ¨¡å¼
        if (isFullscreen) {
          toggleFullscreen();
        }
      }
    }

    // å¤„ç†æ–‡ä»¶
    function handleFile(file) {
      if (!file) {
        console.error('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
        alert('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶');
        return;
      }

      // æ£€æŸ¥æ–‡ä»¶æ‰©å±•åï¼Œä¸ä¾èµ– MIME ç±»å‹ï¼ˆå› ä¸ºå¾ˆå¤šæµè§ˆå™¨ä¸æ”¯æŒ markdown çš„ MIME ç±»å‹ï¼‰
      const fileName = file.name || '';
      const isValidFile = fileName.match(/\.(md|markdown|txt)$/i) ||
        (file.type && file.type.includes('markdown')) ||
        (file.type && file.type.includes('text/plain')) ||
        !file.type ||
        file.type === '';

      if (fileName && !fileName.match(/\.(md|markdown|txt)$/i) && file.type && !file.type.includes('text')) {
        alert('è¯·ä¸Šä¼  .md æˆ– .markdown æ–‡ä»¶');
        return;
      }

      console.log('æ­£åœ¨è¯»å–æ–‡ä»¶:', fileName || 'æœªå‘½åæ–‡ä»¶');

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          currentMarkdown = e.target.result;
          console.log('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå†…å®¹é•¿åº¦:', currentMarkdown.length);
          if (textInput) {
            textInput.value = currentMarkdown;
          }
          updatePreview();
          addToHistory(currentMarkdown, fileName || 'æœªå‘½åæ–‡ä»¶.md', 'file');
          switchMode('paste');
        } catch (error) {
          console.error('å¤„ç†æ–‡ä»¶å†…å®¹å¤±è´¥:', error);
          alert('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + error.message);
        }
      };
      reader.onerror = (error) => {
        console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
        alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
      };
      reader.readAsText(file, 'UTF-8');
    }

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
    function initEventListeners() {
      // å·¥å…·æ æŒ‰é’®
      toolbarBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          switchMode(btn.dataset.mode);
        });
      });

      // ä¸Šä¼ åŒºåŸŸç‚¹å‡»
      if (uploadArea) {
        uploadArea.addEventListener('click', () => {
          if (fileInput) {
            fileInput.click();
          }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove('dragover');
          const file = e.dataTransfer.files[0];
          if (file) {
            handleFile(file);
          }
        });
      }

      // æ–‡ä»¶é€‰æ‹©
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            handleFile(file);
          }
        });
      }

      // æ–‡æœ¬è¾“å…¥ç›‘å¬
      if (textInput) {
        textInput.addEventListener('input', () => {
          currentMarkdown = textInput.value;
          updatePreview();
        });

        // ç²˜è´´ç›‘å¬
        textInput.addEventListener('paste', (e) => {
          setTimeout(() => {
            currentMarkdown = textInput.value;
            if (currentMarkdown.trim()) {
              addToHistory(currentMarkdown, null, 'paste');
            }
            updatePreview();
          }, 10);
        });
      }

      // å…¨å±€ç²˜è´´å¿«æ·é”®ï¼ˆä»…åœ¨éè¾“å…¥å…ƒç´ ä¸Šä¸”å†…å®¹çœ‹èµ·æ¥åƒ Markdown æ—¶æ‰è§¦å‘ï¼‰
      document.addEventListener('paste', (e) => {
        // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†æˆ–å¯ç¼–è¾‘å…ƒç´ ä¸Šï¼Œä¸å¤„ç†
        const activeElement = document.activeElement;
        if (activeElement && (
          activeElement.tagName === 'INPUT' ||
          activeElement.tagName === 'TEXTAREA' ||
          activeElement.isContentEditable
        )) {
          return;
        }

        // å¦‚æœç„¦ç‚¹ä¸åœ¨è¾“å…¥æ¡†ï¼Œä¸”ç²˜è´´çš„å†…å®¹å¯èƒ½æ˜¯ Markdown
        if (textInput && e.clipboardData) {
          const text = e.clipboardData.getData('text/plain');
          if (text && text.trim().length > 10 && text.trim().match(/[#*\[\]`_-]/)) {
            // å¯èƒ½æ˜¯ Markdown æ–‡æœ¬ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦ç²˜è´´
            const isMarkdown = text.includes('#') || text.includes('*') || text.includes('`') ||
              text.includes('[') || text.includes(']') || text.includes('```');
            if (isMarkdown) {
              e.preventDefault();
              e.stopPropagation();
              textInput.value = text;
              currentMarkdown = text;
              addToHistory(currentMarkdown, null, 'paste');
              updatePreview();
              switchMode('paste');
              // æ˜¾ç¤ºæç¤º
              setTimeout(() => {
                if (textInput) textInput.focus();
              }, 100);
            }
          }
        }
      }, true); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿èƒ½æ‹¦æˆª
    }

    // å¤åˆ¶ Markdown
    async function copyMarkdown() {
      if (!currentMarkdown) {
        alert('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
        return;
      }
      try {
        await navigator.clipboard.writeText(currentMarkdown);
        alert('Markdown å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      } catch (err) {
        const textArea = document.createElement('textarea');
        textArea.value = currentMarkdown;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          alert('Markdown å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        } catch (e) {
          alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
        document.body.removeChild(textArea);
      }
    }

    // ä¸‹è½½ Markdown
    function downloadMarkdown() {
      if (!currentMarkdown) {
        alert('æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹');
        return;
      }
      const blob = new Blob([currentMarkdown], { type: 'text/markdown;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const title = getMarkdownTitle(currentMarkdown) || 'markdown';
      a.download = `${title}-${Date.now()}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ä¸‹è½½ HTML
    function downloadHTML() {
      if (!currentMarkdown) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹');
        return;
      }
      const html = marked.parse(currentMarkdown);

      // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥é¿å…æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„è¯­æ³•å†²çª
      const fullHtml = '<!DOCTYPE html>\n' +
        '<html lang="zh-CN">\n' +
        '<head>\n' +
        '    <meta charset="UTF-8">\n' +
        '    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
        '    <title>Markdown å¯¼å‡º</title>\n' +
        '    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">\n' +
        '    <style>\n' +
        '        body {\n' +
        '            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n' +
        '            max-width: 800px;\n' +
        '            margin: 0 auto;\n' +
        '            padding: 40px 20px;\n' +
        '            line-height: 1.8;\n' +
        '            color: #333;\n' +
        '        }\n' +
        '        pre {\n' +
        '            background: #f5f5f5;\n' +
        '            padding: 15px;\n' +
        '            border-radius: 8px;\n' +
        '            overflow-x: auto;\n' +
        '        }\n' +
        '        code {\n' +
        '            background: #f5f5f5;\n' +
        '            padding: 2px 6px;\n' +
        '            border-radius: 4px;\n' +
        '        }\n' +
        '        blockquote {\n' +
        '            border-left: 4px solid #667eea;\n' +
        '            padding-left: 20px;\n' +
        '            margin: 20px 0;\n' +
        '            color: #666;\n' +
        '            background: #f8f9fa;\n' +
        '            padding: 15px 20px;\n' +
        '        }\n' +
        '        table {\n' +
        '            width: 100%;\n' +
        '            border-collapse: collapse;\n' +
        '            margin: 20px 0;\n' +
        '        }\n' +
        '        table th, table td {\n' +
        '            border: 1px solid #ddd;\n' +
        '            padding: 8px;\n' +
        '        }\n' +
        '        table th {\n' +
        '            background: #f8f9fa;\n' +
        '        }\n' +
        '        img {\n' +
        '            max-width: 100%;\n' +
        '            height: auto;\n' +
        '        }\n' +
        '    </style>\n' +
        '</head>\n' +
        '<body>\n' +
        html + '\n' +
        '<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script>\n' +
        '<script>\n' +
        '    document.querySelectorAll("pre code").forEach(function(block) {\n' +
        '        hljs.highlightElement(block);\n' +
        '    });\n' +
        '<\/script>\n' +
        '</body>\n' +
        '</html>';

      const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const title = getMarkdownTitle(currentMarkdown) || 'markdown';
      a.download = title + '-' + Date.now() + '.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
    function init() {
      try {
        initDOMElements();

        // éªŒè¯å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
        if (!uploadArea) console.warn('ä¸Šä¼ åŒºåŸŸæœªæ‰¾åˆ°');
        if (!fileInput) console.warn('æ–‡ä»¶è¾“å…¥æœªæ‰¾åˆ°');
        if (!textInput) console.warn('æ–‡æœ¬è¾“å…¥æœªæ‰¾åˆ°');
        if (!previewContent) console.warn('é¢„è§ˆåŒºåŸŸæœªæ‰¾åˆ°');

        initEventListeners();
        loadHistory();
        updatePreview();

        console.log('Markdown é˜…è¯»å™¨åˆå§‹åŒ–å®Œæˆ');
      } catch (error) {
        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
        alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }

    // ç¡®ä¿ DOM åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      // DOM å·²ç»åŠ è½½å®Œæˆ
      init();
    }
  </script>
</body>

</html>