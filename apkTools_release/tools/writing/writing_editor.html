<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†™ä½œç¼–è¾‘å™¨</title>
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <style>
    /* ç»§æ‰¿theme.cssçš„åŸºç¡€æ ·å¼ */
    .container {
      max-width: 1600px;
    }

    .home-btn {
      position: absolute;
      top: var(--spacing-lg);
      left: var(--spacing-lg);
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-on-primary);
      text-decoration: none;
      font-size: var(--font-size-large);
      transition: all .3s;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .home-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }

    .header h1 {
      font-size: var(--font-size-xlarge);
      margin-bottom: var(--spacing-sm);
    }

    .header p {
      opacity: .9;
      font-size: var(--font-size-small);
    }

    .content {
      padding: var(--spacing-xl);
    }

    /* ä¹¦æœ¬æè´¨èƒŒæ™¯ - æ ¹æ®ä¸»é¢˜è‡ªé€‚åº” */
    body {
      background: linear-gradient(135deg, #8B6F47 0%, #A0826D 50%, #8B6F47 100%);
      background-image:
        repeating-linear-gradient(90deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.03) 2px,
          rgba(0, 0, 0, 0.03) 4px),
        repeating-linear-gradient(0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.03) 2px,
          rgba(0, 0, 0, 0.03) 4px),
        radial-gradient(circle at 20% 50%,
          rgba(139, 111, 71, 0.3) 0%,
          transparent 50%),
        radial-gradient(circle at 80% 80%,
          rgba(160, 130, 109, 0.2) 0%,
          transparent 50%);
      background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%;
      min-height: 100vh;
    }

    /* æš—è‰²ä¸»é¢˜ä¸‹çš„èƒŒæ™¯ */
    body[data-theme="dark"] {
      background: linear-gradient(135deg, #3d2e1f 0%, #4a3a2a 50%, #3d2e1f 100%);
      background-image:
        repeating-linear-gradient(90deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.1) 2px,
          rgba(0, 0, 0, 0.1) 4px),
        repeating-linear-gradient(0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, 0.1) 2px,
          rgba(0, 0, 0, 0.1) 4px),
        radial-gradient(circle at 20% 50%,
          rgba(61, 46, 31, 0.5) 0%,
          transparent 50%),
        radial-gradient(circle at 80% 80%,
          rgba(74, 58, 42, 0.4) 0%,
          transparent 50%);
    }

    .main-layout {
      display: grid;
      grid-template-columns: 300px 1fr 320px;
      gap: var(--spacing-lg);
      height: calc(100vh - 200px);
      min-height: 600px;
    }

    .sidebar {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 1px solid var(--color-border);
      backdrop-filter: blur(10px);
      overflow-y: auto;
    }

    .sidebar-section {
      margin-bottom: var(--spacing-xl);
    }

    .sidebar-section:last-child {
      margin-bottom: 0;
    }

    .sidebar-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--color-border);
    }

    .btn {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: var(--color-text-on-primary);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      width: 100%;
      justify-content: center;
      margin-bottom: var(--spacing-sm);
    }

    .btn:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--color-surface-alt);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .btn-secondary:hover {
      background: var(--color-hover);
    }

    .outline-list,
    .volume-list,
    .chapter-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .outline-item,
    .volume-item,
    .chapter-item {
      padding: var(--spacing-sm) var(--spacing-md);
      margin-bottom: var(--spacing-xs);
      background: var(--color-surface-alt);
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .outline-item:hover,
    .volume-item:hover,
    .chapter-item:hover {
      background: var(--color-hover);
      border-color: var(--color-primary);
      transform: translateX(4px);
    }

    .outline-item.active,
    .volume-item.active,
    .chapter-item.active {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: var(--color-text-on-primary);
      border-color: var(--color-primary);
    }

    .volume-item {
      padding-left: var(--spacing-xl);
      font-weight: var(--font-weight-semibold);
    }

    .chapter-item {
      padding-left: var(--spacing-xxl);
      font-size: var(--font-size-small);
    }

    .item-name {
      flex: 1;
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-medium);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .item-actions {
      display: flex;
      gap: var(--spacing-xs);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .outline-item:hover .item-actions,
    .volume-item:hover .item-actions,
    .chapter-item:hover .item-actions {
      opacity: 1;
    }

    .item-action-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 2px 6px;
      font-size: 12px;
      color: var(--color-text-secondary);
      transition: all 0.2s;
    }

    .item-action-btn:hover {
      color: var(--color-error);
      transform: scale(1.2);
    }

    .editor-area {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--spacing-xl);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 1px solid var(--color-border);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--color-border);
    }

    .editor-title-input {
      font-size: var(--font-size-xlarge);
      font-weight: var(--font-weight-bold);
      border: none;
      background: transparent;
      color: var(--color-text);
      flex: 1;
      padding: var(--spacing-sm);
      border-radius: var(--radius-sm);
    }

    .editor-title-input:focus {
      outline: 2px solid var(--color-primary);
      outline-offset: 4px;
    }

    .editor-toolbar {
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .toolbar-btn {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      color: var(--color-text);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--font-size-small);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .toolbar-btn:hover {
      background: var(--color-hover);
      border-color: var(--color-primary);
    }

    .editor-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-lg);
      background: var(--color-surface-alt);
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      font-family: 'Georgia', 'Times New Roman', serif;
      font-size: 18px;
      line-height: 1.8;
      color: var(--color-text);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .editor-content:focus {
      outline: none;
    }

    .editor-content::placeholder {
      color: var(--color-text-light);
      font-style: italic;
    }

    .editor-stats {
      display: flex;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--color-border);
      font-size: var(--font-size-small);
      color: var(--color-text-secondary);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .info-panel {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 1px solid var(--color-border);
      backdrop-filter: blur(10px);
      overflow-y: auto;
    }

    .info-section {
      margin-bottom: var(--spacing-lg);
    }

    .info-section:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-secondary);
      margin-bottom: var(--spacing-xs);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-value {
      font-size: var(--font-size-base);
      color: var(--color-text);
      font-weight: var(--font-weight-medium);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--color-border);
    }

    .modal-header {
      font-size: var(--font-size-large);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--color-text);
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: var(--font-size-xlarge);
      cursor: pointer;
      color: var(--color-text-secondary);
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--color-text);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-label {
      display: block;
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--spacing-xs);
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-family: var(--font-family);
      background: var(--color-surface);
      color: var(--color-text);
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px var(--color-shadow-primary);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .modal-actions {
      display: flex;
      gap: var(--spacing-md);
      justify-content: flex-end;
    }

    .empty-state {
      text-align: center;
      padding: var(--spacing-xxl);
      color: var(--color-text-light);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--spacing-md);
      opacity: 0.5;
    }

    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 260px 1fr 280px;
      }
    }

    @media (max-width: 968px) {
      .main-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        height: auto;
      }

      .sidebar,
      .info-panel {
        max-height: 200px;
      }
    }
  </style>
  <link rel="icon" href="data:,">
  <script src="../../assets/js/tools.js"></script>
  <script src="../../assets/js/themes.js"></script>
  <script src="../../assets/js/theme-ui.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <a href="../../index.html" class="home-btn">ğŸ </a>
      <h1></h1>
      <p></p>
    </div>
    <div class="content">
      <div class="main-layout">
        <!-- å·¦ä¾§è¾¹æ ï¼šå¤§çº²ã€å·å’Œç« èŠ‚ -->
        <div class="sidebar">
          <div class="sidebar-section">
            <div class="sidebar-title">
              <span>ğŸ“‹</span>
              <span>å¤§çº²ç®¡ç†</span>
            </div>
            <button class="btn" onclick="showAddOutlineModal()">
              <span>â•</span>
              <span>æ–°å»ºå¤§çº²</span>
            </button>
            <ul class="outline-list" id="outlineList"></ul>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-title">
              <span>ğŸ“š</span>
              <span>å·/ç« èŠ‚åˆ—è¡¨</span>
            </div>
            <button class="btn btn-secondary" onclick="showAddVolumeModal()" id="addVolumeBtn" disabled>
              <span>â•</span>
              <span>æ–°å»ºå·</span>
            </button>
            <button class="btn btn-secondary" onclick="showAddChapterModal()" id="addChapterBtn" disabled>
              <span>â•</span>
              <span>æ–°å»ºç« èŠ‚</span>
            </button>
            <ul class="volume-list" id="volumeList"></ul>
            <ul class="chapter-list" id="chapterList"></ul>
          </div>
        </div>

        <!-- ä¸­é—´ï¼šç¼–è¾‘å™¨ -->
        <div class="editor-area">
          <div class="editor-header">
            <input type="text" class="editor-title-input" id="editorTitle" placeholder="è¯·è¾“å…¥æ ‡é¢˜..." />
            <div class="editor-toolbar">
              <button class="toolbar-btn" onclick="exportContent()" title="å¯¼å‡ºå†…å®¹">
                <span>ğŸ“¥</span>
                <span>å¯¼å‡º</span>
              </button>
            </div>
          </div>
          <div class="editor-content" contenteditable="true" id="editorContent" placeholder="å¼€å§‹ä½ çš„åˆ›ä½œä¹‹æ—…..."></div>
          <div class="editor-stats">
            <div class="stat-item">
              <span>ğŸ“Š</span>
              <span>å­—æ•°: <span id="wordCount">0</span></span>
            </div>
            <div class="stat-item">
              <span>ğŸ“„</span>
              <span>æ®µè½: <span id="paragraphCount">0</span></span>
            </div>
            <div class="stat-item">
              <span>â°</span>
              <span>æœ€åä¿å­˜: <span id="lastSave">--</span></span>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šä¿¡æ¯é¢æ¿ -->
        <div class="info-panel">
          <div class="info-section">
            <div class="info-label">å½“å‰å¤§çº²</div>
            <div class="info-value" id="currentOutline">æœªé€‰æ‹©</div>
          </div>
          <div class="info-section">
            <div class="info-label">å½“å‰å·</div>
            <div class="info-value" id="currentVolume">æœªé€‰æ‹©</div>
          </div>
          <div class="info-section">
            <div class="info-label">å½“å‰ç« èŠ‚</div>
            <div class="info-value" id="currentChapter">æœªé€‰æ‹©</div>
          </div>
          <div class="info-section">
            <div class="info-label">åˆ›å»ºæ—¶é—´</div>
            <div class="info-value" id="createTime">--</div>
          </div>
          <div class="info-section">
            <div class="info-label">ä¿®æ”¹æ—¶é—´</div>
            <div class="info-value" id="modifyTime">--</div>
          </div>
          <div class="info-section">
            <div class="info-label">æ€»å­—æ•°</div>
            <div class="info-value" id="totalWords">0</div>
          </div>
          <div class="info-section">
            <div class="info-label">æ“ä½œ</div>
            <button class="btn btn-secondary" onclick="clearAllData()" style="margin-top: var(--spacing-sm);">
              <span>ğŸ—‘ï¸</span>
              <span>æ¸…ç©ºæ‰€æœ‰æ•°æ®</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ å¤§çº²æ¨¡æ€æ¡† -->
  <div class="modal" id="addOutlineModal">
    <div class="modal-content">
      <div class="modal-header">
        <span>æ–°å»ºå¤§çº²</span>
        <button class="modal-close" onclick="closeModal('addOutlineModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">å¤§çº²åç§°</label>
        <input type="text" class="form-input" id="outlineNameInput" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„å°è¯´å¤§çº²" />
      </div>
      <div class="form-group">
        <label class="form-label">å¤§çº²æè¿°</label>
        <textarea class="form-textarea" id="outlineDescInput" placeholder="ç®€è¦æè¿°è¿™ä¸ªå¤§çº²çš„å†…å®¹..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('addOutlineModal')">å–æ¶ˆ</button>
        <button class="btn" onclick="addOutline()">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ å·æ¨¡æ€æ¡† -->
  <div class="modal" id="addVolumeModal">
    <div class="modal-content">
      <div class="modal-header">
        <span>æ–°å»ºå·</span>
        <button class="modal-close" onclick="closeModal('addVolumeModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">å·åç§°</label>
        <input type="text" class="form-input" id="volumeNameInput" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€å· åˆå…¥æ±Ÿæ¹–" />
      </div>
      <div class="form-group">
        <label class="form-label">å·æè¿°</label>
        <textarea class="form-textarea" id="volumeDescInput" placeholder="ç®€è¦æè¿°è¿™ä¸ªå·çš„å†…å®¹..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('addVolumeModal')">å–æ¶ˆ</button>
        <button class="btn" onclick="addVolume()">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ ç« èŠ‚æ¨¡æ€æ¡† -->
  <div class="modal" id="addChapterModal">
    <div class="modal-content">
      <div class="modal-header">
        <span>æ–°å»ºç« èŠ‚</span>
        <button class="modal-close" onclick="closeModal('addChapterModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">ç« èŠ‚åç§°</label>
        <input type="text" class="form-input" id="chapterNameInput" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€ç«  å¼€å§‹" />
      </div>
      <div class="form-group">
        <label class="form-label">ç« èŠ‚ç®€ä»‹</label>
        <textarea class="form-textarea" id="chapterDescInput" placeholder="ç®€è¦æè¿°è¿™ä¸ªç« èŠ‚çš„å†…å®¹..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('addChapterModal')">å–æ¶ˆ</button>
        <button class="btn" onclick="addChapter()">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <script>
    // æ•°æ®å­˜å‚¨
    let outlines = [];
    let volumes = [];
    let chapters = [];
    let currentOutlineId = null;
    let currentVolumeId = null;
    let currentChapterId = null;

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      renderAll();
      setupEditor();
      setupAutoSave();
      updateThemeBackground();

      // ç›‘å¬ä¸»é¢˜å˜åŒ–
      const observer = new MutationObserver(() => {
        updateThemeBackground();
      });
      observer.observe(document.body, { attributes: true, attributeFilter: ['data-theme'] });
    });

    // æ›´æ–°ä¸»é¢˜èƒŒæ™¯
    function updateThemeBackground() {
      const isDark = document.body.getAttribute('data-theme') === 'dark' ||
        document.documentElement.classList.contains('dark') ||
        window.getComputedStyle(document.body).backgroundColor.includes('rgb(30') ||
        window.getComputedStyle(document.body).backgroundColor.includes('rgb(17');

      if (isDark) {
        document.body.setAttribute('data-theme', 'dark');
      } else {
        document.body.removeAttribute('data-theme');
      }
    }

    // åŠ è½½æ•°æ®
    function loadData() {
      const savedOutlines = localStorage.getItem('writingEditor_outlines');
      const savedVolumes = localStorage.getItem('writingEditor_volumes');
      const savedChapters = localStorage.getItem('writingEditor_chapters');
      const savedCurrentOutline = localStorage.getItem('writingEditor_currentOutline');
      const savedCurrentVolume = localStorage.getItem('writingEditor_currentVolume');
      const savedCurrentChapter = localStorage.getItem('writingEditor_currentChapter');

      if (savedOutlines) outlines = JSON.parse(savedOutlines);
      if (savedVolumes) volumes = JSON.parse(savedVolumes);
      if (savedChapters) chapters = JSON.parse(savedChapters);
      if (savedCurrentOutline) currentOutlineId = savedCurrentOutline;
      if (savedCurrentVolume) currentVolumeId = savedCurrentVolume;
      if (savedCurrentChapter) currentChapterId = savedCurrentChapter;
    }

    // ä¿å­˜æ•°æ®
    function saveData() {
      localStorage.setItem('writingEditor_outlines', JSON.stringify(outlines));
      localStorage.setItem('writingEditor_volumes', JSON.stringify(volumes));
      localStorage.setItem('writingEditor_chapters', JSON.stringify(chapters));
      localStorage.setItem('writingEditor_currentOutline', currentOutlineId);
      localStorage.setItem('writingEditor_currentVolume', currentVolumeId);
      localStorage.setItem('writingEditor_currentChapter', currentChapterId);
    }

    // æ¸²æŸ“æ‰€æœ‰åˆ—è¡¨
    function renderAll() {
      renderOutlines();
      renderVolumesAndChapters();
      updateInfoPanel();
      loadCurrentContent();
    }

    // æ¸²æŸ“å¤§çº²åˆ—è¡¨
    function renderOutlines() {
      const list = document.getElementById('outlineList');
      if (outlines.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div>æš‚æ— å¤§çº²</div></div>';
        return;
      }

      list.innerHTML = outlines.map(outline => `
        <li class="outline-item ${outline.id === currentOutlineId ? 'active' : ''}" 
            onclick="selectOutline('${outline.id}')">
          <span class="item-name" title="${outline.name}">${outline.name}</span>
          <div class="item-actions" onclick="event.stopPropagation()">
            <button class="item-action-btn" onclick="deleteOutline('${outline.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
          </div>
        </li>
      `).join('');
    }

    // æ¸²æŸ“å·å’Œç« èŠ‚åˆ—è¡¨
    function renderVolumesAndChapters() {
      const volumeList = document.getElementById('volumeList');
      const chapterList = document.getElementById('chapterList');
      const addVolumeBtn = document.getElementById('addVolumeBtn');
      const addChapterBtn = document.getElementById('addChapterBtn');

      if (!currentOutlineId) {
        addVolumeBtn.disabled = true;
        addChapterBtn.disabled = true;
        volumeList.innerHTML = '';
        chapterList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“š</div><div>è¯·å…ˆé€‰æ‹©å¤§çº²</div></div>';
        return;
      }

      addVolumeBtn.disabled = false;
      addChapterBtn.disabled = false;

      const outlineVolumes = volumes.filter(v => v.outlineId === currentOutlineId);
      const outlineChapters = chapters.filter(ch => ch.outlineId === currentOutlineId && !ch.volumeId);

      // æ¸²æŸ“å·
      if (outlineVolumes.length === 0 && outlineChapters.length === 0) {
        volumeList.innerHTML = '';
        chapterList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“š</div><div>æš‚æ— å†…å®¹</div></div>';
        return;
      }

      let html = '';

      // æ¸²æŸ“å·åŠå…¶ä¸‹çš„ç« èŠ‚
      outlineVolumes.forEach(volume => {
        html += `
          <li class="volume-item ${volume.id === currentVolumeId ? 'active' : ''}" 
              onclick="selectVolume('${volume.id}')">
            <span class="item-name" title="${volume.name}">${volume.name}</span>
            <div class="item-actions" onclick="event.stopPropagation()">
              <button class="item-action-btn" onclick="deleteVolume('${volume.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
            </div>
          </li>
        `;

        // æ¸²æŸ“è¯¥å·ä¸‹çš„ç« èŠ‚
        const volumeChapters = chapters.filter(ch => ch.volumeId === volume.id);
        volumeChapters.forEach(chapter => {
          html += `
            <li class="chapter-item ${chapter.id === currentChapterId ? 'active' : ''}" 
                onclick="selectChapter('${chapter.id}')">
              <span class="item-name" title="${chapter.name}">${chapter.name}</span>
              <div class="item-actions" onclick="event.stopPropagation()">
                <button class="item-action-btn" onclick="deleteChapter('${chapter.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
              </div>
            </li>
          `;
        });
      });

      // æ¸²æŸ“ä¸å±äºä»»ä½•å·çš„ç« èŠ‚
      outlineChapters.forEach(chapter => {
        html += `
          <li class="chapter-item ${chapter.id === currentChapterId ? 'active' : ''}" 
              onclick="selectChapter('${chapter.id}')">
            <span class="item-name" title="${chapter.name}">${chapter.name}</span>
            <div class="item-actions" onclick="event.stopPropagation()">
              <button class="item-action-btn" onclick="deleteChapter('${chapter.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
            </div>
          </li>
        `;
      });

      volumeList.innerHTML = html;
      chapterList.innerHTML = '';
    }

    // æ˜¾ç¤ºæ·»åŠ å¤§çº²æ¨¡æ€æ¡†
    function showAddOutlineModal() {
      document.getElementById('addOutlineModal').classList.add('show');
      document.getElementById('outlineNameInput').value = '';
      document.getElementById('outlineDescInput').value = '';
      document.getElementById('outlineNameInput').focus();
    }

    // æ˜¾ç¤ºæ·»åŠ å·æ¨¡æ€æ¡†
    function showAddVolumeModal() {
      if (!currentOutlineId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¤§çº²');
        return;
      }
      document.getElementById('addVolumeModal').classList.add('show');
      document.getElementById('volumeNameInput').value = '';
      document.getElementById('volumeDescInput').value = '';
      document.getElementById('volumeNameInput').focus();
    }

    // æ˜¾ç¤ºæ·»åŠ ç« èŠ‚æ¨¡æ€æ¡†
    function showAddChapterModal() {
      if (!currentOutlineId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¤§çº²');
        return;
      }
      document.getElementById('addChapterModal').classList.add('show');
      document.getElementById('chapterNameInput').value = '';
      document.getElementById('chapterDescInput').value = '';
      document.getElementById('chapterNameInput').focus();
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // æ·»åŠ å¤§çº²
    function addOutline() {
      const name = document.getElementById('outlineNameInput').value.trim();
      const desc = document.getElementById('outlineDescInput').value.trim();

      if (!name) {
        alert('è¯·è¾“å…¥å¤§çº²åç§°');
        return;
      }

      const outline = {
        id: Date.now().toString(),
        name: name,
        description: desc,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      outlines.push(outline);
      saveData();
      renderAll();
      closeModal('addOutlineModal');
      selectOutline(outline.id);
    }

    // æ·»åŠ å·
    function addVolume() {
      if (!currentOutlineId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¤§çº²');
        return;
      }

      const name = document.getElementById('volumeNameInput').value.trim();
      const desc = document.getElementById('volumeDescInput').value.trim();

      if (!name) {
        alert('è¯·è¾“å…¥å·åç§°');
        return;
      }

      const volume = {
        id: Date.now().toString(),
        outlineId: currentOutlineId,
        name: name,
        description: desc,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      volumes.push(volume);
      saveData();
      renderAll();
      closeModal('addVolumeModal');
    }

    // æ·»åŠ ç« èŠ‚
    function addChapter() {
      if (!currentOutlineId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¤§çº²');
        return;
      }

      const name = document.getElementById('chapterNameInput').value.trim();
      const desc = document.getElementById('chapterDescInput').value.trim();

      if (!name) {
        alert('è¯·è¾“å…¥ç« èŠ‚åç§°');
        return;
      }

      const chapter = {
        id: Date.now().toString(),
        outlineId: currentOutlineId,
        volumeId: currentVolumeId || null,
        name: name,
        description: desc,
        title: '',
        content: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      chapters.push(chapter);
      saveData();
      renderAll();
      closeModal('addChapterModal');
      selectChapter(chapter.id);
    }

    // é€‰æ‹©å¤§çº²
    function selectOutline(outlineId) {
      saveCurrentChapter();
      currentOutlineId = outlineId;
      currentVolumeId = null;
      currentChapterId = null;
      saveData();
      renderAll();
      clearEditor();
    }

    // é€‰æ‹©å·
    function selectVolume(volumeId) {
      saveCurrentChapter();
      currentVolumeId = volumeId;
      currentChapterId = null;
      saveData();
      renderAll();
      clearEditor();
    }

    // é€‰æ‹©ç« èŠ‚
    function selectChapter(chapterId) {
      saveCurrentChapter();
      const chapter = chapters.find(ch => ch.id === chapterId);
      if (chapter) {
        currentVolumeId = chapter.volumeId || null;
      }
      currentChapterId = chapterId;
      saveData();
      renderAll();
      loadChapterContent();
    }

    // ä¿å­˜å½“å‰ç« èŠ‚å†…å®¹
    function saveCurrentChapter() {
      if (!currentChapterId) return;

      const chapter = chapters.find(ch => ch.id === currentChapterId);
      if (chapter) {
        chapter.title = document.getElementById('editorTitle').value;
        chapter.content = document.getElementById('editorContent').innerHTML;
        chapter.updatedAt = new Date().toISOString();
        saveData();
      }
    }

    // åŠ è½½ç« èŠ‚å†…å®¹
    function loadChapterContent() {
      if (!currentChapterId) {
        clearEditor();
        return;
      }

      const chapter = chapters.find(ch => ch.id === currentChapterId);
      if (chapter) {
        document.getElementById('editorTitle').value = chapter.title || '';
        document.getElementById('editorContent').innerHTML = chapter.content || '';
        updateStats();
        updateInfoPanel();
      }
    }

    // åŠ è½½å½“å‰å†…å®¹
    function loadCurrentContent() {
      if (currentChapterId) {
        loadChapterContent();
      } else {
        clearEditor();
      }
    }

    // æ¸…ç©ºç¼–è¾‘å™¨
    function clearEditor() {
      document.getElementById('editorTitle').value = '';
      document.getElementById('editorContent').innerHTML = '';
      updateStats();
    }

    // åˆ é™¤å¤§çº²
    function deleteOutline(outlineId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤§çº²å—ï¼Ÿç›¸å…³çš„å·å’Œç« èŠ‚ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) return;

      outlines = outlines.filter(o => o.id !== outlineId);
      volumes = volumes.filter(v => v.outlineId !== outlineId);
      chapters = chapters.filter(ch => ch.outlineId !== outlineId);

      if (currentOutlineId === outlineId) {
        currentOutlineId = null;
        currentVolumeId = null;
        currentChapterId = null;
      }

      saveData();
      renderAll();
    }

    // åˆ é™¤å·
    function deleteVolume(volumeId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·å—ï¼Ÿå·ä¸‹çš„ç« èŠ‚ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) return;

      volumes = volumes.filter(v => v.id !== volumeId);
      chapters = chapters.filter(ch => ch.volumeId !== volumeId);

      if (currentVolumeId === volumeId) {
        currentVolumeId = null;
        currentChapterId = null;
        clearEditor();
      }

      saveData();
      renderAll();
    }

    // åˆ é™¤ç« èŠ‚
    function deleteChapter(chapterId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç« èŠ‚å—ï¼Ÿ')) return;

      chapters = chapters.filter(ch => ch.id !== chapterId);

      if (currentChapterId === chapterId) {
        currentChapterId = null;
        clearEditor();
      }

      saveData();
      renderAll();
    }

    // å¯¼å‡ºå†…å®¹
    function exportContent() {
      const title = document.getElementById('editorTitle').value || 'æœªå‘½åæ–‡æ¡£';
      const content = document.getElementById('editorContent').innerText || document.getElementById('editorContent').innerHTML;

      const blob = new Blob([`${title}\n\n${content}`], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${title}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // è®¾ç½®ç¼–è¾‘å™¨
    function setupEditor() {
      const editor = document.getElementById('editorContent');
      const title = document.getElementById('editorTitle');

      editor.addEventListener('input', () => {
        updateStats();
        saveCurrentChapter();
      });

      title.addEventListener('input', () => {
        saveCurrentChapter();
      });
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
      const content = document.getElementById('editorContent').innerText || '';
      const words = content.trim().length;
      const paragraphs = content.split('\n').filter(p => p.trim()).length;

      document.getElementById('wordCount').textContent = words;
      document.getElementById('paragraphCount').textContent = paragraphs;
    }

    // æ›´æ–°ä¿¡æ¯é¢æ¿
    function updateInfoPanel() {
      const currentOutline = outlines.find(o => o.id === currentOutlineId);
      const currentVolume = volumes.find(v => v.id === currentVolumeId);
      const currentChapter = chapters.find(ch => ch.id === currentChapterId);

      document.getElementById('currentOutline').textContent = currentOutline ? currentOutline.name : 'æœªé€‰æ‹©';
      document.getElementById('currentVolume').textContent = currentVolume ? currentVolume.name : 'æœªé€‰æ‹©';
      document.getElementById('currentChapter').textContent = currentChapter ? currentChapter.name : 'æœªé€‰æ‹©';

      if (currentChapter) {
        document.getElementById('createTime').textContent = new Date(currentChapter.createdAt).toLocaleString('zh-CN');
        document.getElementById('modifyTime').textContent = new Date(currentChapter.updatedAt).toLocaleString('zh-CN');
      } else {
        document.getElementById('createTime').textContent = '--';
        document.getElementById('modifyTime').textContent = '--';
      }

      // è®¡ç®—æ€»å­—æ•°
      const totalWords = chapters.reduce((sum, ch) => {
        return sum + (ch.content ? ch.content.replace(/<[^>]*>/g, '').length : 0);
      }, 0);
      document.getElementById('totalWords').textContent = totalWords;
    }

    // è®¾ç½®è‡ªåŠ¨ä¿å­˜
    function setupAutoSave() {
      setInterval(() => {
        if (currentChapterId) {
          saveCurrentChapter();
          updateLastSave();
        }
      }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜
    }

    // æ›´æ–°æœ€åä¿å­˜æ—¶é—´
    function updateLastSave() {
      document.getElementById('lastSave').textContent = new Date().toLocaleTimeString('zh-CN');
    }

    // æ¸…ç©ºæ‰€æœ‰æ•°æ®
    function clearAllData() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

      outlines = [];
      volumes = [];
      chapters = [];
      currentOutlineId = null;
      currentVolumeId = null;
      currentChapterId = null;

      saveData();
      renderAll();
      clearEditor();
      alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });

    // å›è½¦é”®æäº¤è¡¨å•
    document.getElementById('outlineNameInput')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        addOutline();
      }
    });

    document.getElementById('volumeNameInput')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        addVolume();
      }
    });

    document.getElementById('chapterNameInput')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        addChapter();
      }
    });
  </script>
</body>

</html>