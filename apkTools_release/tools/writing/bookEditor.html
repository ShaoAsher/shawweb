<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¹¦æœ¬åˆ›ä½œ</title>
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <style>
    .container {
      max-width: 1800px;
    }

    .home-btn {
      position: absolute;
      top: var(--spacing-lg);
      left: var(--spacing-lg);
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-on-primary);
      text-decoration: none;
      font-size: var(--font-size-large);
      transition: all .3s;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .home-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }

    .header h1 {
      font-size: var(--font-size-xlarge);
      margin-bottom: var(--spacing-sm);
    }

    .header p {
      opacity: .9;
      font-size: var(--font-size-small);
    }

    .content {
      padding: var(--spacing-xl);
    }

    .book-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);
      background: var(--color-surface);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
    }

    .book-info {
      flex: 1;
    }

    .book-title {
      font-size: var(--font-size-large);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      margin-bottom: var(--spacing-xs);
    }

    .book-meta {
      font-size: var(--font-size-small);
      color: var(--color-text-secondary);
    }

    .back-btn {
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      color: var(--color-text);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: var(--color-hover);
      border-color: var(--color-primary);
    }

    .tabs {
      display: flex;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-lg);
      border-bottom: 2px solid var(--color-border);
      flex-wrap: wrap;
    }

    .tab {
      padding: var(--spacing-md) var(--spacing-lg);
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--color-text-secondary);
      cursor: pointer;
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      transition: all 0.3s;
      position: relative;
      margin-bottom: -2px;
    }

    .tab:hover {
      color: var(--color-primary);
      background: var(--color-hover);
    }

    .tab.active {
      color: var(--color-primary);
      border-bottom-color: var(--color-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .main-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: var(--spacing-lg);
      height: calc(100vh - 350px);
      min-height: 600px;
    }

    .sidebar {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      border: 1px solid var(--color-border);
      overflow-y: auto;
    }

    .sidebar-section {
      margin-bottom: var(--spacing-xl);
    }

    .sidebar-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--color-border);
    }

    .btn {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: var(--color-text-on-primary);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      width: 100%;
      justify-content: center;
      margin-bottom: var(--spacing-sm);
    }

    .btn:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--color-surface-alt);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .btn-secondary:hover {
      background: var(--color-hover);
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    /* ç¡®ä¿åˆ—è¡¨å®¹å™¨å¯ä»¥æ˜¾ç¤ºdivå…ƒç´  */
    #volumeChapterList {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* å·å®¹å™¨ */
    .volume-container {
      background: var(--color-surface-alt);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      margin-bottom: var(--spacing-md);
      overflow: hidden;
      transition: all 0.2s;
    }

    .volume-container:hover {
      border-color: var(--color-primary);
      box-shadow: var(--shadow-sm);
    }

    .volume-header {
      padding: var(--spacing-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--color-surface-alt);
      transition: background 0.2s;
      user-select: none;
    }

    .volume-header:hover {
      background: var(--color-hover);
    }

    .volume-header.active {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: var(--color-text-on-primary);
    }

    .volume-header-left {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex: 1;
    }

    .volume-toggle {
      cursor: pointer;
      user-select: none;
      font-size: 12px;
      transition: transform 0.2s;
      width: 20px;
      text-align: center;
    }

    .volume-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .volume-title {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-base);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .volume-count {
      font-size: var(--font-size-small);
      opacity: 0.7;
      margin-left: var(--spacing-xs);
    }

    .volume-actions {
      display: flex;
      gap: var(--spacing-xs);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .volume-header:hover .volume-actions {
      opacity: 1;
    }

    .volume-action-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      font-size: 12px;
      color: var(--color-text-secondary);
      transition: color 0.2s;
    }

    .volume-action-btn:hover {
      color: var(--color-error);
    }

    .volume-chapters {
      padding: 0 var(--spacing-md) var(--spacing-md) var(--spacing-md);
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      opacity: 1;
    }

    .volume-chapters.collapsed {
      max-height: 0;
      opacity: 0;
      padding: 0 var(--spacing-md);
    }

    /* ç« èŠ‚åˆ—è¡¨é¡¹ - æ²¡æœ‰ç‹¬ç«‹æ–¹å— */
    .chapter-item {
      padding: var(--spacing-sm) var(--spacing-lg);
      margin: var(--spacing-xs) 0;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: var(--radius-sm);
      position: relative;
    }

    .chapter-item::before {
      content: 'â€¢';
      position: absolute;
      left: 0;
      color: var(--color-text-secondary);
      font-size: 16px;
    }

    .chapter-item:hover {
      background: var(--color-hover);
      transform: translateX(4px);
    }

    .chapter-item.active {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: var(--color-text-on-primary);
    }

    .chapter-item.active::before {
      color: var(--color-text-on-primary);
    }

    .chapter-name {
      flex: 1;
      font-size: var(--font-size-small);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-left: var(--spacing-sm);
    }

    .chapter-actions {
      display: flex;
      gap: var(--spacing-xs);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .chapter-item:hover .chapter-actions {
      opacity: 1;
    }

    .chapter-action-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 2px 6px;
      font-size: 12px;
      color: var(--color-text-secondary);
      transition: color 0.2s;
    }

    .chapter-action-btn:hover {
      color: var(--color-error);
    }

    /* ç‹¬ç«‹ç« èŠ‚ï¼ˆä¸å±äºä»»ä½•å·ï¼‰ */
    .standalone-chapter {
      padding: var(--spacing-sm) var(--spacing-md);
      margin-bottom: var(--spacing-xs);
      background: var(--color-surface-alt);
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .standalone-chapter:hover {
      background: var(--color-hover);
      border-color: var(--color-primary);
      transform: translateX(4px);
    }

    .standalone-chapter.active {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: var(--color-text-on-primary);
      border-color: var(--color-primary);
    }

    .standalone-chapter-name {
      flex: 1;
      font-size: var(--font-size-small);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .standalone-chapter-actions {
      display: flex;
      gap: var(--spacing-xs);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .standalone-chapter:hover .standalone-chapter-actions {
      opacity: 1;
    }

    .standalone-chapter-action-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 2px 6px;
      font-size: 12px;
      color: var(--color-text-secondary);
      transition: color 0.2s;
    }

    .standalone-chapter-action-btn:hover {
      color: var(--color-error);
    }

    .editor-area {
      background: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--spacing-xl);
      border: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--color-border);
    }

    .editor-title-input {
      font-size: var(--font-size-xlarge);
      font-weight: var(--font-weight-bold);
      border: none;
      background: transparent;
      color: var(--color-text);
      flex: 1;
      padding: var(--spacing-sm);
    }

    .editor-title-input:focus {
      outline: 2px solid var(--color-primary);
      outline-offset: 4px;
      border-radius: var(--radius-sm);
    }

    .editor-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-lg);
      background: var(--color-surface-alt);
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      font-family: 'Georgia', 'Times New Roman', serif;
      font-size: 18px;
      line-height: 1.8;
      color: var(--color-text);
      min-height: 400px;
    }

    .editor-content:focus {
      outline: none;
    }

    .editor-stats {
      display: flex;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--color-border);
      font-size: var(--font-size-small);
      color: var(--color-text-secondary);
    }

    .outline-editor,
    .notes-editor {
      min-height: 500px;
      padding: var(--spacing-lg);
      background: var(--color-surface-alt);
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      color: var(--color-text);
    }

    .outline-editor:focus,
    .notes-editor:focus {
      outline: 2px solid var(--color-primary);
      outline-offset: 4px;
    }

    .form-select {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-family: var(--font-family);
      background: var(--color-surface);
      color: var(--color-text);
    }

    .form-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px var(--color-shadow-primary);
    }

    .empty-state {
      text-align: center;
      padding: var(--spacing-xxl);
      color: var(--color-text-light);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-xl);
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--color-border);
    }

    .modal-header {
      font-size: var(--font-size-large);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--color-text);
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: var(--font-size-xlarge);
      cursor: pointer;
      color: var(--color-text-secondary);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-label {
      display: block;
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--spacing-xs);
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-family: var(--font-family);
      background: var(--color-surface);
      color: var(--color-text);
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px var(--color-shadow-primary);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .modal-actions {
      display: flex;
      gap: var(--spacing-md);
      justify-content: flex-end;
      margin-top: var(--spacing-lg);
    }

    @media (max-width: 968px) {
      .main-layout {
        grid-template-columns: 1fr;
        height: auto;
      }

      .sidebar {
        max-height: 300px;
      }
    }
  </style>
  <link rel="icon" href="data:,">
  <script src="../../assets/js/tools.js"></script>
  <script src="../../assets/js/themes.js"></script>
  <script src="../../assets/js/theme-ui.js"></script>
</head>

<body>
  <div class="container">
    <div class="header">
      <a href="bookHome.html" class="home-btn">ğŸ </a>
      <h1></h1>
      <p></p>
    </div>
    <div class="content">
      <div class="book-header" id="bookHeader">
        <div class="book-info">
          <div class="book-title" id="bookTitle">åŠ è½½ä¸­...</div>
          <div class="book-meta" id="bookMeta"></div>
        </div>
        <a href="bookHome.html" class="back-btn">
          <span>â†</span>
          <span>è¿”å›ä¹¦æ¶</span>
        </a>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('writing')">âœï¸ åˆ›ä½œ</button>
        <button class="tab" onclick="switchTab('outline')">ğŸ“‹ å¤§çº²</button>
        <button class="tab" onclick="switchTab('notes')">ğŸ“ å¤‡æ³¨</button>
      </div>

      <!-- åˆ›ä½œæ ‡ç­¾é¡µ -->
      <div class="tab-content active" id="writingTab">
        <div class="main-layout">
          <div class="sidebar">
            <div class="sidebar-section">
              <div class="sidebar-title">
                <span>ğŸ“š</span>
                <span>å·/ç« èŠ‚</span>
              </div>
              <button class="btn btn-secondary" onclick="showAddVolumeModal()">
                <span>â•</span>
                <span>æ–°å»ºå·</span>
              </button>
              <button class="btn btn-secondary" onclick="showAddChapterModal()">
                <span>â•</span>
                <span>æ–°å»ºç« èŠ‚</span>
              </button>
              <ul class="list" id="volumeChapterList"></ul>
            </div>
          </div>

          <div class="editor-area">
            <div class="editor-header">
              <input type="text" class="editor-title-input" id="editorTitle" placeholder="è¯·è¾“å…¥ç« èŠ‚æ ‡é¢˜..." />
              <button class="btn btn-secondary" onclick="exportCurrentBookAsTxt()"
                style="margin-left: var(--spacing-md);">
                <span>ğŸ“¥</span>
                <span>å¯¼å‡ºTXT</span>
              </button>
            </div>
            <div class="editor-content" contenteditable="true" id="editorContent" placeholder="å¼€å§‹ä½ çš„åˆ›ä½œä¹‹æ—…..."></div>
            <div class="editor-stats">
              <div>ğŸ“Š å­—æ•°: <span id="wordCount">0</span></div>
              <div>ğŸ“„ æ®µè½: <span id="paragraphCount">0</span></div>
              <div>â° æœ€åä¿å­˜: <span id="lastSave">--</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- å¤§çº²æ ‡ç­¾é¡µ -->
      <div class="tab-content" id="outlineTab">
        <textarea class="outline-editor" id="outlineEditor" placeholder="åœ¨è¿™é‡Œç¼–å†™ä½ çš„å¤§çº²..."></textarea>
      </div>

      <!-- å¤‡æ³¨æ ‡ç­¾é¡µ -->
      <div class="tab-content" id="notesTab">
        <textarea class="notes-editor" id="notesEditor" placeholder="åœ¨è¿™é‡Œè®°å½•ä½ çš„å¤‡æ³¨ã€çµæ„Ÿã€æƒ³æ³•..."></textarea>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ å·æ¨¡æ€æ¡† -->
  <div class="modal" id="volumeModal">
    <div class="modal-content">
      <div class="modal-header">
        <span>æ–°å»ºå·</span>
        <button class="modal-close" onclick="closeModal('volumeModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">å·åç§°</label>
        <input type="text" class="form-input" id="volumeNameInput" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€å·" />
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('volumeModal')">å–æ¶ˆ</button>
        <button class="btn" onclick="addVolume()">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ ç« èŠ‚æ¨¡æ€æ¡† -->
  <div class="modal" id="chapterModal">
    <div class="modal-content">
      <div class="modal-header">
        <span>æ–°å»ºç« èŠ‚</span>
        <button class="modal-close" onclick="closeModal('chapterModal')">&times;</button>
      </div>
      <div class="form-group">
        <label class="form-label">ç« èŠ‚åç§°</label>
        <input type="text" class="form-input" id="chapterNameInput" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€ç« " />
      </div>
      <div class="form-group">
        <label class="form-label">æ‰€å±å·ï¼ˆå¯é€‰ï¼‰</label>
        <select class="form-input" id="chapterVolumeSelect">
          <option value="">ä¸å½’å±äºä»»ä½•å·</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('chapterModal')">å–æ¶ˆ</button>
        <button class="btn" onclick="addChapter()">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <script>
    let bookId = null;
    let bookData = null;
    let volumes = [];
    let chapters = [];
    let currentVolumeId = null;
    let currentChapterId = null;
    let collapsedVolumes = new Set(); // å­˜å‚¨æŠ˜å çš„å·ID

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      bookId = urlParams.get('bookId');

      if (!bookId) {
        alert('ç¼ºå°‘ä¹¦ç±IDï¼Œå°†è¿”å›ä¹¦æ¶');
        window.location.href = 'bookHome.html';
        return;
      }

      loadBookData();
      loadBookContent();
      renderVolumesAndChapters();
      setupEditor();
      setupAutoSave();
    });

    // åŠ è½½ä¹¦ç±ä¿¡æ¯
    function loadBookData() {
      const books = JSON.parse(localStorage.getItem('writingAssistant_books') || '[]');
      bookData = books.find(b => b.id === bookId);

      if (!bookData) {
        alert('ä¹¦ç±ä¸å­˜åœ¨ï¼Œå°†è¿”å›ä¹¦æ¶');
        window.location.href = 'bookHome.html';
        return;
      }

      document.getElementById('bookTitle').textContent = bookData.title;
      document.getElementById('bookMeta').textContent = `${bookData.author} Â· ${bookData.category || 'æœªåˆ†ç±»'}`;
    }

    // åŠ è½½ä¹¦ç±å†…å®¹
    function loadBookContent() {
      const saved = localStorage.getItem(`writingAssistant_book_${bookId}`);
      if (saved) {
        const data = JSON.parse(saved);
        volumes = data.volumes || [];
        chapters = data.chapters || [];
        currentVolumeId = data.currentVolumeId || null;
        currentChapterId = data.currentChapterId || null;

        document.getElementById('outlineEditor').value = data.outline || '';
        document.getElementById('notesEditor').value = data.notes || '';

        // åŠ è½½æŠ˜å çŠ¶æ€
        if (data.collapsedVolumes) {
          collapsedVolumes = new Set(data.collapsedVolumes);
        }
      }
    }

    // ä¿å­˜ä¹¦ç±å†…å®¹
    function saveBookContent() {
      const data = {
        volumes,
        chapters,
        currentVolumeId,
        currentChapterId,
        outline: document.getElementById('outlineEditor').value,
        notes: document.getElementById('notesEditor').value,
        collapsedVolumes: Array.from(collapsedVolumes)
      };
      localStorage.setItem(`writingAssistant_book_${bookId}`, JSON.stringify(data));
    }


    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`${tabName}Tab`).classList.add('active');
    }

    // æ¸²æŸ“å·å’Œç« èŠ‚åˆ—è¡¨
    function renderVolumesAndChapters() {
      const list = document.getElementById('volumeChapterList');
      list.innerHTML = '';

      // æ¸²æŸ“å·åŠå…¶ä¸‹çš„ç« èŠ‚
      volumes.forEach(volume => {
        const isCollapsed = collapsedVolumes.has(volume.id);
        const volumeChapters = chapters.filter(ch => ch.volumeId === volume.id);
        const isVolumeActive = volume.id === currentVolumeId;

        // åˆ›å»ºå·å®¹å™¨
        const volumeContainer = document.createElement('div');
        volumeContainer.className = 'volume-container';

        // å·å¤´éƒ¨
        const volumeHeader = document.createElement('div');
        volumeHeader.className = `volume-header ${isVolumeActive ? 'active' : ''}`;
        volumeHeader.onclick = () => selectVolume(volume.id);
        volumeHeader.innerHTML = `
          <div class="volume-header-left">
            <span class="volume-toggle ${isCollapsed ? 'collapsed' : ''}" onclick="toggleVolume('${volume.id}', event)">â–¶</span>
            <span class="volume-title">${volume.name}</span>
            ${volumeChapters.length > 0 ? `<span class="volume-count">(${volumeChapters.length})</span>` : ''}
          </div>
          <div class="volume-actions" onclick="event.stopPropagation()">
            <button class="volume-action-btn" onclick="deleteVolume('${volume.id}')">ğŸ—‘ï¸</button>
          </div>
        `;
        volumeContainer.appendChild(volumeHeader);

        // ç« èŠ‚åˆ—è¡¨
        if (volumeChapters.length > 0) {
          const chaptersContainer = document.createElement('div');
          chaptersContainer.className = `volume-chapters ${isCollapsed ? 'collapsed' : ''}`;

          volumeChapters.forEach(chapter => {
            const chapterItem = document.createElement('div');
            chapterItem.className = `chapter-item ${chapter.id === currentChapterId ? 'active' : ''}`;
            chapterItem.onclick = () => selectChapter(chapter.id);
            chapterItem.innerHTML = `
              <span class="chapter-name">${chapter.name}</span>
              <div class="chapter-actions" onclick="event.stopPropagation()">
                <button class="chapter-action-btn" onclick="deleteChapter('${chapter.id}')">ğŸ—‘ï¸</button>
              </div>
            `;
            chaptersContainer.appendChild(chapterItem);
          });

          volumeContainer.appendChild(chaptersContainer);
        }

        list.appendChild(volumeContainer);
      });

      // æ¸²æŸ“ä¸å±äºä»»ä½•å·çš„ç« èŠ‚
      const ungroupedChapters = chapters.filter(ch => !ch.volumeId);
      if (ungroupedChapters.length > 0) {
        ungroupedChapters.forEach(chapter => {
          const chapterItem = document.createElement('div');
          chapterItem.className = `standalone-chapter ${chapter.id === currentChapterId ? 'active' : ''}`;
          chapterItem.onclick = () => selectChapter(chapter.id);
          chapterItem.innerHTML = `
            <span class="standalone-chapter-name">${chapter.name}</span>
            <div class="standalone-chapter-actions" onclick="event.stopPropagation()">
              <button class="standalone-chapter-action-btn" onclick="deleteChapter('${chapter.id}')">ğŸ—‘ï¸</button>
            </div>
          `;
          list.appendChild(chapterItem);
        });
      }
    }

    // åˆ‡æ¢å·çš„æŠ˜å çŠ¶æ€
    function toggleVolume(volumeId, event) {
      event.stopPropagation();
      if (collapsedVolumes.has(volumeId)) {
        collapsedVolumes.delete(volumeId);
      } else {
        collapsedVolumes.add(volumeId);
      }
      saveBookContent();
      renderVolumesAndChapters();
    }

    // æ˜¾ç¤ºæ·»åŠ å·æ¨¡æ€æ¡†
    function showAddVolumeModal() {
      document.getElementById('volumeModal').classList.add('show');
      document.getElementById('volumeNameInput').value = '';
      document.getElementById('volumeNameInput').focus();
    }

    // æ˜¾ç¤ºæ·»åŠ ç« èŠ‚æ¨¡æ€æ¡†
    function showAddChapterModal() {
      // æ›´æ–°å·é€‰æ‹©ä¸‹æ‹‰æ¡†
      const volumeSelect = document.getElementById('chapterVolumeSelect');
      volumeSelect.innerHTML = '<option value="">ä¸å½’å±äºä»»ä½•å·</option>';
      volumes.forEach(volume => {
        const option = document.createElement('option');
        option.value = volume.id;
        option.textContent = volume.name;
        volumeSelect.appendChild(option);
      });

      document.getElementById('chapterModal').classList.add('show');
      document.getElementById('chapterNameInput').value = '';
      document.getElementById('chapterVolumeSelect').value = currentVolumeId || '';
      document.getElementById('chapterNameInput').focus();
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // æ·»åŠ å·
    function addVolume() {
      const name = document.getElementById('volumeNameInput').value.trim();
      if (!name) {
        alert('è¯·è¾“å…¥å·åç§°');
        return;
      }

      volumes.push({
        id: Date.now().toString(),
        name,
        bookId
      });

      saveBookContent();
      renderVolumesAndChapters();
      closeModal('volumeModal');
    }

    // æ·»åŠ ç« èŠ‚
    function addChapter() {
      const name = document.getElementById('chapterNameInput').value.trim();
      if (!name) {
        alert('è¯·è¾“å…¥ç« èŠ‚åç§°');
        return;
      }

      const selectedVolumeId = document.getElementById('chapterVolumeSelect').value || null;

      chapters.push({
        id: Date.now().toString(),
        name,
        bookId,
        volumeId: selectedVolumeId,
        title: '',
        content: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      });

      saveBookContent();
      renderVolumesAndChapters();
      closeModal('chapterModal');
      selectChapter(chapters[chapters.length - 1].id);
    }

    // é€‰æ‹©å·
    function selectVolume(volumeId) {
      saveCurrentChapter();
      currentVolumeId = volumeId;
      currentChapterId = null;
      saveBookContent();
      renderVolumesAndChapters();
      clearEditor();
    }

    // é€‰æ‹©ç« èŠ‚
    function selectChapter(chapterId) {
      saveCurrentChapter();
      const chapter = chapters.find(ch => ch.id === chapterId);
      if (chapter) {
        currentVolumeId = chapter.volumeId || null;
      }
      currentChapterId = chapterId;
      saveBookContent();
      renderVolumesAndChapters();
      loadChapterContent();
    }

    // ä¿å­˜å½“å‰ç« èŠ‚
    function saveCurrentChapter() {
      if (!currentChapterId) return;
      const chapter = chapters.find(ch => ch.id === currentChapterId);
      if (chapter) {
        chapter.title = document.getElementById('editorTitle').value;
        chapter.content = document.getElementById('editorContent').innerHTML;
        chapter.updatedAt = new Date().toISOString();
        saveBookContent();
      }
    }

    // åŠ è½½ç« èŠ‚å†…å®¹
    function loadChapterContent() {
      if (!currentChapterId) {
        clearEditor();
        return;
      }
      const chapter = chapters.find(ch => ch.id === currentChapterId);
      if (chapter) {
        document.getElementById('editorTitle').value = chapter.title || '';
        document.getElementById('editorContent').innerHTML = chapter.content || '';
        updateStats();
      }
    }

    // æ¸…ç©ºç¼–è¾‘å™¨
    function clearEditor() {
      document.getElementById('editorTitle').value = '';
      document.getElementById('editorContent').innerHTML = '';
      updateStats();
    }

    // åˆ é™¤å·
    function deleteVolume(volumeId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå·å—ï¼Ÿå·ä¸‹çš„ç« èŠ‚ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) return;
      volumes = volumes.filter(v => v.id !== volumeId);
      chapters = chapters.filter(ch => ch.volumeId !== volumeId);
      if (currentVolumeId === volumeId) {
        currentVolumeId = null;
        currentChapterId = null;
        clearEditor();
      }
      saveBookContent();
      renderVolumesAndChapters();
    }

    // åˆ é™¤ç« èŠ‚
    function deleteChapter(chapterId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç« èŠ‚å—ï¼Ÿ')) return;
      chapters = chapters.filter(ch => ch.id !== chapterId);
      if (currentChapterId === chapterId) {
        currentChapterId = null;
        clearEditor();
      }
      saveBookContent();
      renderVolumesAndChapters();
    }

    // è®¾ç½®ç¼–è¾‘å™¨
    function setupEditor() {
      const editor = document.getElementById('editorContent');
      const title = document.getElementById('editorTitle');

      // Tabé”®ç¼©è¿›åŠŸèƒ½
      editor.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          e.preventDefault();
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const tab = document.createTextNode('\u00A0\u00A0\u00A0\u00A0'); // 4ä¸ªä¸é—´æ–­ç©ºæ ¼
            range.insertNode(tab);
            range.setStartAfter(tab);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
          }
        }
      });

      editor.addEventListener('input', () => {
        updateStats();
        saveCurrentChapter();
      });

      title.addEventListener('input', () => {
        saveCurrentChapter();
      });

      document.getElementById('outlineEditor').addEventListener('input', saveBookContent);
      document.getElementById('notesEditor').addEventListener('input', saveBookContent);
    }

    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
      const content = document.getElementById('editorContent').innerText || '';
      const words = content.trim().length;
      const paragraphs = content.split('\n').filter(p => p.trim()).length;
      document.getElementById('wordCount').textContent = words;
      document.getElementById('paragraphCount').textContent = paragraphs;
    }

    // è®¾ç½®è‡ªåŠ¨ä¿å­˜
    function setupAutoSave() {
      setInterval(() => {
        saveCurrentChapter();
        saveBookContent();
        document.getElementById('lastSave').textContent = new Date().toLocaleTimeString('zh-CN');
      }, 30000);
    }

    // å¯¼å‡ºå½“å‰ä¹¦ç±ä¸ºTXT
    function exportCurrentBookAsTxt() {
      if (!bookData) {
        alert('ä¹¦ç±ä¿¡æ¯ä¸å­˜åœ¨');
        return;
      }

      saveCurrentChapter(); // å…ˆä¿å­˜å½“å‰ç« èŠ‚
      saveBookContent(); // ä¿å­˜æ‰€æœ‰å†…å®¹

      const bookContent = localStorage.getItem(`writingAssistant_book_${bookId}`);
      if (!bookContent) {
        alert('è¿™æœ¬ä¹¦è¿˜æ²¡æœ‰åˆ›ä½œå†…å®¹');
        return;
      }

      const content = JSON.parse(bookContent);
      let txtContent = '';

      // ä¹¦ç±ä¿¡æ¯
      txtContent += `ä¹¦åï¼š${bookData.title}\n`;
      txtContent += `ä½œè€…ï¼š${bookData.author}\n`;
      if (bookData.category) txtContent += `åˆ†ç±»ï¼š${bookData.category}\n`;
      if (bookData.description) txtContent += `ç®€ä»‹ï¼š${bookData.description}\n`;
      txtContent += '\n' + '='.repeat(50) + '\n\n';

      // å¤§çº²
      if (content.outline) {
        txtContent += 'ã€å¤§çº²ã€‘\n';
        txtContent += content.outline + '\n\n';
        txtContent += '='.repeat(50) + '\n\n';
      }

      // ç« èŠ‚å†…å®¹
      if (content.chapters && content.chapters.length > 0) {
        const volumes = content.volumes || [];

        // æŒ‰å·åˆ†ç»„å¯¼å‡º
        volumes.forEach(volume => {
          const volumeChapters = content.chapters.filter(ch => ch.volumeId === volume.id);
          if (volumeChapters.length > 0) {
            txtContent += `\nã€${volume.name}ã€‘\n\n`;
            volumeChapters.forEach(chapter => {
              txtContent += `${chapter.name}\n`;
              if (chapter.title) txtContent += `æ ‡é¢˜ï¼š${chapter.title}\n`;
              if (chapter.content) {
                const textContent = chapter.content.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').trim();
                txtContent += textContent + '\n\n';
              }
              txtContent += '-'.repeat(30) + '\n\n';
            });
          }
        });

        // ç‹¬ç«‹ç« èŠ‚
        const ungroupedChapters = content.chapters.filter(ch => !ch.volumeId);
        if (ungroupedChapters.length > 0) {
          txtContent += '\nã€ç‹¬ç«‹ç« èŠ‚ã€‘\n\n';
          ungroupedChapters.forEach(chapter => {
            txtContent += `${chapter.name}\n`;
            if (chapter.title) txtContent += `æ ‡é¢˜ï¼š${chapter.title}\n`;
            if (chapter.content) {
              const textContent = chapter.content.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').trim();
              txtContent += textContent + '\n\n';
            }
            txtContent += '-'.repeat(30) + '\n\n';
          });
        }
      }

      // å¤‡æ³¨
      if (content.notes) {
        txtContent += '\n' + '='.repeat(50) + '\n\n';
        txtContent += 'ã€å¤‡æ³¨ã€‘\n';
        txtContent += content.notes + '\n';
      }

      // ä¸‹è½½æ–‡ä»¶
      const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${bookData.title}.txt`;
      a.click();
      URL.revokeObjectURL(url);

      alert('å¯¼å‡ºæˆåŠŸï¼');
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
      }
    });
  </script>
</body>

</html>