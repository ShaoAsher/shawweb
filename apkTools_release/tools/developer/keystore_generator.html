<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android ç­¾åæ–‡ä»¶ç”Ÿæˆå·¥å…·</title>
    <link rel="stylesheet" href="../../assets/css/theme.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/1.3.1/forge.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* ç»§æ‰¿theme.cssçš„åŸºç¡€æ ·å¼ */
        /* ä»¥ä¸‹æ˜¯å·¥å…·é¡µé¢ç‰¹å®šçš„æ ·å¼è¦†ç›– */

        .container {
            max-width: 1000px;
        }

        .home-btn {
            position: absolute;
            top: var(--spacing-lg);
            left: var(--spacing-lg);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-on-primary);
            text-decoration: none;
            font-size: var(--font-size-large);
            transition: all .3s;
            z-index: 10;
        }

        .home-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .header h1 {
            font-size: var(--font-size-xlarge);
            margin-bottom: var(--spacing-sm);
        }

        .header p {
            opacity: 0.9;
            font-size: var(--font-size-small);
        }

        .content {
            padding: var(--spacing-xl);
        }

        .form-section {
            background: var(--color-background-alt);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .form-section h2 {
            font-size: var(--font-size-large);
            color: var(--color-text);
            margin-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: var(--spacing-sm);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-small);
        }

        .form-group input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-small);
            transition: border-color 0.3s;
            background: var(--color-surface);
            color: var(--color-text);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px var(--color-shadow-primary);
        }

        .form-group small {
            display: block;
            color: var(--color-text-secondary);
            margin-top: var(--spacing-xs);
            font-size: var(--font-size-small);
        }

        .btn {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: var(--color-text-on-primary);
            border: none;
            padding: var(--spacing-sm) var(--spacing-xl);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .result-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .result-value-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .result-value {
            color: #212529;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            flex: 1;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-line;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #fee;
            border-left-color: #dc3545;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .success.show {
            display: block;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .copy-btn:hover {
            background: #764ba2;
            transform: translateY(-1px);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
            width: 100%;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #0c5460;
        }

        .history-section {
            margin-top: 30px;
        }

        .history-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: #667eea;
        }

        .history-item.expanded {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .history-item.highlight {
            border-color: #28a745;
            background: #f0fff4;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .history-header:hover .history-package {
            color: #667eea;
        }

        .history-info {
            flex: 1;
        }

        .history-package {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .history-details {
            font-size: 12px;
            color: #6c757d;
        }

        .history-actions {
            display: flex;
            gap: 10px;
        }

        .history-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-btn.download {
            background: #28a745;
            color: white;
        }

        .history-btn.download:hover {
            background: #218838;
        }

        .history-btn.delete {
            background: #dc3545;
            color: white;
        }

        .history-btn.delete:hover {
            background: #c82333;
        }

        .history-btn.view {
            background: #667eea;
            color: white;
        }

        .history-btn.view:hover {
            background: #764ba2;
        }

        .history-detail {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .history-detail.show {
            display: block;
        }

        .history-expand-icon {
            margin-left: 10px;
            transition: transform 0.3s;
            font-size: 12px;
        }

        .history-item.expanded .history-expand-icon {
            transform: rotate(180deg);
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .empty-history {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="../../index.html" class="home-btn" title="è¿”å›é¦–é¡µ">ğŸ </a>
            <h1>ğŸ”‘ Android ç­¾åæ–‡ä»¶ç”Ÿæˆå·¥å…·</h1>
            <p>æ ¹æ®åŒ…åç”Ÿæˆ .jks å¹¶æå–æŒ‡çº¹ä¸å…¬é’¥ä¿¡æ¯ï¼Œæ”¯æŒå†å²è®°å½•å¯¼å…¥å¯¼å‡ºã€‚</p>
        </div>
        <div class="content">
            <div class="info-box">
                <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong>è¾“å…¥AndroidåŒ…åå’Œå…¶ä»–ä¿¡æ¯ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆç­¾åæ–‡ä»¶ï¼ˆkeystoreï¼‰ã€‚å¯†é’¥åˆ«åè‡ªåŠ¨ä½¿ç”¨åŒ…åï¼Œä¿å­˜çš„æ–‡ä»¶åä¹Ÿä¸åŒ…åç›¸åŒã€‚
            </div>

            <div class="form-section">
                <h2>ç­¾åä¿¡æ¯é…ç½®</h2>
                <div class="form-group">
                    <label for="packageName">Android åŒ…å *</label>
                    <input type="text" id="packageName" placeholder="ä¾‹å¦‚: com.example.myapp" required>
                    <small>è¾“å…¥åº”ç”¨çš„å®Œæ•´åŒ…å</small>
                </div>
                <div class="form-group">
                    <label for="keyAlias">å¯†é’¥åˆ«å (keyAlias) *</label>
                    <input type="text" id="keyAlias" placeholder="ä¸åŒ…åç›¸åŒ" value="" readonly required>
                    <small>å¯†é’¥åˆ«åè‡ªåŠ¨ä½¿ç”¨åŒ…å</small>
                </div>
                <div class="form-group">
                    <label for="storePassword">å¯†é’¥åº“å¯†ç  (storePassword/keyPassword) *</label>
                    <input type="text" id="storePassword" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦" value="123456" required>
                    <small>ç”¨äºä¿æŠ¤å¯†é’¥åº“æ–‡ä»¶å’Œå¯†é’¥çš„å¯†ç ï¼ˆstorePassword å’Œ keyPassword ä½¿ç”¨ç›¸åŒå¯†ç ï¼Œè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰</small>
                </div>
                <div class="form-group">
                    <label for="validity">æœ‰æ•ˆæœŸï¼ˆå¹´ï¼‰</label>
                    <input type="number" id="validity" placeholder="100" value="100" min="1" max="100">
                    <small>è¯ä¹¦æœ‰æ•ˆæœŸï¼Œé»˜è®¤100å¹´</small>
                </div>
                <div class="form-group">
                    <label for="name">å§“å/ç»„ç»‡</label>
                    <input type="text" id="name" placeholder="CN" value="CN">
                    <small>è¯ä¹¦æŒæœ‰è€…å§“å</small>
                </div>
                <div class="form-group">
                    <label for="org">ç»„ç»‡å•ä½</label>
                    <input type="text" id="org" placeholder="OU" value="OU">
                    <small>ç»„ç»‡å•ä½åç§°</small>
                </div>
                <div class="form-group">
                    <label for="orgUnit">ç»„ç»‡</label>
                    <input type="text" id="orgUnit" placeholder="O" value="O">
                    <small>ç»„ç»‡åç§°</small>
                </div>
                <div class="form-group">
                    <label for="city">åŸå¸‚</label>
                    <input type="text" id="city" placeholder="L" value="L">
                    <small>åŸå¸‚åç§°</small>
                </div>
                <div class="form-group">
                    <label for="state">å·/çœ</label>
                    <input type="text" id="state" placeholder="ST" value="ST">
                    <small>å·æˆ–çœåç§°</small>
                </div>
                <div class="form-group">
                    <label for="country">å›½å®¶ä»£ç </label>
                    <input type="text" id="country" placeholder="CN" value="CN" maxlength="2">
                    <small>ä¸¤å­—æ¯å›½å®¶ä»£ç ï¼ˆå¦‚ï¼šCN, USï¼‰</small>
                </div>
            </div>

            <button class="btn" id="generateBtn" onclick="generateKeystore()">ç”Ÿæˆç­¾åæ–‡ä»¶</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>æ­£åœ¨ç”Ÿæˆç­¾åæ–‡ä»¶...</div>
            </div>

            <div class="error" id="error"></div>
            <div class="success" id="success"></div>

            <div class="form-section history-section">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">å†å²è®°å½•</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="history-btn" style="background: #28a745; color: white;"
                            onclick="exportAllToProject()">å¯¼å‡ºæ‰€æœ‰åˆ°é¡¹ç›®ç›®å½•</button>
                        <button class="history-btn" style="background: #17a2b8; color: white;"
                            onclick="exportHistoryToFile()">å¯¼å‡ºå…ƒæ•°æ®</button>
                        <button class="history-btn" style="background: #6c757d; color: white;"
                            onclick="importHistoryFromFile()">å¯¼å…¥å†å²</button>
                    </div>
                </div>
                <div class="info-box" style="margin-bottom: 20px;">
                    <strong>è¯´æ˜ï¼š</strong>
                    <ul style="margin: 10px 0 0 20px; padding: 0; line-height: 1.8;">
                        <li><strong>.keystore å’Œ .jks çš„åŒºåˆ«ï¼š</strong>ä¸¤è€…éƒ½æ˜¯ Java KeyStore æ ¼å¼ï¼Œ.jks æ˜¯åŸå§‹æ ¼å¼åç§°ï¼Œ.keystore æ˜¯åˆ«åã€‚åœ¨
                            Android å¼€å‘ä¸­å¯ä»¥äº’æ¢ä½¿ç”¨ã€‚æœ¬å·¥å…·ç”Ÿæˆçš„æ˜¯ PKCS#12 æ ¼å¼ï¼ˆå…¼å®¹ .keystore/.jksï¼‰ï¼Œé»˜è®¤ç”Ÿæˆ .jks æ–‡ä»¶ã€‚</li>
                        <li><strong>å¯†é’¥åˆ«åï¼š</strong>å¯†é’¥åˆ«åè‡ªåŠ¨ä½¿ç”¨åŒ…åï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥ã€‚</li>
                        <li><strong>å¯¼å‡ºæ‰€æœ‰åˆ°é¡¹ç›®ç›®å½•ï¼š</strong>ä¼šç”Ÿæˆä¸€ä¸ª ZIP æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ .jks æ–‡ä»¶å’Œå…ƒæ•°æ® JSONï¼Œä¸‹è½½åè§£å‹åˆ°é¡¹ç›®æ ¹ç›®å½•å³å¯ã€‚è¿™æ ·æ¢ç”µè„‘ä¹Ÿä¸ä¼šä¸¢å¤±æ•°æ®ã€‚
                        </li>
                        <li><strong>å¯¼å…¥å†å²ï¼š</strong>æ”¯æŒå¯¼å…¥ JSON æˆ– ZIP æ ¼å¼çš„å†å²è®°å½•æ–‡ä»¶ã€‚</li>
                    </ul>
                </div>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢åŒ…å..." oninput="filterHistory()">
                </div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script>
        let generatedKeystore = null;
        let keystoreFileName = '';
        const STORAGE_KEY = 'keystore_history';

        // ä»åŒ…åæå–ä¸­é—´éƒ¨åˆ†ä½œä¸ºé»˜è®¤åˆ«å
        function extractKeyAliasFromPackageName(packageName) {
            if (!packageName || packageName.trim() === '') {
                return '';
            }

            const parts = packageName.split('.');
            if (parts.length >= 3) {
                // å¦‚æœæœ‰3ä¸ªæˆ–æ›´å¤šéƒ¨åˆ†ï¼Œå–ä¸­é—´éƒ¨åˆ†
                // ä¾‹å¦‚: com.example.myapp -> example
                const middleIndex = Math.floor(parts.length / 2);
                return parts[middleIndex];
            } else if (parts.length === 2) {
                // å¦‚æœåªæœ‰2ä¸ªéƒ¨åˆ†ï¼Œå–ç¬¬äºŒéƒ¨åˆ†
                // ä¾‹å¦‚: com.example -> example
                return parts[1];
            } else {
                // å¦‚æœåªæœ‰1ä¸ªéƒ¨åˆ†ï¼Œç›´æ¥ä½¿ç”¨
                return parts[0];
            }
        }

        // ä»åŒ…åç”Ÿæˆç¡®å®šæ€§å¯†é’¥å¯¹
        function generateDeterministicKeyPair(packageName, bits = 2048) {
            // ä½¿ç”¨åŒ…åä½œä¸ºç§å­ç”Ÿæˆç¡®å®šæ€§éšæœºæ•°
            // é€šè¿‡å¤šæ¬¡å“ˆå¸Œç”Ÿæˆè¶³å¤Ÿé•¿çš„éšæœºå­—èŠ‚æµ
            const seedBase = CryptoJS.SHA256(packageName).toString();
            let seedBytes = [];
            let counter = 0;

            // ç”Ÿæˆè¶³å¤Ÿé•¿çš„ç§å­å­—èŠ‚ï¼ˆRSA 2048ä½éœ€è¦å¤§é‡éšæœºå­—èŠ‚ï¼‰
            while (seedBytes.length < 10000) {
                const hash = CryptoJS.SHA256(seedBase + counter.toString()).toString();
                // å°†åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
                const bytes = forge.util.hexToBytes(hash);
                // forge.util.hexToBytes è¿”å›å­—ç¬¦ä¸²ï¼Œéœ€è¦è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
                for (let i = 0; i < bytes.length; i++) {
                    seedBytes.push(bytes.charCodeAt(i) & 0xFF);
                }
                counter++;
            }

            let seedIndex = 0;

            // åˆ›å»ºç¬¦åˆ forge åº“æœŸæœ›çš„éšæœºæ•°ç”Ÿæˆå™¨å¯¹è±¡
            // forge æœŸæœ› getBytesSync è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå­—ç¬¦ä»£è¡¨ä¸€ä¸ªå­—èŠ‚
            const prng = {
                getBytesSync: function (count) {
                    let result = '';
                    for (let i = 0; i < count; i++) {
                        const byte = seedBytes[seedIndex % seedBytes.length];
                        result += String.fromCharCode(byte);
                        seedIndex++;
                    }
                    return result;
                }
            };

            // ç”Ÿæˆå¯†é’¥å¯¹
            const keyPair = forge.pki.rsa.generateKeyPair(bits, { prng: prng });
            return keyPair;
        }

        // ä¿å­˜å†å²è®°å½•
        function saveHistory(packageName, keystoreData, keyAlias, storePassword, keyPassword, md5, sha1, sha256, publicKey) {
            const history = getHistory();
            const historyItem = {
                packageName: packageName,
                keyAlias: keyAlias,
                storePassword: storePassword,
                keyPassword: keyPassword,
                // ä¿ç•™æ—§å­—æ®µä»¥å…¼å®¹
                alias: keyAlias,
                password: storePassword,
                md5: md5,
                sha1: sha1,
                sha256: sha256,
                publicKey: publicKey,
                keystoreData: Array.from(keystoreData), // è½¬æ¢ä¸ºæ•°ç»„ä»¥ä¾¿å­˜å‚¨
                timestamp: new Date().toISOString()
            };

            // å¦‚æœåŒ…åå·²å­˜åœ¨ï¼Œæ›´æ–°è®°å½•ï¼›å¦åˆ™æ·»åŠ æ–°è®°å½•
            const existingIndex = history.findIndex(item => item.packageName === packageName);
            if (existingIndex >= 0) {
                history[existingIndex] = historyItem;
            } else {
                history.push(historyItem);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            renderHistory();
        }

        // è·å–å†å²è®°å½•
        function getHistory() {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : [];
        }

        // æ¸²æŸ“å†å²è®°å½•è¯¦æƒ…ï¼ˆå¤ç”¨ç”ŸæˆæˆåŠŸçš„å±•ç¤ºæ ·å¼ï¼‰
        function renderHistoryDetail(item, container) {
            // ä½¿ç”¨DOMæ“ä½œè€Œä¸æ˜¯innerHTMLï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            container.innerHTML = '';

            const formSection = document.createElement('div');
            formSection.className = 'form-section';
            formSection.style.marginTop = '0';
            formSection.style.background = '#f8f9fa';

            const title = document.createElement('h2');
            title.style.marginTop = '0';
            title.textContent = 'ç­¾åä¿¡æ¯è¯¦æƒ…';
            formSection.appendChild(title);

            // åˆ›å»ºç»“æœé¡¹çš„å‡½æ•°
            const createResultItem = (label, value, isHash = false) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'result-label';
                labelDiv.textContent = label;

                const valueWrapper = document.createElement('div');
                valueWrapper.className = 'result-value-wrapper';

                const valueDiv = document.createElement('div');
                valueDiv.className = 'result-value';
                valueDiv.textContent = value;

                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '5px';

                if (isHash) {
                    // å“ˆå¸Œå€¼æ˜¾ç¤ºä¸¤ç§æ ¼å¼ï¼Œæä¾›ä¸¤ä¸ªå¤åˆ¶æŒ‰é’®
                    const spaceBtn = document.createElement('button');
                    spaceBtn.className = 'copy-btn';
                    spaceBtn.setAttribute('data-copy', formatHashFromString(value, 'space'));
                    spaceBtn.textContent = 'å¤åˆ¶ç©ºæ ¼';
                    buttonContainer.appendChild(spaceBtn);

                    const colonBtn = document.createElement('button');
                    colonBtn.className = 'copy-btn';
                    colonBtn.setAttribute('data-copy', formatHashFromString(value, 'colon'));
                    colonBtn.textContent = 'å¤åˆ¶å†’å·';
                    buttonContainer.appendChild(colonBtn);
                } else {
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-btn';
                    copyBtn.setAttribute('data-copy', value);
                    copyBtn.textContent = 'å¤åˆ¶';
                    buttonContainer.appendChild(copyBtn);
                }

                valueWrapper.appendChild(valueDiv);
                valueWrapper.appendChild(buttonContainer);

                resultItem.appendChild(labelDiv);
                resultItem.appendChild(valueWrapper);

                return resultItem;
            };

            formSection.appendChild(createResultItem('å¯†é’¥åˆ«å (keyAlias)', item.keyAlias || item.alias));
            formSection.appendChild(createResultItem('å¯†é’¥åº“å¯†ç  (storePassword)', item.storePassword || item.password));
            formSection.appendChild(createResultItem('å¯†é’¥å¯†ç  (keyPassword)', item.keyPassword || item.password));
            formSection.appendChild(createResultItem('MD5 æŒ‡çº¹', formatHashForDisplay(item.md5), true));
            formSection.appendChild(createResultItem('SHA1 æŒ‡çº¹', formatHashForDisplay(item.sha1), true));
            formSection.appendChild(createResultItem('SHA256 æŒ‡çº¹', formatHashForDisplay(item.sha256), true));
            formSection.appendChild(createResultItem('å…¬é’¥ï¼ˆå¤§æ•´æ•°æ ¼å¼ï¼‰', item.publicKey));

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'download-btn';
            downloadBtn.textContent = 'ä¸‹è½½ç­¾åæ–‡ä»¶ (.jks)';
            downloadBtn.onclick = () => downloadFromHistory(item.packageName);
            formSection.appendChild(downloadBtn);

            // æ·»åŠ åˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'download-btn';
            deleteBtn.style.background = '#dc3545';
            deleteBtn.style.marginTop = '10px';
            deleteBtn.textContent = 'åˆ é™¤æ­¤è®°å½•';
            deleteBtn.onclick = () => {
                if (confirm(`ç¡®å®šè¦åˆ é™¤åŒ…å "${item.packageName}" çš„è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                    deleteFromHistory(item.packageName);
                    // å…³é—­è¯¦æƒ…è§†å›¾
                    const historyItem = container.closest('.history-item');
                    if (historyItem) {
                        historyItem.classList.remove('expanded');
                        container.classList.remove('show');
                        container.innerHTML = '';
                    }
                }
            };
            formSection.appendChild(deleteBtn);

            container.appendChild(formSection);
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory(filter = '', highlightPackage = null) {
            const history = getHistory();
            const historyList = document.getElementById('historyList');

            let filteredHistory = history;
            if (filter) {
                filteredHistory = history.filter(item =>
                    item.packageName.toLowerCase().includes(filter.toLowerCase())
                );
            }

            if (filteredHistory.length === 0) {
                historyList.innerHTML = '<div class="empty-history">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå’ŒDOMæ“ä½œï¼Œé¿å…æ¨¡æ¿å­—ç¬¦ä¸²ä¸­çš„ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            historyList.innerHTML = '';
            filteredHistory.forEach((item, index) => {
                const date = new Date(item.timestamp).toLocaleString('zh-CN');
                const escapedPackageName = escapeHtml(item.packageName);
                const escapedAlias = escapeHtml(item.alias);
                const escapedMd5 = escapeHtml(item.md5.substring(0, 30));
                const isHighlight = highlightPackage === item.packageName;
                // ä½¿ç”¨åŒ…åçš„å“ˆå¸Œä½œä¸ºIDçš„ä¸€éƒ¨åˆ†ï¼Œç¡®ä¿å”¯ä¸€æ€§
                const safePackageName = item.packageName.replace(/[^a-zA-Z0-9]/g, '_');
                const itemId = `history-item-${safePackageName}-${index}`;
                const detailId = `history-detail-${safePackageName}-${index}`;

                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${isHighlight ? 'highlight' : ''}`;
                historyItem.id = itemId;

                const header = document.createElement('div');
                header.className = 'history-header';
                header.onclick = () => toggleHistoryDetail(itemId, detailId, item.packageName);

                const info = document.createElement('div');
                info.className = 'history-info';

                const packageDiv = document.createElement('div');
                packageDiv.className = 'history-package';
                packageDiv.innerHTML = `${escapedPackageName} <span class="history-expand-icon">â–¼</span>`;

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'history-details';
                const displayAlias = item.keyAlias || item.alias || 'N/A';
                detailsDiv.textContent = `åˆ«å: ${escapeHtml(displayAlias)} | MD5: ${escapedMd5}... | åˆ›å»ºæ—¶é—´: ${date}`;

                info.appendChild(packageDiv);
                info.appendChild(detailsDiv);

                const actions = document.createElement('div');
                actions.className = 'history-actions';
                actions.onclick = (e) => e.stopPropagation();

                const viewBtn = document.createElement('button');
                viewBtn.className = 'history-btn view';
                viewBtn.textContent = 'æŸ¥çœ‹è¯¦æƒ…';
                viewBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleHistoryDetail(itemId, detailId, item.packageName);
                };

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'history-btn download';
                downloadBtn.textContent = 'ä¸‹è½½';
                downloadBtn.onclick = (e) => {
                    e.stopPropagation();
                    downloadFromHistory(item.packageName);
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'history-btn delete';
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteFromHistory(item.packageName);
                };

                actions.appendChild(viewBtn);
                actions.appendChild(downloadBtn);
                actions.appendChild(deleteBtn);

                header.appendChild(info);
                header.appendChild(actions);

                const detail = document.createElement('div');
                detail.className = 'history-detail';
                detail.id = detailId;

                historyItem.appendChild(header);
                historyItem.appendChild(detail);

                historyList.appendChild(historyItem);
            });
        }

        // åˆ‡æ¢å†å²è®°å½•è¯¦æƒ…æ˜¾ç¤º
        function toggleHistoryDetail(itemId, detailId, packageName) {
            try {
                const item = document.getElementById(itemId);
                const detail = document.getElementById(detailId);

                if (!item || !detail) {
                    console.error('æ‰¾ä¸åˆ°å…ƒç´ :', itemId, detailId);
                    return;
                }

                const history = getHistory();
                const historyItem = history.find(h => h.packageName === packageName);

                if (!historyItem) {
                    showError('æœªæ‰¾åˆ°è¯¥åŒ…åçš„è®°å½•');
                    return;
                }

                if (item.classList.contains('expanded')) {
                    // æŠ˜å 
                    item.classList.remove('expanded');
                    detail.classList.remove('show');
                    detail.innerHTML = '';
                } else {
                    // å±•å¼€
                    // å…ˆæŠ˜å å…¶ä»–é¡¹
                    document.querySelectorAll('.history-item.expanded').forEach(el => {
                        if (el.id !== itemId) {
                            el.classList.remove('expanded');
                            const otherDetail = el.querySelector('.history-detail');
                            if (otherDetail) {
                                otherDetail.classList.remove('show');
                                otherDetail.innerHTML = '';
                            }
                        }
                    });

                    item.classList.add('expanded');
                    detail.classList.add('show');
                    renderHistoryDetail(historyItem, detail);
                }
            } catch (err) {
                console.error('åˆ‡æ¢è¯¦æƒ…å¤±è´¥:', err);
                showError('å±•å¼€è¯¦æƒ…å¤±è´¥: ' + err.message);
            }
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ä»å†å²è®°å½•ä¸‹è½½
        function downloadFromHistory(packageName) {
            const history = getHistory();
            const item = history.find(h => h.packageName === packageName);
            if (!item) {
                showError('æœªæ‰¾åˆ°è¯¥åŒ…åçš„è®°å½•');
                return;
            }

            const keystoreData = new Uint8Array(item.keystoreData);
            const blob = new Blob([keystoreData], { type: 'application/x-pkcs12' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = packageName + '.jks';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ä»å†å²è®°å½•åˆ é™¤
        function deleteFromHistory(packageName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤åŒ…å "${packageName}" çš„è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ç­¾åæ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š\n- ç­¾åæ–‡ä»¶æ•°æ®\n- å¯†é’¥åˆ«åå’Œå¯†ç \n- æŒ‡çº¹ä¿¡æ¯\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            const history = getHistory();
            const filtered = history.filter(item => item.packageName !== packageName);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));

            // è·å–å½“å‰æœç´¢æ¡†çš„å€¼ï¼Œä¿æŒæœç´¢çŠ¶æ€
            const searchInput = document.getElementById('searchInput');
            renderHistory(searchInput ? searchInput.value : '');

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showSuccess(`å·²æˆåŠŸåˆ é™¤åŒ…å "${packageName}" çš„è®°å½•`);
        }

        // å¯¼å‡ºæ‰€æœ‰æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•ï¼ˆZIPæ ¼å¼ï¼‰
        async function exportAllToProject() {
            try {
                const history = getHistory();
                if (history.length === 0) {
                    showError('æ²¡æœ‰å†å²è®°å½•å¯å¯¼å‡º');
                    return;
                }

                const loading = document.getElementById('loading');
                loading.classList.add('show');

                const zip = new JSZip();
                const keystoresFolder = zip.folder('keystores');

                // æ·»åŠ æ‰€æœ‰ keystore æ–‡ä»¶
                history.forEach(item => {
                    if (item.keystoreData && item.keystoreData.length > 0) {
                        const keystoreData = new Uint8Array(item.keystoreData);
                        const fileName = item.packageName + '.jks';
                        keystoresFolder.file(fileName, keystoreData);
                    }
                });

                // å‡†å¤‡å…ƒæ•°æ®
                const exportData = history.map(item => ({
                    packageName: item.packageName,
                    keyAlias: item.keyAlias || item.alias,
                    storePassword: item.storePassword || item.password,
                    keyPassword: item.keyPassword || item.password,
                    // ä¿ç•™æ—§å­—æ®µä»¥å…¼å®¹
                    alias: item.keyAlias || item.alias,
                    password: item.storePassword || item.password,
                    md5: item.md5,
                    sha1: item.sha1,
                    sha256: item.sha256,
                    publicKey: item.publicKey,
                    timestamp: item.timestamp,
                    keystoreFile: `keystores/${item.packageName}.jks`
                }));

                // æ·»åŠ å…ƒæ•°æ® JSON æ–‡ä»¶
                const dataStr = JSON.stringify(exportData, null, 2);
                zip.file('keystore_history.json', dataStr);

                // æ·»åŠ  README æ–‡ä»¶
                const readmeContent = `# Keystore å†å²è®°å½•

æ­¤ç›®å½•åŒ…å«æ‰€æœ‰ç”Ÿæˆçš„ç­¾åæ–‡ä»¶å’Œå†å²è®°å½•ã€‚

## æ–‡ä»¶è¯´æ˜

- \`keystores/\`: åŒ…å«æ‰€æœ‰ .jks ç­¾åæ–‡ä»¶
- \`keystore_history.json\`: åŒ…å«æ‰€æœ‰ç­¾åæ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯

## ä½¿ç”¨è¯´æ˜

1. å°†æ•´ä¸ªç›®å½•è§£å‹åˆ°é¡¹ç›®æ ¹ç›®å½•
2. åœ¨ Android é¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›ç­¾åæ–‡ä»¶è¿›è¡Œåº”ç”¨ç­¾å
3. ç­¾åä¿¡æ¯ï¼ˆåˆ«åã€å¯†ç ç­‰ï¼‰è¯·æŸ¥çœ‹ \`keystore_history.json\`

## æ ¼å¼è¯´æ˜

- **.keystore å’Œ .jks çš„åŒºåˆ«ï¼š** ä¸¤è€…éƒ½æ˜¯ Java KeyStore æ ¼å¼ï¼Œ.jks æ˜¯åŸå§‹æ ¼å¼åç§°ï¼Œ.keystore æ˜¯åˆ«åã€‚åœ¨ Android å¼€å‘ä¸­å¯ä»¥äº’æ¢ä½¿ç”¨ã€‚æœ¬å·¥å…·ç”Ÿæˆçš„æ˜¯ PKCS#12 æ ¼å¼ï¼ˆå…¼å®¹ .keystore/.jksï¼‰ï¼Œé»˜è®¤ç”Ÿæˆ .jks æ–‡ä»¶ã€‚

## å¯¼å…¥å†å²è®°å½•

åœ¨å·¥å…·ä¸­ç‚¹å‡»"å¯¼å…¥å†å²"æŒ‰é’®ï¼Œé€‰æ‹© \`keystore_history.json\` æ–‡ä»¶å³å¯æ¢å¤å†å²è®°å½•ã€‚

---
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
`;
                zip.file('README.md', readmeContent);

                // ç”Ÿæˆ ZIP æ–‡ä»¶
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `keystore_project_${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                loading.classList.remove('show');
                showSuccess(`å·²å¯¼å‡º ${history.length} ä¸ªç­¾åæ–‡ä»¶åˆ° ZIP åŒ…ï¼è§£å‹åæ”¾åˆ°é¡¹ç›®æ ¹ç›®å½•å³å¯ã€‚`);
            } catch (err) {
                console.error('å¯¼å‡ºå¤±è´¥:', err);
                showError('å¯¼å‡ºå¤±è´¥: ' + err.message);
                document.getElementById('loading').classList.remove('show');
            }
        }

        // å¯¼å‡ºå†å²è®°å½•åˆ°æœ¬åœ°æ–‡ä»¶ï¼ˆä»…å…ƒæ•°æ®ï¼‰
        async function exportHistoryToFile() {
            try {
                const history = getHistory();
                if (history.length === 0) {
                    showError('æ²¡æœ‰å†å²è®°å½•å¯å¯¼å‡º');
                    return;
                }

                // å‡†å¤‡å¯¼å‡ºæ•°æ®ï¼ˆä¸åŒ…å«keystoreäºŒè¿›åˆ¶æ•°æ®ï¼Œåªå¯¼å‡ºå…ƒæ•°æ®ï¼‰
                const exportData = history.map(item => ({
                    packageName: item.packageName,
                    keyAlias: item.keyAlias || item.alias,
                    storePassword: item.storePassword || item.password,
                    keyPassword: item.keyPassword || item.password,
                    // ä¿ç•™æ—§å­—æ®µä»¥å…¼å®¹
                    alias: item.keyAlias || item.alias,
                    password: item.storePassword || item.password,
                    md5: item.md5,
                    sha1: item.sha1,
                    sha256: item.sha256,
                    publicKey: item.publicKey,
                    timestamp: item.timestamp
                }));

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `keystore_history_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showSuccess('å†å²è®°å½•å·²å¯¼å‡ºæˆåŠŸï¼');
            } catch (err) {
                console.error('å¯¼å‡ºå¤±è´¥:', err);
                showError('å¯¼å‡ºå¤±è´¥: ' + err.message);
            }
        }

        // ä»æ–‡ä»¶å¯¼å…¥å†å²è®°å½•
        function importHistoryFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.zip';
            input.onchange = async function (e) {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    if (file.name.endsWith('.zip')) {
                        // å¤„ç† ZIP æ–‡ä»¶
                        const loading = document.getElementById('loading');
                        loading.classList.add('show');

                        const arrayBuffer = await file.arrayBuffer();
                        const zip = await JSZip.loadAsync(arrayBuffer);

                        // è¯»å–å…ƒæ•°æ®æ–‡ä»¶
                        const historyFile = zip.file('keystore_history.json');
                        if (!historyFile) {
                            showError('ZIP æ–‡ä»¶ä¸­æœªæ‰¾åˆ° keystore_history.json');
                            loading.classList.remove('show');
                            return;
                        }

                        const historyContent = await historyFile.async('string');
                        const importData = JSON.parse(historyContent);
                        const currentHistory = getHistory();

                        // åˆå¹¶å†å²è®°å½•ï¼ˆä»¥åŒ…åä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
                        const mergedHistory = [...currentHistory];
                        let importedCount = 0;

                        for (const importItem of importData) {
                            const existingIndex = mergedHistory.findIndex(item => item.packageName === importItem.packageName);

                            // å°è¯•ä» ZIP ä¸­è¯»å– keystore æ–‡ä»¶
                            let keystoreData = [];
                            if (importItem.keystoreFile) {
                                const keystoreFile = zip.file(importItem.keystoreFile);
                                if (keystoreFile) {
                                    const keystoreArrayBuffer = await keystoreFile.async('arraybuffer');
                                    keystoreData = Array.from(new Uint8Array(keystoreArrayBuffer));
                                }
                            }

                            if (existingIndex >= 0) {
                                // å¦‚æœå·²å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦è¦†ç›–
                                if (confirm(`åŒ…å "${importItem.packageName}" å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                                    mergedHistory[existingIndex] = {
                                        ...importItem,
                                        // å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ²¡æœ‰æ–°å­—æ®µï¼Œä½¿ç”¨æ—§å­—æ®µ
                                        keyAlias: importItem.keyAlias || importItem.alias,
                                        storePassword: importItem.storePassword || importItem.password,
                                        keyPassword: importItem.keyPassword || importItem.password,
                                        keystoreData: keystoreData.length > 0 ? keystoreData : mergedHistory[existingIndex].keystoreData
                                    };
                                    importedCount++;
                                }
                            } else {
                                // æ–°è®°å½•
                                mergedHistory.push({
                                    ...importItem,
                                    // å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ²¡æœ‰æ–°å­—æ®µï¼Œä½¿ç”¨æ—§å­—æ®µ
                                    keyAlias: importItem.keyAlias || importItem.alias,
                                    storePassword: importItem.storePassword || importItem.password,
                                    keyPassword: importItem.keyPassword || importItem.password,
                                    keystoreData: keystoreData
                                });
                                importedCount++;
                            }
                        }

                        localStorage.setItem(STORAGE_KEY, JSON.stringify(mergedHistory));
                        renderHistory();
                        loading.classList.remove('show');
                        showSuccess(`å†å²è®°å½•å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${importedCount} æ¡è®°å½•ã€‚`);
                    } else {
                        // å¤„ç† JSON æ–‡ä»¶
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            try {
                                const importData = JSON.parse(e.target.result);
                                const currentHistory = getHistory();

                                // åˆå¹¶å†å²è®°å½•ï¼ˆä»¥åŒ…åä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
                                const mergedHistory = [...currentHistory];
                                importData.forEach(importItem => {
                                    const existingIndex = mergedHistory.findIndex(item => item.packageName === importItem.packageName);
                                    if (existingIndex >= 0) {
                                        // å¦‚æœå·²å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦è¦†ç›–
                                        if (confirm(`åŒ…å "${importItem.packageName}" å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                                            // ä¿ç•™åŸæœ‰çš„keystoreæ•°æ®
                                            mergedHistory[existingIndex] = {
                                                ...importItem,
                                                // å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ²¡æœ‰æ–°å­—æ®µï¼Œä½¿ç”¨æ—§å­—æ®µ
                                                keyAlias: importItem.keyAlias || importItem.alias,
                                                storePassword: importItem.storePassword || importItem.password,
                                                keyPassword: importItem.keyPassword || importItem.password,
                                                keystoreData: mergedHistory[existingIndex].keystoreData
                                            };
                                        }
                                    } else {
                                        // æ–°è®°å½•ï¼Œä½†æ²¡æœ‰keystoreæ•°æ®ï¼Œæç¤ºç”¨æˆ·
                                        if (confirm(`åŒ…å "${importItem.packageName}" çš„ç­¾åæ–‡ä»¶æ•°æ®ç¼ºå¤±ï¼Œå°†åªä¿å­˜å…ƒæ•°æ®ä¿¡æ¯ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                                            mergedHistory.push({
                                                ...importItem,
                                                // å…¼å®¹æ—§æ ¼å¼ï¼šå¦‚æœæ²¡æœ‰æ–°å­—æ®µï¼Œä½¿ç”¨æ—§å­—æ®µ
                                                keyAlias: importItem.keyAlias || importItem.alias,
                                                storePassword: importItem.storePassword || importItem.password,
                                                keyPassword: importItem.keyPassword || importItem.password,
                                                keystoreData: []
                                            });
                                        }
                                    }
                                });

                                localStorage.setItem(STORAGE_KEY, JSON.stringify(mergedHistory));
                                renderHistory();
                                showSuccess('å†å²è®°å½•å¯¼å…¥æˆåŠŸï¼');
                            } catch (err) {
                                console.error('å¯¼å…¥å¤±è´¥:', err);
                                showError('å¯¼å…¥å¤±è´¥: ' + err.message);
                            }
                        };
                        reader.readAsText(file);
                    }
                } catch (err) {
                    console.error('å¯¼å…¥å¤±è´¥:', err);
                    showError('å¯¼å…¥å¤±è´¥: ' + err.message);
                    document.getElementById('loading').classList.remove('show');
                }
            };
            input.click();
        }

        // è¿‡æ»¤å†å²è®°å½•
        function filterHistory() {
            const searchInput = document.getElementById('searchInput');
            renderHistory(searchInput.value);
        }

        // æ£€æŸ¥å†å²è®°å½•ä¸­æ˜¯å¦å·²å­˜åœ¨
        function checkExistingHistory(packageName) {
            const history = getHistory();
            const existing = history.find(item => item.packageName === packageName);
            return existing;
        }

        async function generateKeystore() {
            const packageName = document.getElementById('packageName').value.trim();
            // åˆ«åç›´æ¥ä½¿ç”¨åŒ…å
            const keyAlias = packageName;
            const storePassword = document.getElementById('storePassword').value;
            // storePassword å’Œ keyPassword ä½¿ç”¨ç›¸åŒçš„å€¼
            const keyPassword = storePassword;
            const validity = parseInt(document.getElementById('validity').value) || 100;
            const name = document.getElementById('name').value.trim() || 'CN';
            const org = document.getElementById('org').value.trim() || 'OU';
            const orgUnit = document.getElementById('orgUnit').value.trim() || 'O';
            const city = document.getElementById('city').value.trim() || 'L';
            const state = document.getElementById('state').value.trim() || 'ST';
            const country = document.getElementById('country').value.trim() || 'CN';

            // éªŒè¯è¾“å…¥
            if (!packageName) {
                showError('è¯·è¾“å…¥AndroidåŒ…å');
                return;
            }

            // æ›´æ–°åˆ«åè¾“å…¥æ¡†æ˜¾ç¤º
            document.getElementById('keyAlias').value = keyAlias;

            if (!storePassword || storePassword.length < 6) {
                showError('å¯†é’¥åº“å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
                return;
            }

            // æ£€æŸ¥å†å²è®°å½•æ˜¯å¦å­˜åœ¨
            const existing = checkExistingHistory(packageName);
            if (existing) {
                if (!confirm(`åŒ…å "${packageName}" å·²å­˜åœ¨äºå†å²è®°å½•ä¸­ï¼Œæ˜¯å¦é‡æ–°ç”Ÿæˆå¹¶è¦†ç›–ï¼Ÿ\n\nå¦‚æœé€‰æ‹©"å–æ¶ˆ"ï¼Œå°†ç›´æ¥æ˜¾ç¤ºå†å²è®°å½•ä¸­çš„ä¿¡æ¯ã€‚`)) {
                    // ç”¨æˆ·é€‰æ‹©å–æ¶ˆï¼Œç›´æ¥æ˜¾ç¤ºå†å²è®°å½•
                    renderHistory('', packageName);
                    // æ‰¾åˆ°å¯¹åº”çš„å†å²é¡¹å¹¶å±•å¼€
                    setTimeout(() => {
                        const historyItems = document.querySelectorAll('.history-item.highlight');
                        historyItems.forEach((item) => {
                            const detailId = item.querySelector('.history-detail')?.id;
                            if (detailId) {
                                toggleHistoryDetail(item.id, detailId, packageName);
                                // æ»šåŠ¨åˆ°è¯¥é¡¹
                                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        });
                    }, 200);
                    return;
                }
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            const generateBtn = document.getElementById('generateBtn');

            loading.classList.add('show');
            error.classList.remove('show');
            success.classList.remove('show');
            generateBtn.disabled = true;

            try {
                // ä½¿ç”¨åŒ…åç”Ÿæˆç¡®å®šæ€§å¯†é’¥å¯¹ï¼ˆç›¸åŒåŒ…åç”Ÿæˆç›¸åŒå¯†é’¥ï¼‰
                const keyPair = generateDeterministicKeyPair(packageName, 2048);
                const publicKey = keyPair.publicKey;
                const privateKey = keyPair.privateKey;

                // åˆ›å»ºè¯ä¹¦
                const cert = forge.pki.createCertificate();
                cert.publicKey = publicKey;
                cert.serialNumber = '01';
                cert.validity.notBefore = new Date();
                cert.validity.notAfter = new Date();
                cert.validity.notAfter.setFullYear(cert.validity.notAfter.getFullYear() + validity);

                // è®¾ç½®è¯ä¹¦å±æ€§
                const attrs = [
                    { name: 'countryName', value: country },
                    { name: 'stateOrProvinceName', value: state },
                    { name: 'localityName', value: city },
                    { name: 'organizationName', value: orgUnit },
                    { name: 'organizationalUnitName', value: org },
                    { name: 'commonName', value: name }
                ];

                cert.setSubject(attrs);
                cert.setIssuer(attrs);

                // è®¾ç½®æ‰©å±•
                cert.setExtensions([
                    {
                        name: 'basicConstraints',
                        cA: true
                    },
                    {
                        name: 'keyUsage',
                        keyCertSign: true,
                        digitalSignature: true,
                        nonRepudiation: true,
                        keyEncipherment: true,
                        dataEncipherment: true
                    }
                ]);

                // ä½¿ç”¨ç§é’¥ç­¾åè¯ä¹¦
                cert.sign(privateKey, forge.md.sha256.create());

                // åˆ›å»º PKCS#12 keystore
                // ä½¿ç”¨æ­£ç¡®çš„ forge API åˆ›å»º PKCS#12 æ ¼å¼çš„ keystore
                // æ³¨æ„ï¼šPKCS#12 æ ¼å¼ä¸­ï¼ŒstorePassword å’Œ keyPassword é€šå¸¸ç›¸åŒ
                // ä½† Android å·¥å…·æ”¯æŒä¸åŒçš„å¯†ç ï¼Œè¿™é‡Œä½¿ç”¨ storePassword ä½œä¸ºä¸»å¯†ç 
                // ç”Ÿæˆ localKeyIdï¼ˆä» keyAlias çš„ SHA1 å“ˆå¸Œï¼‰
                const keyAliasHash = CryptoJS.SHA1(keyAlias).toString();
                const localKeyIdBytes = forge.util.hexToBytes(keyAliasHash);

                const p12Asn1 = forge.pkcs12.toPkcs12Asn1(
                    privateKey,
                    [cert],
                    storePassword, // å¯†é’¥åº“å¯†ç 
                    {
                        algorithm: '3des',
                        friendlyName: keyAlias, // è®¾ç½®å¯†é’¥åˆ«å
                        localKeyId: localKeyIdBytes, // ç”Ÿæˆæœ¬åœ°å¯†é’¥ID
                        generateLocalKeyId: true
                    }
                );

                // è½¬æ¢ä¸ºäºŒè¿›åˆ¶
                const p12Der = forge.asn1.toDer(p12Asn1).getBytes();
                const p12Buffer = new Uint8Array(p12Der.length);
                for (let i = 0; i < p12Der.length; i++) {
                    p12Buffer[i] = p12Der.charCodeAt(i);
                }

                generatedKeystore = p12Buffer;
                keystoreFileName = packageName + '.jks';

                // æå–è¯ä¹¦ä¿¡æ¯
                const certDer = forge.pki.certificateToAsn1(cert);
                const certAsn1 = forge.asn1.toDer(certDer).getBytes();
                const certBuffer = new Uint8Array(certAsn1.length);
                for (let i = 0; i < certAsn1.length; i++) {
                    certBuffer[i] = certAsn1.charCodeAt(i);
                }

                // è®¡ç®—æŒ‡çº¹
                const md5Hash = CryptoJS.MD5(CryptoJS.lib.WordArray.create(certBuffer));
                const sha1Hash = CryptoJS.SHA1(CryptoJS.lib.WordArray.create(certBuffer));
                const sha256Hash = CryptoJS.SHA256(CryptoJS.lib.WordArray.create(certBuffer));

                // æ ¼å¼åŒ–MD5
                const md5Formatted = formatHash(md5Hash.toString());

                // æ ¼å¼åŒ–SHA1
                const sha1Formatted = formatHash(sha1Hash.toString());

                // æ ¼å¼åŒ–SHA256
                const sha256Formatted = formatHash(sha256Hash.toString());

                // æå–RSAå…¬é’¥çš„modulus
                const publicKeyModulus = publicKey.n.toString();

                // ä¿å­˜åˆ°å†å²è®°å½•
                saveHistory(packageName, p12Buffer, keyAlias, storePassword, keyPassword, md5Formatted, sha1Formatted, sha256Formatted, publicKeyModulus);

                // åˆ·æ–°å†å²è®°å½•å¹¶é«˜äº®æ˜¾ç¤ºæ–°ç”Ÿæˆçš„é¡¹
                renderHistory('', packageName);

                // è‡ªåŠ¨å±•å¼€æ–°ç”Ÿæˆçš„é¡¹
                setTimeout(() => {
                    const historyItems = document.querySelectorAll('.history-item.highlight');
                    historyItems.forEach((item) => {
                        const detailId = item.querySelector('.history-detail')?.id;
                        if (detailId) {
                            toggleHistoryDetail(item.id, detailId, packageName);
                            // æ»šåŠ¨åˆ°è¯¥é¡¹
                            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                }, 200);

                success.classList.add('show');
                success.textContent = 'ç­¾åæ–‡ä»¶ç”ŸæˆæˆåŠŸï¼å·²ä¿å­˜åˆ°å†å²è®°å½•ã€‚';
            } catch (err) {
                console.error('ç”Ÿæˆå¤±è´¥:', err);
                showError('ç”Ÿæˆå¤±è´¥: ' + err.message);
            } finally {
                loading.classList.remove('show');
                generateBtn.disabled = false;
            }
        }

        // æ ¼å¼åŒ–å“ˆå¸Œå€¼ç”¨äºæ˜¾ç¤ºï¼ˆä¸¤ç§æ ¼å¼ï¼‰
        function formatHashForDisplay(hashString) {
            if (!hashString) return '-';
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç©ºæ ¼æˆ–å†’å·
            const cleanHash = hashString.replace(/[\s:]/g, '').toUpperCase();
            const spaceFormat = cleanHash.match(/.{1,2}/g).join(' ');
            const colonFormat = cleanHash.match(/.{1,2}/g).join(':');
            return `ç©ºæ ¼æ ·å¼: ${spaceFormat}\nå†’å·æ ·å¼: ${colonFormat}`;
        }

        // ä»å­—ç¬¦ä¸²æ ¼å¼åŒ–å“ˆå¸Œå€¼ï¼ˆç”¨äºå¤åˆ¶ï¼‰
        function formatHashFromString(hashString, style) {
            if (!hashString) return '';
            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ç©ºæ ¼æˆ–å†’å·
            const cleanHash = hashString.replace(/[\s:]/g, '').toUpperCase();
            const separator = style === 'colon' ? ':' : ' ';
            return cleanHash.match(/.{1,2}/g).join(separator);
        }

        function formatHash(hashString) {
            // å°†åå…­è¿›åˆ¶å­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™ï¼Œæ¯ä¸¤ä¸ªå­—ç¬¦ä¸€ç»„ï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰
            return hashString.toUpperCase().match(/.{1,2}/g).join(' ');
        }

        function downloadKeystore() {
            if (!generatedKeystore) {
                showError('è¯·å…ˆç”Ÿæˆç­¾åæ–‡ä»¶');
                return;
            }

            const blob = new Blob([generatedKeystore], { type: 'application/x-pkcs12' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = keystoreFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.classList.add('show');
        }

        function showSuccess(message) {
            const success = document.getElementById('success');
            success.textContent = message;
            success.classList.add('show');
        }

        // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“å†å²è®°å½•
        window.addEventListener('DOMContentLoaded', () => {
            renderHistory();

            // åŒ…åè¾“å…¥æ¡†å®Œæˆè¾“å…¥åè‡ªåŠ¨æ›´æ–°åˆ«å
            const packageNameInput = document.getElementById('packageName');
            const keyAliasInput = document.getElementById('keyAlias');

            if (packageNameInput && keyAliasInput) {
                // åŒ…åè¾“å…¥æ¡†è¾“å…¥æ—¶è‡ªåŠ¨æ›´æ–°åˆ«å
                packageNameInput.addEventListener('input', function () {
                    const packageName = this.value.trim();
                    keyAliasInput.value = packageName;
                });

                // åŒ…åè¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶æ£€æŸ¥å†å²è®°å½•
                packageNameInput.addEventListener('blur', function () {
                    const packageName = this.value.trim();
                    if (packageName) {
                        const existing = checkExistingHistory(packageName);
                        if (existing) {
                            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                            const infoBox = document.querySelector('.info-box');
                            if (infoBox) {
                                const originalText = infoBox.innerHTML;
                                infoBox.innerHTML = `<strong>æç¤ºï¼š</strong>åŒ…å "${packageName}" å·²å­˜åœ¨äºå†å²è®°å½•ä¸­ã€‚ç‚¹å‡»"ç”Ÿæˆç­¾åæ–‡ä»¶"æ—¶ä¼šæç¤ºæ˜¯å¦è¦†ç›–ï¼Œæˆ–é€‰æ‹©"å–æ¶ˆ"ç›´æ¥æŸ¥çœ‹å†å²è®°å½•ã€‚`;
                                infoBox.style.background = '#fff3cd';
                                infoBox.style.borderLeftColor = '#ffc107';

                                // 3ç§’åæ¢å¤åŸæç¤º
                                setTimeout(() => {
                                    infoBox.innerHTML = originalText;
                                    infoBox.style.background = '';
                                    infoBox.style.borderLeftColor = '';
                                }, 5000);
                            }
                        }
                    }
                });
            }
        });

        // å¤åˆ¶åŠŸèƒ½
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('copy-btn')) {
                let value = '';

                // æ£€æŸ¥æ˜¯å¦æœ‰ data-copy å±æ€§ï¼ˆå†å²è®°å½•è¯¦æƒ…ä¸­çš„å¤åˆ¶æŒ‰é’®ï¼‰
                const copyData = e.target.getAttribute('data-copy');
                if (copyData) {
                    value = copyData;
                } else {
                    // åŸæœ‰çš„é€šè¿‡ target ID å¤åˆ¶çš„æ–¹å¼
                    const targetId = e.target.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        value = targetElement.textContent.trim();
                    }
                }

                if (value && value !== '-') {
                    navigator.clipboard.writeText(value).then(() => {
                        const originalText = e.target.textContent;
                        e.target.textContent = 'å·²å¤åˆ¶!';
                        e.target.style.background = '#28a745';
                        setTimeout(() => {
                            e.target.textContent = originalText;
                            e.target.style.background = '';
                        }, 2000);
                    }).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        e.target.textContent = 'å¤åˆ¶å¤±è´¥';
                        setTimeout(() => {
                            e.target.textContent = 'å¤åˆ¶';
                        }, 2000);
                    });
                }
            }
        });

        // å›è½¦é”®æäº¤
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                const form = e.target.closest('.form-section');
                if (form) {
                    generateKeystore();
                }
            }
        });
    </script>
    <script src="../../assets/js/tools.js"></script>
    <script src="../../assets/js/themes.js"></script>
    <script src="../../assets/js/theme-ui.js"></script>
</body>

</html>