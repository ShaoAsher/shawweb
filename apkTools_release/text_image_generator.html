<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—å›¾ç‰‡ç”Ÿæˆå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .home-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            text-decoration: none;
            font-size: 20px;
            transition: all .3s;
            z-index: 10;
        }

        .home-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .form-section h2 {
            font-size: 20px;
            color: #495057;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            color: #6c757d;
            margin-top: 5px;
            font-size: 12px;
        }

        .color-options {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .color-option {
            flex: 1;
            min-width: 120px;
        }

        .color-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .color-option input[type="radio"] {
            width: auto;
            margin: 0;
        }

        .color-picker-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .color-picker-wrapper {
            flex: 1;
            min-width: 150px;
        }

        .color-picker-wrapper label {
            display: block;
            margin-bottom: 8px;
        }

        .color-picker-input {
            width: 100%;
            height: 50px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
        }

        .gradient-picker {
            display: none;
        }

        .gradient-picker.show {
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 35px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .preview-section {
            margin-top: 30px;
            text-align: center;
        }

        .preview-section h2 {
            font-size: 20px;
            color: #495057;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            text-align: left;
        }

        .preview-canvas-wrapper {
            display: inline-block;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 20px;
        }

        .preview-info {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #0c5460;
            text-align: left;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
            width: 100%;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }

        .preset-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 6px;
            background: #fff;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            text-align: center;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .preset-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .preset-card.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .preset-label {
            margin-top: 6px;
            font-size: 10px;
            color: #495057;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preset-canvas {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1;
            display: block;
        }

        .error {
            background: #fee;
            border-left-color: #dc3545;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .success.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #previewCanvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="./index.html" class="home-btn" title="è¿”å›é¦–é¡µ">ğŸ </a>
            <h1>âœï¸ æ–‡å­—å›¾ç‰‡ç”Ÿæˆå·¥å…·</h1>
            <p>è¾“å…¥æ–‡å­—å’ŒèƒŒæ™¯é¢œè‰²ï¼Œç”Ÿæˆ 1024Ã—1024 çº¯æ–‡å­—å›¾ç‰‡ï¼ˆä½äº 50KBï¼‰</p>
        </div>
        <div class="content">
            <div class="form-section">
                <h2>è¾“å…¥é…ç½®</h2>
                <div class="form-group">
                    <label for="textInput">æ–‡å­—å†…å®¹ *</label>
                    <input type="text" id="textInput" placeholder="è¾“å…¥1-4ä¸ªå­—ç¬¦" maxlength="4" required>
                    <small>æœ€å¤šè¾“å…¥4ä¸ªå­—ç¬¦ï¼Œæ–‡å­—å°†å±…ä¸­æ˜¾ç¤º</small>
                </div>
                <div class="form-group">
                    <label>èƒŒæ™¯ç±»å‹</label>
                    <div class="color-options">
                        <div class="color-option">
                            <label>
                                <input type="radio" name="bgType" value="solid" checked>
                                <span>å•è‰²</span>
                            </label>
                        </div>
                        <div class="color-option">
                            <label>
                                <input type="radio" name="bgType" value="gradient">
                                <span>æ¸å˜è‰²</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="color-picker-group">
                        <div class="color-picker-wrapper" id="solidColorWrapper">
                            <label for="solidColor">å•è‰²é€‰æ‹©</label>
                            <input type="color" id="solidColor" value="#ffff00" class="color-picker-input">
                        </div>
                        <div class="color-picker-wrapper gradient-picker" id="gradientColorWrapper">
                            <label for="gradientColor1">æ¸å˜è‰² - èµ·å§‹é¢œè‰²</label>
                            <input type="color" id="gradientColor1" value="#ff0000" class="color-picker-input">
                        </div>
                        <div class="color-picker-wrapper gradient-picker" id="gradientColorWrapper2">
                            <label for="gradientColor2">æ¸å˜è‰² - ç»“æŸé¢œè‰²</label>
                            <input type="color" id="gradientColor2" value="#ff8800" class="color-picker-input">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>å•è‰²é¢„è®¾</label>
                    <div class="preset-grid" id="solidBgPresetContainer"></div>
                </div>
                <div class="form-group">
                    <label>æ¸å˜é¢„è®¾</label>
                    <div class="preset-grid" id="gradientBgPresetContainer"></div>
                </div>
            </div>

            <div class="form-section">
                <h2>é£æ ¼é¢„è®¾</h2>
                <div class="preset-grid" id="presetPreviewContainer"></div>
            </div>
            <button class="btn" id="generateBtn" onclick="generateImage()">ç”Ÿæˆå›¾ç‰‡</button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</div>
            </div>

            <div class="error" id="error"></div>
            <div class="success" id="success"></div>

            <div class="preview-section" id="previewSection" style="display: none;">
                <h2>é¢„è§ˆä¸ä¸‹è½½</h2>
                <div class="preview-info">
                    <strong>å›¾ç‰‡ä¿¡æ¯ï¼š</strong>
                    <span id="imageInfo">-</span>
                </div>
                <div class="preview-canvas-wrapper">
                    <canvas id="previewCanvas" width="1024" height="1024"></canvas>
                </div>
                <button class="download-btn" id="downloadBtn" onclick="downloadImage()">ä¸‹è½½å›¾ç‰‡</button>
            </div>
        </div>
    </div>

    <script>
        let currentImageBlob = null;
        let currentImageFormat = 'png';

        // åˆ‡æ¢èƒŒæ™¯ç±»å‹æ˜¾ç¤º
        document.querySelectorAll('input[name="bgType"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const bgType = this.value;
                const solidWrapper = document.getElementById('solidColorWrapper');
                const gradientWrapper = document.getElementById('gradientColorWrapper');
                const gradientWrapper2 = document.getElementById('gradientColorWrapper2');

                if (bgType === 'solid') {
                    solidWrapper.style.display = 'block';
                    gradientWrapper.classList.remove('show');
                    gradientWrapper2.classList.remove('show');
                } else {
                    solidWrapper.style.display = 'none';
                    gradientWrapper.classList.add('show');
                    gradientWrapper2.classList.add('show');
                }
            });
        });

        // åˆå§‹åŒ–æ˜¾ç¤º
        document.getElementById('gradientColorWrapper').classList.remove('show');
        document.getElementById('gradientColorWrapper2').classList.remove('show');

        function generateImage() {
            const textInput = document.getElementById('textInput').value.trim();
            const bgType = document.querySelector('input[name="bgType"]:checked').value;

            // éªŒè¯è¾“å…¥
            if (!textInput || textInput.length === 0) {
                showError('è¯·è¾“å…¥æ–‡å­—å†…å®¹');
                return;
            }

            if (textInput.length > 4) {
                showError('æ–‡å­—å†…å®¹ä¸èƒ½è¶…è¿‡4ä¸ªå­—ç¬¦');
                return;
            }

            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            const generateBtn = document.getElementById('generateBtn');

            loading.classList.add('show');
            error.classList.remove('show');
            success.classList.remove('show');
            generateBtn.disabled = true;

            try {
                // åˆ›å»º canvas
                const canvas = document.getElementById('previewCanvas');
                const ctx = canvas.getContext('2d');
                const size = 1024;
                canvas.width = size;
                canvas.height = size;

                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, size, size);

                // ç»˜åˆ¶èƒŒæ™¯
                if (bgType === 'solid') {
                    const solidColor = document.getElementById('solidColor').value;
                    ctx.fillStyle = solidColor;
                    ctx.fillRect(0, 0, size, size);
                } else {
                    // æ¸å˜è‰²
                    const color1 = document.getElementById('gradientColor1').value;
                    const color2 = document.getElementById('gradientColor2').value;
                    const gradient = ctx.createLinearGradient(0, 0, size, size);
                    gradient.addColorStop(0, color1);
                    gradient.addColorStop(1, color2);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, size, size);
                }

                // ç»˜åˆ¶æ–‡å­—ï¼ˆä¼˜åŒ–å¸ƒå±€å’Œæ ·å¼ï¼‰
                const styleConfig = getStyleConfig();
                drawTextWithLayout(ctx, textInput, size, styleConfig);

                // è½¬æ¢ä¸ºå›¾ç‰‡å¹¶å‹ç¼©åˆ°50KBä»¥ä¸‹
                compressImage(canvas).then(result => {
                    currentImageBlob = result.blob;
                    currentImageFormat = result.format || 'png';

                    // æ›´æ–°é¢„è§ˆ
                    const img = new Image();
                    img.onload = function () {
                        const previewCanvas = document.getElementById('previewCanvas');
                        const previewCtx = previewCanvas.getContext('2d');
                        previewCtx.clearRect(0, 0, 1024, 1024);
                        previewCtx.drawImage(img, 0, 0, 1024, 1024);

                        // æ˜¾ç¤ºå›¾ç‰‡ä¿¡æ¯
                        const fileSizeKB = (result.blob.size / 1024).toFixed(2);
                        const formatUpper = currentImageFormat.toUpperCase();
                        document.getElementById('imageInfo').textContent =
                            `å°ºå¯¸: 1024Ã—1024 åƒç´  | æ–‡ä»¶å¤§å°: ${fileSizeKB} KB | æ ¼å¼: ${formatUpper}`;

                        document.getElementById('previewSection').style.display = 'block';
                        loading.classList.remove('show');
                        success.classList.add('show');
                        success.textContent = `å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼æ–‡ä»¶å¤§å°: ${fileSizeKB} KB`;
                        generateBtn.disabled = false;

                        // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
                        document.getElementById('previewSection').scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest'
                        });
                    };
                    img.src = URL.createObjectURL(result.blob);
                }).catch(err => {
                    console.error('å‹ç¼©å¤±è´¥:', err);
                    showError('å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ' + err.message);
                    loading.classList.remove('show');
                    generateBtn.disabled = false;
                });
            } catch (err) {
                console.error('ç”Ÿæˆå¤±è´¥:', err);
                showError('ç”Ÿæˆå¤±è´¥: ' + err.message);
                loading.classList.remove('show');
                generateBtn.disabled = false;
            }
        }

        function compressImage(canvas) {
            return new Promise((resolve, reject) => {
                const targetSizeKB = 50;
                const targetSizeBytes = targetSizeKB * 1024;

                // å…ˆå°è¯• PNG
                canvas.toBlob((pngBlob) => {
                    if (!pngBlob) {
                        reject(new Error('æ— æ³•ç”Ÿæˆå›¾ç‰‡'));
                        return;
                    }

                    // å¦‚æœ PNG å·²ç»å°äºç›®æ ‡å¤§å°ï¼Œç›´æ¥è¿”å›
                    if (pngBlob.size <= targetSizeBytes) {
                        resolve({ blob: pngBlob, format: 'png' });
                        return;
                    }

                    // PNG å¤ªå¤§ï¼Œè½¬æ¢ä¸º JPEG
                    const jpegCanvas = document.createElement('canvas');
                    jpegCanvas.width = canvas.width;
                    jpegCanvas.height = canvas.height;
                    const jpegCtx = jpegCanvas.getContext('2d');

                    // ç›´æ¥ç»˜åˆ¶åŸ canvasï¼ˆå·²ç»æœ‰èƒŒæ™¯å’Œæ–‡å­—ï¼‰
                    jpegCtx.drawImage(canvas, 0, 0);

                    // å°è¯•ä¸åŒçš„ JPEG è´¨é‡
                    let quality = 0.9;
                    const minQuality = 0.3;
                    const step = 0.05;

                    function tryJPEG() {
                        jpegCanvas.toBlob((jpegBlob) => {
                            if (!jpegBlob) {
                                resolve({ blob: pngBlob, format: 'png' }); // å¦‚æœ JPEG ç”Ÿæˆå¤±è´¥ï¼Œè¿”å› PNG
                                return;
                            }

                            // å¦‚æœ JPEG å¤§å°åˆé€‚ï¼Œæˆ–è€…è´¨é‡å·²ç»é™åˆ°æœ€ä½ï¼Œè¿”å›ç»“æœ
                            if (jpegBlob.size <= targetSizeBytes || quality <= minQuality) {
                                resolve({ blob: jpegBlob, format: 'jpeg' });
                                return;
                            }

                            // é™ä½è´¨é‡ç»§ç»­å°è¯•
                            quality -= step;
                            tryJPEG();
                        }, 'image/jpeg', quality);
                    }

                    tryJPEG();
                }, 'image/png');
            });
        }

        function downloadImage() {
            if (!currentImageBlob) {
                showError('è¯·å…ˆç”Ÿæˆå›¾ç‰‡');
                return;
            }

            const textInput = document.getElementById('textInput').value.trim() || 'text';
            const url = URL.createObjectURL(currentImageBlob);
            const a = document.createElement('a');
            a.href = url;
            const extension = currentImageFormat === 'jpeg' ? 'jpg' : 'png';
            a.download = `${textInput}_${Date.now()}.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showSuccess('å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼');
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.classList.add('show');
        }

        function showSuccess(message) {
            const success = document.getElementById('success');
            success.textContent = message;
            success.classList.add('show');
            setTimeout(() => {
                success.classList.remove('show');
            }, 3000);
        }

        // å›è½¦é”®ç”Ÿæˆ
        document.getElementById('textInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                generateImage();
            }
        });

        const ALL_PRESETS = ['neon', 'metal', 'glass', 'bold-stroke', 'retro', 'vivid', 'glow', 'plastic'];
        let currentPreset = 'neon';
        function setSelectedPreset(preset) {
            currentPreset = preset;
            const cards = document.querySelectorAll('.preset-card');
            cards.forEach(card => {
                const p = card.getAttribute('data-preset');
                if (p === preset) card.classList.add('selected');
                else card.classList.remove('selected');
            });
        }

        function renderPresetPreviewCard(preset) {
            const container = document.getElementById('presetPreviewContainer');
            const card = document.createElement('div');
            card.className = 'preset-card';
            card.setAttribute('data-preset', preset);
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            canvas.className = 'preset-canvas';
            const label = document.createElement('div');
            label.className = 'preset-label';
            const labelMap = {
                'neon': 'éœ“è™¹ç¯',
                'metal': 'é‡‘å±è´¨æ„Ÿ',
                'glass': 'ç»ç’ƒæ€',
                'bold-stroke': 'åšæè¾¹',
                'retro': 'å¤å¤å°åˆ·',
                'vivid': 'ç‚«å½©æ¸å˜',
                'glow': 'å¼ºå‘å…‰',
                'plastic': 'ç«‹ä½“å¡‘æ–™'
            };
            label.textContent = labelMap[preset] || preset;
            card.appendChild(canvas);
            card.appendChild(label);
            container.appendChild(card);
            card.addEventListener('click', () => {
                setSelectedPreset(preset);
            });
            renderPresetCanvas(canvas, preset);
        }

        function renderPresetCanvas(canvas, preset) {
            const ctx = canvas.getContext('2d');
            const size = Math.min(canvas.width, canvas.height);
            const cfg = getPresetStyleConfig(preset);
            const previewCfg = Object.assign({}, cfg, { canvasPadding: 16 });
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const bg = ctx.createLinearGradient(0, 0, size, size);
            bg.addColorStop(0, '#f7f7f7');
            bg.addColorStop(1, '#e9ecef');
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const sampleText = 'Aa';
            drawTextWithLayout(ctx, sampleText, size, previewCfg);
        }

        function renderAllPresetPreviews() {
            const container = document.getElementById('presetPreviewContainer');
            container.innerHTML = '';
            ALL_PRESETS.forEach(p => renderPresetPreviewCard(p));
            setSelectedPreset(currentPreset);
        }

        renderAllPresetPreviews();

        const SOLID_BG_PRESETS = [
            { id: 'soft-blue', label: 'æŸ”å’Œè“', color: '#4A90E2' },
            { id: 'mint', label: 'è–„è·ç»¿', color: '#6FCF97' },
            { id: 'peach', label: 'èœœæ¡ƒæ©™', color: '#FF8A65' },
            { id: 'rose', label: 'ç«ç‘°ç²‰', color: '#F06292' },
            { id: 'lavender', label: 'è–°è¡£è‰', color: '#9B90FF' },
            { id: 'teal', label: 'é’ç»¿', color: '#00C2A8' },
            { id: 'amber', label: 'ç¥ç€', color: '#FFC857' },
            { id: 'slate', label: 'çŸ³æ¿ç°', color: '#708090' },
            { id: 'sky', label: 'å¤©ç©ºè“', color: '#87CEEB' },
            { id: 'apple-blue', label: 'Appleè“', color: '#007AFF' },
            { id: 'google-blue', label: 'Googleè“', color: '#4285F4' },
            { id: 'whatsapp-green', label: 'æŸ”ç»¿', color: '#25D366' },
            { id: 'twitter-blue', label: 'æ¨ç‰¹è“', color: '#1DA1F2' },
            { id: 'cool-gray', label: 'å†·ç°', color: '#B0BEC5' },
            { id: 'warm-gray', label: 'æš–ç°', color: '#BDBDBD' },
            { id: 'cream', label: 'å¥¶æ²¹ç™½', color: '#FFF4E6' }
        ];

        const GRADIENT_BG_PRESETS = [
            { id: 'blue-purple', label: 'è“ç´«', c1: '#667eea', c2: '#764ba2' },
            { id: 'teal-blue', label: 'é’è“', c1: '#00C2A8', c2: '#4A90E2' },
            { id: 'peach-pink', label: 'èœœæ¡ƒç²‰', c1: '#FF9A8B', c2: '#FF6A88' },
            { id: 'mint-lavender', label: 'è–„è·ç´«', c1: '#A8E6CF', c2: '#D3BDF0' },
            { id: 'sunset', label: 'æŸ”å’Œå¤•é˜³', c1: '#FDB99B', c2: '#CF8BF3' },
            { id: 'sky', label: 'æ¸…æ–°å¤©ç©º', c1: '#A1C4FD', c2: '#C2E9FB' },
            { id: 'ocean', label: 'æµ·æ´‹', c1: '#2E8BC0', c2: '#B1D4E0' },
            { id: 'pastel-rainbow', label: 'ç²‰å½©å½©è™¹', c1: '#FAD0C4', c2: '#FFD1FF' },
            { id: 'morning-sky', label: 'æ¸…æ™¨å¤©ç©º', c1: '#FDEB71', c2: '#F8D800' },
            { id: 'fresh-meadow', label: 'æ¸…æ–°è‰åœ°', c1: '#A8E6CF', c2: '#81FBB8' },
            { id: 'violet-dusk', label: 'æš®ç´«', c1: '#B993D6', c2: '#8CA6DB' },
            { id: 'peach-sunrise', label: 'æ¡ƒè‰²æœéœ', c1: '#FFDEE9', c2: '#B5FFFC' }
        ];

        let currentBgPresetType = 'solid';
        let currentBgPresetId = null;

        function setBgTypeSolid() {
            const solidRadio = document.querySelector('input[name="bgType"][value="solid"]');
            const gradientRadio = document.querySelector('input[name="bgType"][value="gradient"]');
            if (solidRadio) {
                solidRadio.checked = true;
                solidRadio.dispatchEvent(new Event('change'));
            }
            if (gradientRadio) gradientRadio.checked = false;
            currentBgPresetType = 'solid';
        }

        function setBgTypeGradient() {
            const solidRadio = document.querySelector('input[name="bgType"][value="solid"]');
            const gradientRadio = document.querySelector('input[name="bgType"][value="gradient"]');
            if (gradientRadio) {
                gradientRadio.checked = true;
                gradientRadio.dispatchEvent(new Event('change'));
            }
            if (solidRadio) solidRadio.checked = false;
            currentBgPresetType = 'gradient';
        }

        function renderSolidBgCard(preset) {
            const container = document.getElementById('solidBgPresetContainer');
            const card = document.createElement('div');
            card.className = 'preset-card';
            card.setAttribute('data-solid-id', preset.id);
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            canvas.className = 'preset-canvas';
            const label = document.createElement('div');
            label.className = 'preset-label';
            label.textContent = preset.label;
            card.appendChild(canvas);
            card.appendChild(label);
            container.appendChild(card);
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = preset.color;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            card.addEventListener('click', () => {
                setBgTypeSolid();
                document.getElementById('solidColor').value = preset.color;
                currentBgPresetId = preset.id;
                highlightBgPresetSelection();
            });
        }

        function renderGradientBgCard(preset) {
            const container = document.getElementById('gradientBgPresetContainer');
            const card = document.createElement('div');
            card.className = 'preset-card';
            card.setAttribute('data-gradient-id', preset.id);
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            canvas.className = 'preset-canvas';
            const label = document.createElement('div');
            label.className = 'preset-label';
            label.textContent = preset.label;
            card.appendChild(canvas);
            card.appendChild(label);
            container.appendChild(card);
            const ctx = canvas.getContext('2d');
            const g = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            g.addColorStop(0, preset.c1);
            g.addColorStop(1, preset.c2);
            ctx.fillStyle = g;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            card.addEventListener('click', () => {
                setBgTypeGradient();
                document.getElementById('gradientColor1').value = preset.c1;
                document.getElementById('gradientColor2').value = preset.c2;
                currentBgPresetId = preset.id;
                highlightBgPresetSelection();
            });
        }

        function highlightBgPresetSelection() {
            const solidCards = document.querySelectorAll('.preset-card[data-solid-id]');
            const gradientCards = document.querySelectorAll('.preset-card[data-gradient-id]');
            solidCards.forEach(c => {
                const id = c.getAttribute('data-solid-id');
                if (currentBgPresetType === 'solid' && id === currentBgPresetId) c.classList.add('selected');
                else c.classList.remove('selected');
            });
            gradientCards.forEach(c => {
                const id = c.getAttribute('data-gradient-id');
                if (currentBgPresetType === 'gradient' && id === currentBgPresetId) c.classList.add('selected');
                else c.classList.remove('selected');
            });
        }

        function renderAllBgPresets() {
            const solidContainer = document.getElementById('solidBgPresetContainer');
            const gradientContainer = document.getElementById('gradientBgPresetContainer');
            solidContainer.innerHTML = '';
            gradientContainer.innerHTML = '';
            SOLID_BG_PRESETS.forEach(p => renderSolidBgCard(p));
            GRADIENT_BG_PRESETS.forEach(p => renderGradientBgCard(p));
            highlightBgPresetSelection();
        }

        renderAllBgPresets();
        function getStyleConfig() {
            return getPresetStyleConfig(currentPreset);
        }

        // ç»˜åˆ¶æ–‡å­—ï¼ˆå¸¦å¸ƒå±€ä¼˜åŒ–ï¼‰
        function drawTextWithLayout(ctx, text, canvasSize, styleConfig) {
            const padding = styleConfig.canvasPadding;
            const availableWidth = canvasSize - padding * 2;
            const availableHeight = canvasSize - padding * 2;

            const chars = text.split('');
            const charCount = chars.length;

            // æ ¹æ®å­—ç¬¦æ•°é‡ç¡®å®šå¸ƒå±€
            let layout;
            if (charCount === 1) {
                // 1ä¸ªå­—ç¬¦ï¼šå±…ä¸­å•è¡Œ
                layout = { rows: [[chars[0]]] };
            } else if (charCount === 2) {
                // 2ä¸ªå­—ç¬¦ï¼šå±…ä¸­å•è¡Œ
                layout = { rows: [[chars[0], chars[1]]] };
            } else if (charCount === 3) {
                // 3ä¸ªå­—ç¬¦ï¼šç¬¬ä¸€è¡Œ1ä¸ªï¼Œç¬¬äºŒè¡Œ2ä¸ª
                layout = { rows: [[chars[0]], [chars[1], chars[2]]] };
            } else if (charCount === 4) {
                // 4ä¸ªå­—ç¬¦ï¼šä¸¤è¡Œï¼Œæ¯è¡Œ2ä¸ª
                layout = { rows: [[chars[0], chars[1]], [chars[2], chars[3]]] };
            }

            // è®¡ç®—æ¯è¡Œçš„å­—ç¬¦æ•°
            const maxCharsPerRow = Math.max(...layout.rows.map(row => row.length));
            const rowCount = layout.rows.length;

            // è®¡ç®—åˆé€‚çš„å­—ä½“å¤§å°
            let fontSize = calculateOptimalFontSize(ctx, chars, availableWidth, availableHeight, maxCharsPerRow, rowCount, styleConfig);

            // è®¾ç½®å­—ä½“æ ·å¼ï¼ˆä½¿ç”¨æ›´ä¼˜é›…çš„å­—ä½“ï¼‰
            ctx.font = `${styleConfig.fontWeight} ${fontSize}px ${styleConfig.fontFamily}`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // è®¡ç®—è¡Œé—´è·
            const lineHeight = fontSize * styleConfig.lineHeightRatio;
            const totalTextHeight = (rowCount - 1) * lineHeight + fontSize;
            const startY = (canvasSize - totalTextHeight) / 2 + fontSize / 2;

            // ç»˜åˆ¶æ¯ä¸€è¡Œ
            layout.rows.forEach((row, rowIndex) => {
                const charsInRow = row.length;
                const rowY = startY + rowIndex * lineHeight;

                if (charsInRow === 1) {
                    // å•å­—ç¬¦å±…ä¸­
                    drawCharWithStyle(ctx, row[0], canvasSize / 2, rowY, fontSize, styleConfig);
                } else {
                    // å¤šå­—ç¬¦ï¼šè®¡ç®—å­—ç¬¦é—´è·
                    const charSpacing = calculateCharSpacing(ctx, row, availableWidth, fontSize, styleConfig);
                    const rowWidth = row.reduce((sum, char) => {
                        const metrics = ctx.measureText(char);
                        return sum + metrics.width;
                    }, 0) + charSpacing * (charsInRow - 1);
                    const startX = (canvasSize - rowWidth) / 2;

                    let currentX = startX;
                    row.forEach((char, charIndex) => {
                        const metrics = ctx.measureText(char);
                        const charX = currentX + metrics.width / 2;
                        drawCharWithStyle(ctx, char, charX, rowY, fontSize, styleConfig);
                        currentX += metrics.width + charSpacing;
                    });
                }
            });
        }

        // è®¡ç®—æœ€ä¼˜å­—ä½“å¤§å°
        function calculateOptimalFontSize(ctx, chars, availableWidth, availableHeight, maxCharsPerRow, rowCount, styleConfig) {
            const padding = 20;
            const lineHeightRatio = styleConfig.lineHeightRatio;

            let fontSize = 200; // åˆå§‹å­—ä½“å¤§å°
            let minFontSize = 30;
            let maxFontSize = 600;

            // äºŒåˆ†æŸ¥æ‰¾æœ€ä¼˜å­—ä½“å¤§å°
            while (maxFontSize - minFontSize > 1) {
                fontSize = Math.floor((minFontSize + maxFontSize) / 2);
                ctx.font = `${styleConfig.fontWeight} ${fontSize}px ${styleConfig.fontFamily}`;

                // æ£€æŸ¥å•å­—ç¬¦å®½åº¦
                const maxCharWidth = Math.max(...chars.map(char => ctx.measureText(char).width));
                const charSpacing = fontSize * styleConfig.charSpacingRatio;

                // è®¡ç®—è¡Œå®½ï¼ˆè€ƒè™‘å­—ç¬¦é—´è·ï¼‰
                const rowWidth = maxCharsPerRow * maxCharWidth + (maxCharsPerRow - 1) * charSpacing;
                const rowHeight = fontSize * lineHeightRatio;
                const totalHeight = (rowCount - 1) * rowHeight + fontSize;

                // æ£€æŸ¥æ˜¯å¦é€‚åˆ
                if (rowWidth <= availableWidth && totalHeight <= availableHeight) {
                    minFontSize = fontSize;
                } else {
                    maxFontSize = fontSize;
                }
            }

            return Math.floor(minFontSize);
        }

        // è®¡ç®—å­—ç¬¦é—´è·
        function calculateCharSpacing(ctx, chars, availableWidth, fontSize, styleConfig) {
            const totalCharWidth = chars.reduce((sum, char) => {
                return sum + ctx.measureText(char).width;
            }, 0);

            const remainingSpace = availableWidth - totalCharWidth;
            const spacing = remainingSpace / (chars.length - 1);

            // å­—ç¬¦é—´è·åœ¨å­—ä½“å¤§å°çš„10%-25%ä¹‹é—´
            const minSpacing = fontSize * 0.1;
            const maxSpacing = fontSize * 0.25;

            const preferred = fontSize * styleConfig.charSpacingRatio;
            return Math.max(minSpacing, Math.min(maxSpacing, Math.min(spacing, preferred)));
        }

        // ç»˜åˆ¶å•ä¸ªå­—ç¬¦ï¼ˆå¸¦æ ·å¼æ•ˆæœï¼‰
        function drawCharWithStyle(ctx, char, x, y, fontSize, styleConfig) {
            ctx.save();
            const rad = (styleConfig.textGradientAngle % 360) * Math.PI / 180;
            const gx = Math.cos(rad) * fontSize;
            const gy = Math.sin(rad) * fontSize;
            const grad = ctx.createLinearGradient(x - gx, y - gy, x + gx, y + gy);
            grad.addColorStop(0, styleConfig.textGradient1);
            grad.addColorStop(1, styleConfig.textGradient2);
            ctx.fillStyle = grad;
            if (styleConfig.shadowEnabled) {
                ctx.shadowColor = hexToRgba(styleConfig.shadowColor, styleConfig.shadowOpacity);
                ctx.shadowBlur = fontSize * (styleConfig.shadowBlur / 100);
                ctx.shadowOffsetX = fontSize * (styleConfig.shadowOffsetX / 100);
                ctx.shadowOffsetY = fontSize * (styleConfig.shadowOffsetY / 100);
                ctx.fillText(char, x, y);
            } else {
                ctx.fillText(char, x, y);
            }
            if (styleConfig.highlightEnabled) {
                ctx.shadowColor = hexToRgba(styleConfig.highlightColor, styleConfig.highlightOpacity);
                ctx.shadowBlur = fontSize * (styleConfig.highlightBlur / 100);
                ctx.shadowOffsetX = fontSize * (styleConfig.highlightOffsetX / 100);
                ctx.shadowOffsetY = fontSize * (styleConfig.highlightOffsetY / 100);
                ctx.fillText(char, x, y);
            }
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            if (styleConfig.strokeEnabled && styleConfig.strokeWidth > 0) {
                ctx.lineWidth = Math.max(0, styleConfig.strokeWidth);
                ctx.strokeStyle = styleConfig.strokeColor;
                ctx.strokeText(char, x, y);
            }
            ctx.restore();
        }

        function hexToRgba(hex, opacity) {
            let c = hex.replace('#', '');
            if (c.length === 3) {
                c = c.split('').map(s => s + s).join('');
            }
            const r = parseInt(c.substring(0, 2), 16);
            const g = parseInt(c.substring(2, 4), 16);
            const b = parseInt(c.substring(4, 6), 16);
            const a = Math.max(0, Math.min(1, opacity));
            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }

        function getPresetStyleConfig(preset) {
            const base = () => ({
                textGradient1: '#ffffff',
                textGradient2: '#999999',
                textGradientAngle: 45,
                strokeColor: '#000000',
                strokeWidth: 4,
                strokeEnabled: true,
                shadowColor: '#000000',
                shadowOpacity: 0.45,
                shadowBlur: 12,
                shadowOffsetX: 5,
                shadowOffsetY: 6,
                shadowEnabled: true,
                highlightColor: '#ffffff',
                highlightOpacity: 0.8,
                highlightBlur: 8,
                highlightOffsetX: -4,
                highlightOffsetY: -4,
                highlightEnabled: true,
                fontFamily: '"PingFang SC", "Microsoft YaHei", "SimHei", "Helvetica Neue", Arial, sans-serif',
                fontWeight: 'bold',
                lineHeightRatio: 1.3,
                charSpacingRatio: 0.15,
                canvasPadding: 50
            });
            const cfg = base();
            switch (preset) {
                case 'neon':
                    cfg.textGradient1 = '#00ffff';
                    cfg.textGradient2 = '#ff00ff';
                    cfg.textGradientAngle = 0;
                    cfg.strokeColor = '#ffffff';
                    cfg.strokeWidth = 2;
                    cfg.shadowOpacity = 0.6;
                    cfg.shadowBlur = 20;
                    cfg.shadowOffsetX = 3;
                    cfg.shadowOffsetY = 4;
                    cfg.highlightOpacity = 0.9;
                    cfg.highlightBlur = 16;
                    cfg.highlightOffsetX = -3;
                    cfg.highlightOffsetY = -3;
                    cfg.fontWeight = '900';
                    break;
                case 'metal':
                    cfg.textGradient1 = '#f0f0f0';
                    cfg.textGradient2 = '#7f7f7f';
                    cfg.textGradientAngle = 45;
                    cfg.strokeColor = '#333333';
                    cfg.strokeWidth = 4;
                    cfg.shadowOpacity = 0.35;
                    cfg.shadowBlur = 14;
                    cfg.highlightOpacity = 0.6;
                    cfg.highlightBlur = 10;
                    cfg.fontWeight = 'bold';
                    break;
                case 'glass':
                    cfg.textGradient1 = '#ffffff';
                    cfg.textGradient2 = '#e0f7ff';
                    cfg.textGradientAngle = 90;
                    cfg.strokeEnabled = false;
                    cfg.strokeWidth = 0;
                    cfg.shadowOpacity = 0.25;
                    cfg.shadowBlur = 20;
                    cfg.shadowOffsetX = 0;
                    cfg.shadowOffsetY = 0;
                    cfg.highlightOpacity = 0.9;
                    cfg.highlightBlur = 18;
                    cfg.fontWeight = 'bold';
                    break;
                case 'bold-stroke':
                    cfg.textGradient1 = '#ffffff';
                    cfg.textGradient2 = '#eeeeee';
                    cfg.strokeColor = '#000000';
                    cfg.strokeWidth = 8;
                    cfg.highlightEnabled = false;
                    cfg.shadowOpacity = 0.3;
                    cfg.shadowBlur = 10;
                    cfg.fontWeight = 'bold';
                    break;
                case 'retro':
                    cfg.textGradient1 = '#d4a373';
                    cfg.textGradient2 = '#8a5a3b';
                    cfg.textGradientAngle = 45;
                    cfg.strokeColor = '#5a3a2a';
                    cfg.strokeWidth = 3;
                    cfg.shadowOpacity = 0.3;
                    cfg.shadowBlur = 10;
                    cfg.highlightEnabled = false;
                    cfg.fontWeight = 'normal';
                    cfg.charSpacingRatio = 0.12;
                    break;
                case 'vivid':
                    cfg.textGradient1 = '#ff0000';
                    cfg.textGradient2 = '#00eaff';
                    cfg.textGradientAngle = 90;
                    cfg.strokeEnabled = false;
                    cfg.strokeWidth = 0;
                    cfg.shadowOpacity = 0.35;
                    cfg.shadowBlur = 12;
                    cfg.highlightEnabled = false;
                    cfg.fontWeight = '900';
                    break;
                case 'glow':
                    cfg.textGradient1 = '#ffffcc';
                    cfg.textGradient2 = '#ffd966';
                    cfg.textGradientAngle = 45;
                    cfg.strokeEnabled = false;
                    cfg.strokeWidth = 0;
                    cfg.shadowEnabled = false;
                    cfg.highlightColor = '#ffffcc';
                    cfg.highlightOpacity = 1.0;
                    cfg.highlightBlur = 24;
                    cfg.highlightOffsetX = -4;
                    cfg.highlightOffsetY = -4;
                    cfg.fontWeight = '900';
                    break;
                case 'plastic':
                    cfg.textGradient1 = '#ffd1d1';
                    cfg.textGradient2 = '#ff7f7f';
                    cfg.textGradientAngle = 45;
                    cfg.strokeColor = '#b33a3a';
                    cfg.strokeWidth = 4;
                    cfg.shadowOpacity = 0.5;
                    cfg.shadowBlur = 16;
                    cfg.shadowOffsetX = 6;
                    cfg.shadowOffsetY = 8;
                    cfg.highlightOpacity = 0.7;
                    cfg.highlightBlur = 10;
                    cfg.highlightOffsetX = -3;
                    cfg.highlightOffsetY = -3;
                    cfg.fontWeight = 'bold';
                    break;
                default:
                    break;
            }
            return cfg;
        }
    </script>
</body>

</html>